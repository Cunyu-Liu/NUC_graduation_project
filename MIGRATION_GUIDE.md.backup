# v3.0 â†’ v4.0 è¿ç§»æŒ‡å—

## ğŸ“‹ è¿ç§»æ£€æŸ¥æ¸…å•

### é˜¶æ®µ1: å¤‡ä»½ç°æœ‰æ•°æ® âœ…

```bash
# 1. å¤‡ä»½å½“å‰ç›®å½•
cp -r . ../nuc_Graduation_project_v3_backup

# 2. å¤‡ä»½è¾“å‡ºç›®å½•ï¼ˆå¦‚æœæœ‰é‡è¦åˆ†æç»“æœï¼‰
cp -r output/ ../output_backup

# 3. å¤‡ä»½æ•°æ®åº“ï¼ˆå¦‚æœä½¿ç”¨PostgreSQLï¼‰
pg_dump literature_analysis > backup_$(date +%Y%m%d).sql
```

### é˜¶æ®µ2: æ›´æ–°ä¾èµ– âœ…

```bash
# å®‰è£…v4.0æ–°å¢ä¾èµ–
pip install sqlalchemy psycopg2-binary asyncio aiofiles

# éªŒè¯å®‰è£…
python -c "import sqlalchemy; print('SQLAlchemy OK')"
python -c "import asyncio; print('asyncio OK')"
```

### é˜¶æ®µ3: æ•°æ®åº“è¿ç§» âœ…

```bash
# 1. åˆ›å»ºPostgreSQLæ•°æ®åº“
createdb literature_analysis

# 2. åˆå§‹åŒ–v4.0è¡¨ç»“æ„
python main.py init-db

# 3. éªŒè¯è¡¨åˆ›å»º
python main.py stats
# åº”è¯¥çœ‹åˆ°æ‰€æœ‰è¡¨çš„ç»Ÿè®¡ä¿¡æ¯
```

### é˜¶æ®µ4: é…ç½®æ›´æ–° âœ…

```bash
# 1. å¤åˆ¶é…ç½®æ¨¡æ¿
cp .env.example .env

# 2. æ›´æ–°.envæ–‡ä»¶
nano .env

# æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š
# DATABASE_URL=postgresql://user:password@localhost:5432/literature_analysis
# GLM_API_KEY=your_api_key
# LLM_MODEL=glm-4-plus
# MAX_CONCURRENT=5
```

### é˜¶æ®µ5: æ‰§è¡Œæ¸…ç† âœ…

```bash
# è¿è¡Œæ¸…ç†è„šæœ¬ï¼ˆä¼šè‡ªåŠ¨å¤‡ä»½v3.0æ–‡ä»¶ï¼‰
python cleanup_v3.py

# è¾“å‡ºç¤ºä¾‹ï¼š
# âœ“ å·²å¤‡ä»½: src/pdf_parser.py â†’ .old_v3/pdf_parser.py
# âœ“ å·²å¤‡ä»½: src/prompts.py â†’ .old_v3/prompts.py
# ...
# âœ“ é‡å‘½å: app_v4.py â†’ app.py
# âœ“ é‡å‘½å: main_v4.py â†’ main.py
```

### é˜¶æ®µ6: æµ‹è¯•éªŒè¯ âœ…

```bash
# 1. å¥åº·æ£€æŸ¥
curl http://localhost:5000/api/health

# 2. æµ‹è¯•å•ç¯‡åˆ†æ
python main.py analyze papers/test.pdf

# 3. æŸ¥çœ‹ç»Ÿè®¡
python main.py stats

# 4. æµ‹è¯•Webç•Œé¢
python app.py
# è®¿é—® http://localhost:5000/api/health
```

---

## ğŸ”„ APIå˜æ›´å¯¹ç…§è¡¨

### è®ºæ–‡ç®¡ç†

| v3.0 API | v4.0 API | å˜æ›´è¯´æ˜ |
|----------|----------|---------|
| `GET /api/files` | `GET /api/papers` | æ›´RESTful |
| `POST /api/upload` | `POST /api/upload` | **ä¸å˜** |
| âŒ | `GET /api/papers/<id>` | **æ–°å¢**ï¼šè·å–è¯¦æƒ… |
| âŒ | `PUT /api/papers/<id>` | **æ–°å¢**ï¼šæ›´æ–°è®ºæ–‡ |
| `DELETE /api/files/<name>` | `DELETE /api/papers/<id>` | ä½¿ç”¨IDè€Œéæ–‡ä»¶å |
| âŒ | `POST /api/papers/batch-delete` | **æ–°å¢**ï¼šæ‰¹é‡åˆ é™¤ |

### åˆ†æåŠŸèƒ½

| v3.0 API | v4.0 API | å˜æ›´è¯´æ˜ |
|----------|----------|---------|
| `POST /api/analyze` | `POST /api/analyze` | **ä¿æŒå…¼å®¹** |
| âŒ | `POST /api/batch-analyze` | **æ–°å¢**ï¼šæ‰¹é‡åˆ†æ |
| âŒ | æ”¯æŒ `paper_id` å‚æ•° | **æ–°å¢**ï¼šä½¿ç”¨æ•°æ®åº“ID |

### ä»£ç ç”Ÿæˆï¼ˆå…¨æ–°ï¼‰

| API | æ–¹æ³• | è¯´æ˜ |
|-----|------|------|
| `/api/gaps/<id>/generate-code` | POST | **æ–°å¢**ï¼šç”Ÿæˆä»£ç  |
| `/api/code/<id>` | GET | **æ–°å¢**ï¼šè·å–ä»£ç  |
| `/api/code/<id>/modify` | POST | **æ–°å¢**ï¼šä¿®æ”¹ä»£ç  |

### çŸ¥è¯†å›¾è°±ï¼ˆå…¨æ–°ï¼‰

| API | æ–¹æ³• | è¯´æ˜ |
|-----|------|------|
| `/api/knowledge-graph` | GET | **æ–°å¢**ï¼šè·å–å›¾è°±æ•°æ® |

---

## ğŸ“Š æ•°æ®æ¨¡å‹å˜æ›´

### v3.0 â†’ v4.0

#### è®ºæ–‡æ•°æ®

**v3.0** (JSONæ–‡ä»¶):
```json
{
  "filename": "paper.pdf",
  "title": "...",
  "summary": "...",
  "keypoints": {...}
}
```

**v4.0** (æ•°æ®åº“):
```python
# Paperè¡¨
{
  "id": 1,  # æ–°å¢ï¼šæ•°æ®åº“ID
  "title": "...",
  "abstract": "...",
  "pdf_hash": "abc123",  # æ–°å¢ï¼šæ–‡ä»¶å“ˆå¸Œ
  "year": 2024,
  "venue": "NeurIPS",
  "metadata": {...}  # æ–°å¢ï¼šçµæ´»å­˜å‚¨
}

# Analysisè¡¨ï¼ˆç‹¬ç«‹ï¼‰
{
  "id": 1,
  "paper_id": 1,
  "summary_text": "...",
  "keypoints": {...},
  "status": "completed"  # æ–°å¢ï¼šçŠ¶æ€
}
```

#### æ–°å¢æ•°æ®è¡¨

**v4.0æ–°å¢**ï¼š
- âœ… `authors` - ä½œè€…è¡¨ï¼ˆå»é‡ï¼‰
- âœ… `keywords` - å…³é”®è¯è¡¨ï¼ˆå»é‡ï¼‰
- âœ… `research_gaps` - ç ”ç©¶ç©ºç™½è¡¨
- âœ… `generated_code` - ç”Ÿæˆä»£ç è¡¨
- âœ… `relations` - çŸ¥è¯†å›¾è°±å…³ç³»è¡¨
- âœ… `experiments` - å®éªŒè®°å½•è¡¨
- âœ… `tasks` - å¼‚æ­¥ä»»åŠ¡è¡¨

---

## ğŸš¨ å¸¸è§è¿ç§»é—®é¢˜

### Q1: æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯**: `could not connect to server`

**è§£å†³**:
```bash
# æ£€æŸ¥PostgreSQLçŠ¶æ€
brew services list | grep postgresql  # macOS
sudo systemctl status postgresql      # Ubuntu

# å¯åŠ¨PostgreSQL
brew services start postgresql         # macOS
sudo systemctl start postgresql        # Ubuntu

# éªŒè¯è¿æ¥
psql -d literature_analysis
```

### Q2: APIå¯†é’¥é”™è¯¯

**é”™è¯¯**: `è¯·è®¾ç½®GLM_API_KEYç¯å¢ƒå˜é‡`

**è§£å†³**:
```bash
# æ£€æŸ¥.envæ–‡ä»¶
cat .env | grep GLM_API_KEY

# æµ‹è¯•APIå¯†é’¥
curl -X POST https://open.bigmodel.cn/api/paas/v4/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY"
```

### Q3: å‰ç«¯è¿æ¥å¤±è´¥

**é”™è¯¯**: `WebSocket connection failed`

**è§£å†³**:
```javascript
// æ£€æŸ¥å‰ç«¯é…ç½® (frontend/src/api/index.js)
const socket = io('http://localhost:5000', {
  transports: ['websocket', 'polling']
});

// ç¡®ä¿åç«¯CORSé…ç½®æ­£ç¡®
// app.py: CORS(app, resources={r"/api/*": {"origins": "*"}})
```

### Q4: åˆ†æé€Ÿåº¦æ…¢

**åŸå› **: ä½¿ç”¨äº†åŒæ­¥é˜»å¡æ–¹å¼

**è§£å†³**:
```python
# ä½¿ç”¨å¼‚æ­¥å·¥ä½œæµ
# v4.0å·²å…¨é¢å¼‚æ­¥åŒ–
result = await workflow.execute_paper_workflow(...)

# è°ƒæ•´å¹¶å‘æ•°
# .env: MAX_CONCURRENT=10
```

---

## ğŸ“š ä»£ç è¿ç§»ç¤ºä¾‹

### ç¤ºä¾‹1: ä¸Šä¼ å’Œåˆ†æè®ºæ–‡

**v3.0ä»£ç **:
```python
# åŒæ­¥æ–¹å¼
parser = PDFParser()
paper = parser.parse_pdf('paper.pdf')

summary_gen = SummaryGenerator()
summary = summary_gen.generate_summary(paper)
```

**v4.0ä»£ç **:
```python
# å¼‚æ­¥æ–¹å¼ + æ•°æ®åº“
import asyncio
from src.async_workflow import AsyncWorkflowEngine
from src.db_manager import DatabaseManager

async def analyze():
    db = DatabaseManager()
    workflow = AsyncWorkflowEngine(db_manager=db)

    result = await workflow.execute_paper_workflow(
        pdf_path='paper.pdf',
        tasks=['summary', 'keypoints', 'gaps', 'code'],
        auto_generate_code=True
    )

    print(f"è®ºæ–‡ID: {result['paper_id']}")
    print(f"åˆ†æID: {result['analysis_id']}")

asyncio.run(analyze())
```

### ç¤ºä¾‹2: æ‰¹é‡å¤„ç†

**v3.0ä»£ç **:
```python
# é¡ºåºå¤„ç†
for pdf in pdf_files:
    result = analyze(pdf)  # é˜»å¡
    save(result)
```

**v4.0ä»£ç **:
```python
# å¹¶å‘å¤„ç†
async def batch():
    workflow = AsyncWorkflowEngine()
    summary = await workflow.batch_process_papers(
        pdf_paths=pdf_files,
        tasks=['summary', 'keypoints']
    )
    print(f"æˆåŠŸ: {summary['success']}/{summary['total']}")

asyncio.run(batch())
```

---

## âœ… è¿ç§»éªŒè¯æ¸…å•

å®Œæˆè¿ç§»åï¼Œè¯·éªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š

- [ ] **æ•°æ®åº“è¿æ¥**
  - [ ] åˆ›å»ºè¡¨æˆåŠŸ
  - [ ] å¯ä»¥æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯
  - [ ] å¯ä»¥æ’å…¥æ•°æ®

- [ ] **æ–‡ä»¶ä¸Šä¼ **
  - [ ] PDFä¸Šä¼ æˆåŠŸ
  - [ ] è‡ªåŠ¨è§£æå®Œæˆ
  - [ ] æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“

- [ ] **è®ºæ–‡åˆ†æ**
  - [ ] å•ç¯‡åˆ†ææˆåŠŸ
  - [ ] æ‰¹é‡åˆ†ææˆåŠŸ
  - [ ] å¼‚æ­¥æ‰§è¡Œæ­£å¸¸

- [ ] **ä»£ç ç”Ÿæˆ**
  - [ ] ä»£ç ç”ŸæˆæˆåŠŸ
  - [ ] ç”¨æˆ·ä¿®æ”¹åŠŸèƒ½æ­£å¸¸
  - [ ] ç‰ˆæœ¬ç®¡ç†æ­£å¸¸

- [ ] **å‰ç«¯ç•Œé¢**
  - [ ] æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
  - [ ] åˆ†æè¿›åº¦æ˜¾ç¤º
  - [ ] ç»“æœå±•ç¤ºæ­£å¸¸

- [ ] **çŸ¥è¯†å›¾è°±**
  - [ ] å›¾è°±æ•°æ®è·å–
  - [ ] å…³ç³»å»ºç«‹æ­£ç¡®

---

## ğŸ¯ ä¸‹ä¸€æ­¥

è¿ç§»å®Œæˆåï¼Œä½ å¯ä»¥ï¼š

1. **æ¢ç´¢æ–°åŠŸèƒ½**:
   ```bash
   python main.py stats
   python main.py graph
   ```

2. **é˜…è¯»æ–‡æ¡£**:
   - [æ¶æ„è®¾è®¡](docs/ARCHITECTURE_V4.md)
   - [ä½¿ç”¨ç¤ºä¾‹](examples/V4_EXAMPLES.md)

3. **ä¼˜åŒ–é…ç½®**:
   - è°ƒæ•´å¹¶å‘æ•°
   - é€‰æ‹©åˆé€‚çš„æ¨¡å‹
   - ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

---

## ğŸ†˜ éœ€è¦å¸®åŠ©ï¼Ÿ

è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹æ—¥å¿—ï¼š`logs/` ç›®å½•
2. æ£€æŸ¥é…ç½®ï¼š`.env` æ–‡ä»¶
3. è¿è¡Œè¯Šæ–­ï¼š`python check_system.py`
4. æäº¤Issueï¼š[GitHub Issues](https://github.com/your-repo/issues)

---

**ç¥è¿ç§»é¡ºåˆ©ï¼** ğŸš€

ç‰ˆæœ¬: v4.0
æ›´æ–°æ—¥æœŸ: 2025å¹´
