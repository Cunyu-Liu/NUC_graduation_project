{"ast":null,"code":"import { resolveComponent as _resolveComponent, createVNode as _createVNode, withCtx as _withCtx, createElementVNode as _createElementVNode, createTextVNode as _createTextVNode, toDisplayString as _toDisplayString, openBlock as _openBlock, createBlock as _createBlock } from \"vue\";\nconst _hoisted_1 = {\n  class: \"dialog-footer\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_Upload_filled = _resolveComponent(\"Upload-filled\");\n  const _component_el_icon = _resolveComponent(\"el-icon\");\n  const _component_el_upload = _resolveComponent(\"el-upload\");\n  const _component_el_button = _resolveComponent(\"el-button\");\n  const _component_el_dialog = _resolveComponent(\"el-dialog\");\n  return _openBlock(), _createBlock(_component_el_dialog, {\n    modelValue: $setup.visible,\n    \"onUpdate:modelValue\": _cache[1] || (_cache[1] = $event => $setup.visible = $event),\n    title: \"上传PDF论文\",\n    width: \"550px\",\n    \"close-on-click-modal\": false\n  }, {\n    footer: _withCtx(() => [_createElementVNode(\"div\", _hoisted_1, [_createVNode(_component_el_button, {\n      onClick: _cache[0] || (_cache[0] = $event => $setup.visible = false)\n    }, {\n      default: _withCtx(() => [...(_cache[4] || (_cache[4] = [_createTextVNode(\"关闭\", -1 /* CACHED */)]))]),\n      _: 1 /* STABLE */\n    }), _createVNode(_component_el_button, {\n      type: \"primary\",\n      onClick: $setup.submitUpload,\n      loading: $setup.uploading,\n      disabled: $setup.fileList.length === 0\n    }, {\n      default: _withCtx(() => [_createTextVNode(\" 开始上传 (\" + _toDisplayString($setup.fileList.length) + \"个文件) \", 1 /* TEXT */)]),\n      _: 1 /* STABLE */\n    }, 8 /* PROPS */, [\"onClick\", \"loading\", \"disabled\"])])]),\n    default: _withCtx(() => [_createVNode(_component_el_upload, {\n      ref: \"uploadRef\",\n      class: \"upload-demo\",\n      drag: \"\",\n      action: \"/api/upload/batch\",\n      \"on-success\": $setup.handleSuccess,\n      \"on-error\": $setup.handleError,\n      \"before-upload\": $setup.beforeUpload,\n      \"http-request\": $setup.customUpload,\n      \"file-list\": $setup.fileList,\n      accept: \".pdf\",\n      limit: 10,\n      multiple: \"\",\n      \"auto-upload\": false\n    }, {\n      tip: _withCtx(() => [...(_cache[2] || (_cache[2] = [_createElementVNode(\"div\", {\n        class: \"el-upload__tip\"\n      }, \" 只支持PDF格式，单个文件不超过50MB，最多同时上传10个文件 \", -1 /* CACHED */)]))]),\n      default: _withCtx(() => [_createVNode(_component_el_icon, {\n        size: 67,\n        color: \"#409eff\"\n      }, {\n        default: _withCtx(() => [_createVNode(_component_Upload_filled)]),\n        _: 1 /* STABLE */\n      }), _cache[3] || (_cache[3] = _createElementVNode(\"div\", {\n        class: \"el-upload__text\"\n      }, [_createTextVNode(\" 将PDF文件拖到此处，或\"), _createElementVNode(\"em\", null, \"点击上传\")], -1 /* CACHED */))]),\n      _: 1 /* STABLE */\n    }, 8 /* PROPS */, [\"on-success\", \"on-error\", \"before-upload\", \"http-request\", \"file-list\"])]),\n    _: 1 /* STABLE */\n  }, 8 /* PROPS */, [\"modelValue\"]);\n}","map":{"version":3,"names":["class","_createBlock","_component_el_dialog","$setup","visible","$event","title","width","footer","_withCtx","_createElementVNode","_hoisted_1","_createVNode","_component_el_button","onClick","_cache","type","submitUpload","loading","uploading","disabled","fileList","length","_toDisplayString","_component_el_upload","ref","drag","action","handleSuccess","handleError","beforeUpload","customUpload","accept","limit","multiple","tip","_component_el_icon","size","color","_component_Upload_filled"],"sources":["/Users/liucunyu/Documents/all_code/NUC_graduation_project/frontend/src/components/UploadDialog.vue"],"sourcesContent":["<template>\n  <el-dialog\n    v-model=\"visible\"\n    title=\"上传PDF论文\"\n    width=\"550px\"\n    :close-on-click-modal=\"false\"\n  >\n    <el-upload\n      ref=\"uploadRef\"\n      class=\"upload-demo\"\n      drag\n      action=\"/api/upload/batch\"\n      :on-success=\"handleSuccess\"\n      :on-error=\"handleError\"\n      :before-upload=\"beforeUpload\"\n      :http-request=\"customUpload\"\n      :file-list=\"fileList\"\n      accept=\".pdf\"\n      :limit=\"10\"\n      multiple\n      :auto-upload=\"false\"\n    >\n      <el-icon :size=\"67\" color=\"#409eff\"><Upload-filled /></el-icon>\n      <div class=\"el-upload__text\">\n        将PDF文件拖到此处，或<em>点击上传</em>\n      </div>\n      <template #tip>\n        <div class=\"el-upload__tip\">\n          只支持PDF格式，单个文件不超过50MB，最多同时上传10个文件\n        </div>\n      </template>\n    </el-upload>\n\n    <template #footer>\n      <div class=\"dialog-footer\">\n        <el-button @click=\"visible = false\">关闭</el-button>\n        <el-button\n          type=\"primary\"\n          @click=\"submitUpload\"\n          :loading=\"uploading\"\n          :disabled=\"fileList.length === 0\"\n        >\n          开始上传 ({{ fileList.length }}个文件)\n        </el-button>\n      </div>\n    </template>\n  </el-dialog>\n</template>\n\n<script>\nimport { computed, ref } from 'vue'\nimport { useStore } from 'vuex'\nimport { ElMessage } from 'element-plus'\nimport { UploadFilled } from '@element-plus/icons-vue'\nimport axios from 'axios'\n\nexport default {\n  name: 'UploadDialog',\n  components: {\n    UploadFilled\n  },\n  setup(_, { emit }) {\n    const store = useStore()\n    const uploadRef = ref(null)\n    const fileList = ref([])\n    const uploading = ref(false)\n\n    const visible = computed({\n      get: () => store.state.showUploadDialog,\n      set: (val) => store.commit('SHOW_UPLOAD_DIALOG', val)\n    })\n\n    const beforeUpload = (file) => {\n      const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')\n      const isLt50M = file.size / 1024 / 1024 < 50\n\n      if (!isPDF) {\n        ElMessage.error('只能上传PDF文件!')\n        return false\n      }\n      if (!isLt50M) {\n        ElMessage.error('文件大小不能超过50MB!')\n        return false\n      }\n      return true\n    }\n\n    const customUpload = async (options) => {\n      // 这个函数不会被直接调用，因为我们使用批量上传\n      console.log('customUpload', options)\n    }\n\n    const submitUpload = async () => {\n      if (fileList.value.length === 0) {\n        ElMessage.warning('请先选择要上传的文件')\n        return\n      }\n\n      uploading.value = true\n\n      try {\n        const formData = new FormData()\n\n        // 添加所有文件到FormData\n        fileList.value.forEach((file) => {\n          formData.append('files', file.raw)\n        })\n\n        console.log(`[DEBUG] 开始批量上传 ${fileList.value.length} 个文件`)\n\n        const response = await axios.post('/api/upload/batch', formData, {\n          headers: {\n            'Content-Type': 'multipart/form-data'\n          },\n          timeout: 300000 // 5分钟超时\n        })\n\n        console.log('[DEBUG] 批量上传响应:', response.data)\n\n        if (response.data.success) {\n          const result = response.data.data\n          const successCount = result.success?.length || 0\n          const failCount = result.failed?.length || 0\n\n          if (successCount > 0) {\n            ElMessage.success({\n              message: `成功上传 ${successCount} 个文件${failCount > 0 ? `，${failCount}个失败` : ''}`,\n              duration: 5000,\n              showClose: true\n            })\n\n            // 通知父组件刷新文件列表\n            emit('uploaded', result.success)\n          }\n\n          if (failCount > 0) {\n            const failNames = result.failed.map(f => f.filename).join(', ')\n            ElMessage.error({\n              message: `以下文件上传失败: ${failNames}`,\n              duration: 8000,\n              showClose: true\n            })\n          }\n\n          // 清空文件列表\n          fileList.value = []\n          visible.value = false\n        } else {\n          ElMessage.error({\n            message: response.data.error || '上传失败',\n            duration: 5000,\n            showClose: true\n          })\n        }\n      } catch (error) {\n        console.error('[ERROR] 批量上传失败:', error)\n\n        let errorMsg = '上传失败'\n        if (error.response?.data?.error) {\n          errorMsg = error.response.data.error\n        } else if (error.message) {\n          errorMsg = error.message\n        }\n\n        ElMessage.error({\n          message: errorMsg,\n          duration: 5000,\n          showClose: true\n        })\n      } finally {\n        uploading.value = false\n      }\n    }\n\n    const handleSuccess = (response, file) => {\n      // 批量上传不使用这个方法\n      console.log('handleSuccess', response, file)\n    }\n\n    const handleError = (error) => {\n      console.error('上传错误:', error)\n\n      let errorMsg = '上传失败'\n\n      if (error.message) {\n        if (error.message.includes('403') || error.message.includes('CORS')) {\n          errorMsg = '权限错误：请检查后端CORS配置'\n        } else if (error.message.includes('Network Error')) {\n          errorMsg = '网络错误：请检查后端服务是否启动（端口5001）'\n        } else if (error.message.includes('timeout')) {\n          errorMsg = '上传超时：文件可能过大，请尝试更小的文件'\n        } else if (error.message.includes('413')) {\n          errorMsg = '文件过大：单个文件不能超过50MB'\n        } else {\n          errorMsg = `上传失败: ${error.message}`\n        }\n      }\n\n      ElMessage.error({\n        message: errorMsg,\n        duration: 5000,\n        showClose: true\n      })\n    }\n\n    return {\n      visible,\n      uploadRef,\n      fileList,\n      uploading,\n      beforeUpload,\n      customUpload,\n      submitUpload,\n      handleSuccess,\n      handleError\n    }\n  }\n}\n</script>\n\n<style scoped>\n.upload-demo {\n  text-align: center;\n}\n\n.el-icon-upload {\n  font-size: 67px;\n  color: #409eff;\n  margin: 20px 0;\n}\n\n.el-upload__text {\n  font-size: 14px;\n  color: #606266;\n}\n\n.el-upload__text em {\n  color: #409eff;\n  font-style: normal;\n}\n\n.dialog-footer {\n  display: flex;\n  justify-content: flex-end;\n  gap: 10px;\n}\n</style>\n"],"mappings":";;EAkCWA,KAAK,EAAC;AAAe;;;;;;;uBAjC9BC,YAAA,CA6CYC,oBAAA;gBA5CDC,MAAA,CAAAC,OAAO;+DAAPD,MAAA,CAAAC,OAAO,GAAAC,MAAA;IAChBC,KAAK,EAAC,SAAS;IACfC,KAAK,EAAC,OAAO;IACZ,sBAAoB,EAAE;;IA4BZC,MAAM,EAAAC,QAAA,CACf,MAUM,CAVNC,mBAAA,CAUM,OAVNC,UAUM,GATJC,YAAA,CAAkDC,oBAAA;MAAtCC,OAAK,EAAAC,MAAA,QAAAA,MAAA,MAAAV,MAAA,IAAEF,MAAA,CAAAC,OAAO;;wBAAU,MAAE,KAAAW,MAAA,QAAAA,MAAA,O,iBAAF,IAAE,mB;;QACtCH,YAAA,CAOYC,oBAAA;MANVG,IAAI,EAAC,SAAS;MACbF,OAAK,EAAEX,MAAA,CAAAc,YAAY;MACnBC,OAAO,EAAEf,MAAA,CAAAgB,SAAS;MAClBC,QAAQ,EAAEjB,MAAA,CAAAkB,QAAQ,CAACC,MAAM;;wBAC3B,MACO,C,iBADP,SACO,GAAAC,gBAAA,CAAGpB,MAAA,CAAAkB,QAAQ,CAACC,MAAM,IAAG,OAC7B,gB;;;sBApCJ,MAwBY,CAxBZV,YAAA,CAwBYY,oBAAA;MAvBVC,GAAG,EAAC,WAAW;MACfzB,KAAK,EAAC,aAAa;MACnB0B,IAAI,EAAJ,EAAI;MACJC,MAAM,EAAC,mBAAmB;MACzB,YAAU,EAAExB,MAAA,CAAAyB,aAAa;MACzB,UAAQ,EAAEzB,MAAA,CAAA0B,WAAW;MACrB,eAAa,EAAE1B,MAAA,CAAA2B,YAAY;MAC3B,cAAY,EAAE3B,MAAA,CAAA4B,YAAY;MAC1B,WAAS,EAAE5B,MAAA,CAAAkB,QAAQ;MACpBW,MAAM,EAAC,MAAM;MACZC,KAAK,EAAE,EAAE;MACVC,QAAQ,EAAR,EAAQ;MACP,aAAW,EAAE;;MAMHC,GAAG,EAAA1B,QAAA,CACZ,MAEM,KAAAM,MAAA,QAAAA,MAAA,OAFNL,mBAAA,CAEM;QAFDV,KAAK,EAAC;MAAgB,GAAC,oCAE5B,mB;wBAPF,MAA+D,CAA/DY,YAAA,CAA+DwB,kBAAA;QAArDC,IAAI,EAAE,EAAE;QAAEC,KAAK,EAAC;;0BAAU,MAAiB,CAAjB1B,YAAA,CAAiB2B,wBAAA,E;;oCACrD7B,mBAAA,CAEM;QAFDV,KAAK,EAAC;MAAiB,I,iBAAC,eACf,GAAAU,mBAAA,CAAa,YAAT,MAAI,E","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}