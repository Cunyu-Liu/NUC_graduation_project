{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.iterator.some.js\";\nimport { shallowRef, defineComponent, h, triggerRef, onMounted, isVNode } from 'vue';\nimport { flattedChildren } from '../../utils/vue/vnode.mjs';\nconst getOrderedChildren = (vm, childComponentName, children) => {\n  const nodes = flattedChildren(vm.subTree).filter(n => {\n    var _a;\n    return isVNode(n) && ((_a = n.type) == null ? void 0 : _a.name) === childComponentName && !!n.component;\n  });\n  const uids = nodes.map(n => n.component.uid);\n  return uids.map(uid => children[uid]).filter(p => !!p);\n};\nconst useOrderedChildren = (vm, childComponentName) => {\n  const children = shallowRef({});\n  const orderedChildren = shallowRef([]);\n  const nodesMap = /* @__PURE__ */new WeakMap();\n  const addChild = child => {\n    children.value[child.uid] = child;\n    triggerRef(children);\n    onMounted(() => {\n      const childNode = child.getVnode().el;\n      const parentNode = childNode.parentNode;\n      if (!nodesMap.has(parentNode)) {\n        nodesMap.set(parentNode, []);\n        const originalFn = parentNode.insertBefore.bind(parentNode);\n        parentNode.insertBefore = (node, anchor) => {\n          const shouldSortChildren = nodesMap.get(parentNode).some(el => node === el || anchor === el);\n          if (shouldSortChildren) triggerRef(children);\n          return originalFn(node, anchor);\n        };\n      }\n      nodesMap.get(parentNode).push(childNode);\n    });\n  };\n  const removeChild = child => {\n    delete children.value[child.uid];\n    triggerRef(children);\n    const childNode = child.getVnode().el;\n    const parentNode = childNode.parentNode;\n    const childNodes = nodesMap.get(parentNode);\n    const index = childNodes.indexOf(childNode);\n    childNodes.splice(index, 1);\n  };\n  const sortChildren = () => {\n    orderedChildren.value = getOrderedChildren(vm, childComponentName, children.value);\n  };\n  const IsolatedRenderer = props => {\n    return props.render();\n  };\n  const ChildrenSorter = defineComponent({\n    setup(_, {\n      slots\n    }) {\n      return () => {\n        sortChildren();\n        return slots.default ? h(IsolatedRenderer, {\n          render: slots.default\n        }) : null;\n      };\n    }\n  });\n  return {\n    children: orderedChildren,\n    addChild,\n    removeChild,\n    ChildrenSorter\n  };\n};\nexport { useOrderedChildren };","map":{"version":3,"names":["getOrderedChildren","vm","childComponentName","children","nodes","flattedChildren","subTree","filter","n","_a","isVNode","type","name","component","uids","map","uid","p","useOrderedChildren","shallowRef","orderedChildren","nodesMap","WeakMap","addChild","child","value","triggerRef","onMounted","childNode","getVnode","el","parentNode","has","set","originalFn","insertBefore","bind","node","anchor","shouldSortChildren","get","some","push","removeChild","childNodes","index","indexOf","splice","sortChildren","IsolatedRenderer","props","render","ChildrenSorter","defineComponent","setup","_","slots","default","h"],"sources":["../../../../../packages/hooks/use-ordered-children/index.ts"],"sourcesContent":["import {\n  defineComponent,\n  h,\n  isVNode,\n  onMounted,\n  shallowRef,\n  triggerRef,\n} from 'vue'\nimport { flattedChildren } from '@element-plus/utils'\n\nimport type { Component, ComponentInternalInstance, VNode } from 'vue'\n\ntype ChildEssential = {\n  uid: number\n  getVnode: () => VNode\n}\n\nconst getOrderedChildren = <T>(\n  vm: ComponentInternalInstance,\n  childComponentName: string,\n  children: Record<number, T>\n): T[] => {\n  const nodes = flattedChildren(vm.subTree).filter(\n    (n): n is VNode =>\n      isVNode(n) &&\n      (n.type as Component)?.name === childComponentName &&\n      !!n.component\n  )\n  const uids = nodes.map((n) => n.component!.uid)\n  return uids.map((uid) => children[uid]).filter((p) => !!p)\n}\n\nexport const useOrderedChildren = <T extends ChildEssential>(\n  vm: ComponentInternalInstance,\n  childComponentName: string\n) => {\n  const children = shallowRef<Record<number, T>>({})\n  const orderedChildren = shallowRef<T[]>([])\n  const nodesMap = new WeakMap<ParentNode, Node[]>()\n\n  const addChild = (child: T) => {\n    children.value[child.uid] = child\n    triggerRef(children)\n\n    onMounted(() => {\n      const childNode = child.getVnode().el! as Node\n      const parentNode = childNode.parentNode!\n\n      if (!nodesMap.has(parentNode)) {\n        nodesMap.set(parentNode, [])\n\n        const originalFn = parentNode.insertBefore.bind(parentNode)\n        parentNode.insertBefore = <T extends Node>(\n          node: T,\n          anchor: Node | null\n        ) => {\n          // Schedule a job to update `orderedChildren` if the root element of child components is moved\n          const shouldSortChildren = nodesMap\n            .get(parentNode)!\n            .some((el) => node === el || anchor === el)\n          if (shouldSortChildren) triggerRef(children)\n\n          return originalFn(node, anchor)\n        }\n      }\n\n      nodesMap.get(parentNode)!.push(childNode)\n    })\n  }\n\n  const removeChild = (child: T) => {\n    delete children.value[child.uid]\n    triggerRef(children)\n\n    const childNode = child.getVnode().el! as Node\n    const parentNode = childNode.parentNode!\n    const childNodes = nodesMap.get(parentNode)!\n    const index = childNodes.indexOf(childNode)\n    childNodes.splice(index, 1)\n  }\n\n  const sortChildren = () => {\n    orderedChildren.value = getOrderedChildren(\n      vm,\n      childComponentName,\n      children.value\n    )\n  }\n\n  const IsolatedRenderer = (props: { render: () => VNode[] }) => {\n    return props.render()\n  }\n\n  // TODO: Refactor `el-description` before converting this to a functional component\n  const ChildrenSorter = defineComponent({\n    setup(_, { slots }) {\n      return () => {\n        sortChildren()\n\n        return slots.default\n          ? // Create a new `ReactiveEffect` to ensure `ChildrenSorter` doesn't track any extra dependencies\n            // @ts-ignore TODO: Remove this after Vue is upgraded\n            h(IsolatedRenderer, {\n              render: slots.default,\n            })\n          : null\n      }\n    },\n  })\n\n  return {\n    children: orderedChildren,\n    addChild,\n    removeChild,\n    ChildrenSorter,\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}