{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.iterator.reduce.js\";\nimport \"core-js/modules/es.json.stringify.js\";\nimport \"core-js/modules/esnext.json.parse.js\";\nimport \"core-js/modules/web.url-search-params.delete.js\";\nimport \"core-js/modules/web.url-search-params.has.js\";\nimport \"core-js/modules/web.url-search-params.size.js\";\nimport { ref, computed, onMounted } from 'vue';\nimport { useStore } from 'vuex';\nimport api, { connectSocket } from '@/api';\nimport { ElMessage } from 'element-plus';\nimport { DataAnalysis, Refresh, Star, Picture as PictureIcon, Document } from '@element-plus/icons-vue';\nexport default {\n  name: 'Cluster',\n  components: {\n    DataAnalysis,\n    Refresh,\n    Star,\n    PictureIcon,\n    Document\n  },\n  setup() {\n    const store = useStore();\n    const files = computed(() => store.state.files);\n    const selectedFiles = ref([]);\n    const loading = ref(false);\n    const options = ref({\n      nClusters: 5,\n      method: 'kmeans',\n      language: 'chinese'\n    });\n    const clustering = ref(false);\n    const result = ref(null);\n    const activeClusters = ref(['0', '1', '2']);\n    const showVisualization = ref(false);\n    const vizCanvas = ref(null);\n\n    // 当前聚类结果ID\n    const currentResultId = ref(null);\n\n    // 聚类历史记录\n    const clusterHistory = ref([]);\n\n    // 从localStorage加载历史记录\n    const loadHistory = () => {\n      try {\n        const saved = localStorage.getItem('cluster_history');\n        if (saved) {\n          clusterHistory.value = JSON.parse(saved);\n        }\n      } catch (e) {\n        console.error('加载历史记录失败:', e);\n      }\n    };\n\n    // 保存历史记录到localStorage\n    const saveHistory = () => {\n      try {\n        localStorage.setItem('cluster_history', JSON.stringify(clusterHistory.value));\n      } catch (e) {\n        console.error('保存历史记录失败:', e);\n      }\n    };\n\n    // 格式化日期\n    const formatDate = dateStr => {\n      if (!dateStr) return '';\n      const date = new Date(dateStr);\n      return date.toLocaleString('zh-CN');\n    };\n\n    // 加载历史结果\n    const loadHistoryResult = historyItem => {\n      result.value = historyItem.data;\n      currentResultId.value = null; // 历史结果不需要再保存\n      activeClusters.value = Object.keys(historyItem.data.clusterAnalysis).slice(0, 3);\n      ElMessage.success('已加载历史聚类结果');\n    };\n\n    // 删除历史结果\n    const deleteHistoryResult = index => {\n      clusterHistory.value.splice(index, 1);\n      saveHistory();\n      ElMessage.success('已删除');\n    };\n\n    // 清空历史\n    const clearHistory = () => {\n      clusterHistory.value = [];\n      saveHistory();\n      ElMessage.success('历史记录已清空');\n    };\n\n    // 保存当前结果\n    const saveCurrentResult = () => {\n      if (!result.value) return;\n      const historyItem = {\n        id: Date.now().toString(),\n        createdAt: new Date().toISOString(),\n        clusterCount: result.value.clusterCount,\n        method: result.value.method,\n        paperCount: result.value.papers?.length || 0,\n        data: result.value\n      };\n      clusterHistory.value.unshift(historyItem);\n      saveHistory();\n      currentResultId.value = null; // 已保存，不需要再显示保存按钮\n      ElMessage.success('聚类结果已保存到历史记录');\n    };\n    const handleSelectionChange = selection => {\n      selectedFiles.value = selection;\n    };\n    const refreshFiles = async () => {\n      loading.value = true;\n      try {\n        await store.dispatch('fetchFiles');\n        ElMessage.success('论文列表已刷新');\n      } catch (error) {\n        console.error('刷新失败:', error);\n        ElMessage.error('刷新失败');\n      } finally {\n        loading.value = false;\n      }\n    };\n    const startCluster = async () => {\n      if (selectedFiles.value.length < 2) {\n        ElMessage.warning('请至少选择2篇论文');\n        return;\n      }\n\n      // 验证聚类数量\n      const maxClusters = Math.min(20, selectedFiles.value.length);\n      if (options.value.method !== 'dbscan' && (options.value.nClusters < 2 || options.value.nClusters > maxClusters)) {\n        ElMessage.warning(`聚类数量必须在 2 到 ${maxClusters} 之间`);\n        return;\n      }\n\n      // 连接WebSocket\n      connectSocket();\n      store.commit('SHOW_PROGRESS_DIALOG', true);\n      store.commit('SET_PROGRESS', {\n        progress: 0,\n        message: '开始聚类分析...',\n        step: ''\n      });\n      clustering.value = true;\n      try {\n        // 使用论文ID而不是文件路径\n        const paperIds = selectedFiles.value.map(f => f.id);\n        console.log('[DEBUG] 开始聚类, paper_ids:', paperIds);\n        console.log('[DEBUG] 聚类选项:', options.value);\n        const response = await api.clusterPapers(paperIds, options.value.nClusters, options.value.method, options.value.language);\n        console.log('[DEBUG] 聚类响应:', response);\n        if (response.success) {\n          // 格式化结果\n          result.value = {\n            clusterCount: response.data.n_clusters,\n            clusterAnalysis: response.data.cluster_analysis,\n            papers: response.data.papers || [],\n            method: options.value.method,\n            createdAt: new Date().toISOString()\n          };\n\n          // 生成新的结果ID\n          currentResultId.value = Date.now().toString();\n          store.commit('SET_PROGRESS', {\n            progress: 100,\n            message: '聚类完成!'\n          });\n          ElMessage.success(`聚类分析完成! 共发现 ${response.data.n_clusters} 个主题类别`);\n\n          // 自动展开前3个聚类\n          const clusterIds = Object.keys(response.data.cluster_analysis);\n          activeClusters.value = clusterIds.slice(0, 3);\n\n          // 自动保存到历史记录\n          saveCurrentResult();\n        } else {\n          ElMessage.error({\n            message: response.error || '聚类失败',\n            duration: 5000,\n            showClose: true\n          });\n        }\n      } catch (error) {\n        console.error('[ERROR] 聚类错误:', error);\n\n        // 提供更详细的错误提示\n        let errorMsg = '聚类失败';\n        const errorDetail = error.response?.data?.error || error.message;\n        if (errorDetail) {\n          if (errorDetail.includes('论文') || errorDetail.includes('PDF')) {\n            errorMsg = '论文加载或解析失败，请检查文件是否完整';\n          } else if (errorDetail.includes('聚类') || errorDetail.includes('算法')) {\n            errorMsg = '聚类算法执行失败，请尝试调整参数';\n          } else if (errorDetail.includes('数量') || errorDetail.includes('不足')) {\n            errorMsg = '可用论文数量不足，无法进行聚类';\n          } else if (errorDetail.includes('timeout') || errorDetail.includes('超时')) {\n            errorMsg = '聚类超时，请减少论文数量或降低聚类数量';\n          } else {\n            errorMsg = `聚类失败: ${errorDetail}`;\n          }\n        } else if (error.message) {\n          errorMsg = `聚类失败: ${error.message}`;\n        }\n        ElMessage.error({\n          message: errorMsg,\n          duration: 5000,\n          showClose: true\n        });\n      } finally {\n        clustering.value = false;\n        store.commit('SHOW_PROGRESS_DIALOG', false);\n      }\n    };\n    const downloadVisualization = () => {\n      showVisualization.value = true;\n      // 在对话框打开后绘制可视化\n      setTimeout(() => {\n        drawVisualization();\n      }, 100);\n    };\n    const drawVisualization = () => {\n      const canvas = vizCanvas.value;\n      if (!canvas) return;\n\n      // 设置高分辨率画布\n      const dpr = window.devicePixelRatio || 1;\n      const width = window.innerWidth * 0.85;\n      const height = window.innerHeight * 0.75;\n      canvas.width = width * dpr;\n      canvas.height = height * dpr;\n      canvas.style.width = width + 'px';\n      canvas.style.height = height + 'px';\n      const ctx = canvas.getContext('2d');\n      ctx.scale(dpr, dpr);\n\n      // 背景\n      ctx.fillStyle = '#f8f9fa';\n      ctx.fillRect(0, 0, width, height);\n\n      // 标题\n      ctx.fillStyle = '#333';\n      ctx.font = 'bold 28px Arial';\n      ctx.textAlign = 'center';\n      ctx.fillText('论文主题聚类可视化', width / 2, 50);\n      if (!result.value || !result.value.clusterAnalysis) {\n        return;\n      }\n\n      // 绘制聚类圆形图\n      const clusters = Object.entries(result.value.clusterAnalysis);\n      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#6C5CE7'];\n      const centerX = width / 2;\n      const centerY = height / 2 + 30;\n      const maxRadius = Math.min(width, height) * 0.35;\n\n      // 计算总论文数\n      const totalPapers = clusters.reduce((sum, [, info]) => sum + (info.paper_count || 0), 0);\n\n      // 绘制聚类圆圈\n      let currentAngle = 0;\n      clusters.forEach(([clusterId, info], index) => {\n        const color = colors[index % colors.length];\n        const ratio = (info.paper_count || 0) / Math.max(totalPapers, 1);\n        const angle = ratio * Math.PI * 2;\n\n        // 绘制扇形\n        ctx.beginPath();\n        ctx.moveTo(centerX, centerY);\n        ctx.arc(centerX, centerY, maxRadius, currentAngle, currentAngle + angle);\n        ctx.closePath();\n        ctx.fillStyle = color + '40'; // 添加透明度\n        ctx.fill();\n        ctx.strokeStyle = color;\n        ctx.lineWidth = 3;\n        ctx.stroke();\n\n        // 绘制标签\n        const labelAngle = currentAngle + angle / 2;\n        const labelRadius = maxRadius + 40;\n        const labelX = centerX + Math.cos(labelAngle) * labelRadius;\n        const labelY = centerY + Math.sin(labelAngle) * labelRadius;\n        ctx.fillStyle = color;\n        ctx.font = 'bold 16px Arial';\n        ctx.textAlign = 'center';\n        ctx.fillText(`聚类 ${parseInt(clusterId) + 1}`, labelX, labelY - 10);\n        ctx.font = '14px Arial';\n        ctx.fillStyle = '#666';\n        ctx.fillText(`${info.paper_count || 0}篇`, labelX, labelY + 10);\n        currentAngle += angle;\n      });\n\n      // 中心圆\n      ctx.beginPath();\n      ctx.arc(centerX, centerY, maxRadius * 0.3, 0, Math.PI * 2);\n      ctx.fillStyle = 'white';\n      ctx.fill();\n      ctx.strokeStyle = '#ddd';\n      ctx.lineWidth = 2;\n      ctx.stroke();\n\n      // 中心文字\n      ctx.fillStyle = '#333';\n      ctx.font = 'bold 20px Arial';\n      ctx.textAlign = 'center';\n      ctx.fillText(`${clusters.length}`, centerX, centerY - 5);\n      ctx.font = '14px Arial';\n      ctx.fillStyle = '#666';\n      ctx.fillText('个聚类', centerX, centerY + 15);\n\n      // 绘制图例\n      let legendY = height - 100;\n      const legendX = width / 2 - clusters.length * 150 / 2;\n      clusters.forEach(([clusterId, info], index) => {\n        const color = colors[index % colors.length];\n        const x = legendX + index % 5 * 150;\n        const y = legendY + Math.floor(index / 5) * 40;\n        ctx.fillStyle = color;\n        ctx.fillRect(x, y, 20, 20);\n        ctx.fillStyle = '#333';\n        ctx.font = '12px Arial';\n        ctx.textAlign = 'left';\n        const keywords = info.top_keywords?.slice(0, 2).join(', ') || '无关键词';\n        ctx.fillText(`聚类${parseInt(clusterId) + 1}: ${keywords}`, x + 30, y + 15);\n      });\n    };\n    const downloadHighResVisualization = () => {\n      const canvas = vizCanvas.value;\n      if (!canvas) return;\n\n      // 创建高分辨率下载\n      const link = document.createElement('a');\n      link.download = `cluster_visualization_${Date.now()}_highres.png`;\n      link.href = canvas.toDataURL('image/png', 1.0);\n      link.click();\n      ElMessage.success('高清可视化图下载成功');\n    };\n    const downloadReport = async () => {\n      if (!result.value) {\n        ElMessage.warning('没有可导出的聚类结果');\n        return;\n      }\n      try {\n        // 生成报告内容\n        let content = '论文主题聚类分析报告\\n';\n        content += '='.repeat(80) + '\\n\\n';\n        content += `生成时间: ${formatDate(result.value.createdAt)}\\n`;\n        content += `聚类方法: ${result.value.method || 'K-Means'}\\n`;\n        content += `聚类数量: ${result.value.clusterCount}\\n`;\n        content += `论文总数: ${result.value.papers?.length || 0}\\n\\n`;\n\n        // 每个聚类的详细信息\n        Object.entries(result.value.clusterAnalysis).forEach(([clusterId, info], index) => {\n          content += `\\n${'='.repeat(80)}\\n`;\n          content += `聚类 ${parseInt(clusterId) + 1}\\n`;\n          content += `${'-'.repeat(40)}\\n`;\n          content += `论文数: ${info.paper_count || 0}\\n`;\n          content += `关键词: ${info.top_keywords?.join(', ') || '无'}\\n\\n`;\n          if (info.papers && info.papers.length > 0) {\n            content += '包含论文:\\n';\n            info.papers.forEach((paper, i) => {\n              content += `  ${i + 1}. ${paper}\\n`;\n            });\n          }\n          if (info.representative_papers && info.representative_papers.length > 0) {\n            content += '\\n代表性论文:\\n';\n            info.representative_papers.forEach((paper, i) => {\n              content += `  ${i + 1}. ${paper.title || '无标题'}\\n`;\n              if (paper.abstract) {\n                content += `     摘要: ${paper.abstract}\\n`;\n              }\n            });\n          }\n        });\n        content += `\\n${'='.repeat(80)}\\n`;\n        content += '报告结束\\n';\n\n        // 下载文件\n        const blob = new Blob([content], {\n          type: 'text/plain;charset=utf-8'\n        });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `cluster_report_${Date.now()}.txt`;\n        a.click();\n        URL.revokeObjectURL(url);\n        ElMessage.success('聚类报告下载成功');\n      } catch (error) {\n        console.error('[ERROR] 导出报告失败:', error);\n        ElMessage.error('导出报告失败');\n      }\n    };\n    onMounted(() => {\n      store.dispatch('fetchFiles');\n      loadHistory();\n    });\n    return {\n      files,\n      selectedFiles,\n      loading,\n      options,\n      clustering,\n      result,\n      activeClusters,\n      currentResultId,\n      clusterHistory,\n      showVisualization,\n      vizCanvas,\n      handleSelectionChange,\n      refreshFiles,\n      formatDate,\n      startCluster,\n      downloadVisualization,\n      drawVisualization,\n      downloadHighResVisualization,\n      downloadReport,\n      saveCurrentResult,\n      loadHistoryResult,\n      deleteHistoryResult,\n      clearHistory\n    };\n  }\n};","map":{"version":3,"names":["ref","computed","onMounted","useStore","api","connectSocket","ElMessage","DataAnalysis","Refresh","Star","Picture","PictureIcon","Document","name","components","setup","store","files","state","selectedFiles","loading","options","nClusters","method","language","clustering","result","activeClusters","showVisualization","vizCanvas","currentResultId","clusterHistory","loadHistory","saved","localStorage","getItem","value","JSON","parse","e","console","error","saveHistory","setItem","stringify","formatDate","dateStr","date","Date","toLocaleString","loadHistoryResult","historyItem","data","Object","keys","clusterAnalysis","slice","success","deleteHistoryResult","index","splice","clearHistory","saveCurrentResult","id","now","toString","createdAt","toISOString","clusterCount","paperCount","papers","length","unshift","handleSelectionChange","selection","refreshFiles","dispatch","startCluster","warning","maxClusters","Math","min","commit","progress","message","step","paperIds","map","f","log","response","clusterPapers","n_clusters","cluster_analysis","clusterIds","duration","showClose","errorMsg","errorDetail","includes","downloadVisualization","setTimeout","drawVisualization","canvas","dpr","window","devicePixelRatio","width","innerWidth","height","innerHeight","style","ctx","getContext","scale","fillStyle","fillRect","font","textAlign","fillText","clusters","entries","colors","centerX","centerY","maxRadius","totalPapers","reduce","sum","info","paper_count","currentAngle","forEach","clusterId","color","ratio","max","angle","PI","beginPath","moveTo","arc","closePath","fill","strokeStyle","lineWidth","stroke","labelAngle","labelRadius","labelX","cos","labelY","sin","parseInt","legendY","legendX","x","y","floor","keywords","top_keywords","join","downloadHighResVisualization","link","document","createElement","download","href","toDataURL","click","downloadReport","content","repeat","paper","i","representative_papers","title","abstract","blob","Blob","type","url","URL","createObjectURL","a","revokeObjectURL"],"sources":["/Users/liucunyu/Documents/all_code/NUC_graduation_project/frontend/src/views/Cluster.vue"],"sourcesContent":["<template>\n  <div class=\"cluster\">\n    <h2>多篇论文主题聚类分析</h2>\n\n    <el-card class=\"select-card\">\n      <div class=\"select-header\">\n        <h3>选择要分析的论文（至少2篇）</h3>\n        <el-button @click=\"refreshFiles\" size=\"small\">\n          <el-icon><Refresh /></el-icon>\n          刷新列表\n        </el-button>\n      </div>\n      <el-table\n        :data=\"files\"\n        style=\"width: 100%; margin-top: 20px\"\n        @selection-change=\"handleSelectionChange\"\n        v-loading=\"loading\"\n      >\n        <el-table-column type=\"selection\" width=\"55\" />\n        <el-table-column prop=\"title\" label=\"论文标题\" min-width=\"250\">\n          <template #default=\"scope\">\n            {{ scope.row.title || '未命名论文' }}\n          </template>\n        </el-table-column>\n        <el-table-column prop=\"year\" label=\"年份\" width=\"80\">\n          <template #default=\"scope\">\n            {{ scope.row.year || '未知' }}\n          </template>\n        </el-table-column>\n        <el-table-column prop=\"venue\" label=\"期刊/会议\" min-width=\"150\" />\n      </el-table>\n    </el-card>\n\n    <el-card class=\"options-card\">\n      <h3>聚类选项</h3>\n      <el-form :model=\"options\" label-width=\"120px\">\n        <el-form-item label=\"聚类数量\">\n          <el-input-number v-model=\"options.nClusters\" :min=\"2\" :max=\"10\" />\n        </el-form-item>\n        <el-form-item label=\"聚类方法\">\n          <el-select v-model=\"options.method\">\n            <el-option label=\"K-Means\" value=\"kmeans\" />\n            <el-option label=\"DBSCAN\" value=\"dbscan\" />\n            <el-option label=\"层次聚类\" value=\"hierarchical\" />\n          </el-select>\n        </el-form-item>\n        <el-form-item label=\"论文语言\">\n          <el-select v-model=\"options.language\">\n            <el-option label=\"中文\" value=\"chinese\" />\n            <el-option label=\"英文\" value=\"english\" />\n          </el-select>\n        </el-form-item>\n      </el-form>\n\n      <el-button\n        type=\"primary\"\n        size=\"large\"\n        @click=\"startCluster\"\n        :disabled=\"selectedFiles.length < 2\"\n        :loading=\"clustering\"\n      >\n        <el-icon><DataAnalysis /></el-icon> 开始聚类分析\n      </el-button>\n    </el-card>\n\n    <!-- 历史聚类结果 -->\n    <el-card class=\"history-card\" v-if=\"clusterHistory.length > 0\">\n      <div class=\"history-header\">\n        <h3>历史聚类结果</h3>\n        <el-button @click=\"clearHistory\" type=\"danger\" size=\"small\" plain>清空历史</el-button>\n      </div>\n      <el-table :data=\"clusterHistory\" style=\"width: 100%; margin-top: 10px\">\n        <el-table-column prop=\"createdAt\" label=\"时间\" width=\"180\">\n          <template #default=\"scope\">\n            {{ formatDate(scope.row.createdAt) }}\n          </template>\n        </el-table-column>\n        <el-table-column prop=\"clusterCount\" label=\"聚类数\" width=\"80\" />\n        <el-table-column prop=\"method\" label=\"方法\" width=\"120\" />\n        <el-table-column prop=\"paperCount\" label=\"论文数\" width=\"80\" />\n        <el-table-column label=\"操作\" width=\"200\">\n          <template #default=\"scope\">\n            <el-button type=\"primary\" size=\"small\" @click=\"loadHistoryResult(scope.row)\">查看</el-button>\n            <el-button type=\"danger\" size=\"small\" @click=\"deleteHistoryResult(scope.$index)\">删除</el-button>\n          </template>\n        </el-table-column>\n      </el-table>\n    </el-card>\n\n    <el-card class=\"result-card\" v-if=\"result\">\n      <div class=\"result-header\">\n        <h3>聚类结果</h3>\n        <div class=\"result-actions-top\">\n          <el-tag type=\"success\" size=\"large\" effect=\"dark\">\n            {{ result.clusterCount }} 个主题类别\n          </el-tag>\n          <el-button\n            v-if=\"currentResultId\"\n            type=\"warning\"\n            size=\"small\"\n            @click=\"saveCurrentResult\"\n          >\n            <el-icon><Star /></el-icon>\n            保存结果\n          </el-button>\n        </div>\n      </div>\n\n      <el-collapse v-model=\"activeClusters\">\n        <el-collapse-item\n          v-for=\"(cluster, index) in Object.entries(result.clusterAnalysis)\"\n          :key=\"cluster[0]\"\n          :name=\"cluster[0]\"\n        >\n          <template #title>\n            <div class=\"cluster-title\">\n              <span class=\"cluster-name\">聚类 {{ parseInt(cluster[0]) + 1 }}</span>\n              <el-tag type=\"success\" size=\"small\">\n                {{ cluster[1]?.paper_count || 0 }} 篇论文\n              </el-tag>\n              <el-tag\n                v-if=\"cluster[1]?.top_keywords?.length > 0\"\n                type=\"info\"\n                size=\"small\"\n                style=\"margin-left: 8px;\"\n              >\n                {{ cluster[1].top_keywords.slice(0, 3).join(', ') }}\n              </el-tag>\n            </div>\n          </template>\n\n          <div class=\"cluster-content\">\n            <h4>核心关键词</h4>\n            <el-space wrap v-if=\"cluster[1].top_keywords && cluster[1].top_keywords.length > 0\">\n              <el-tag\n                v-for=\"(keyword, kIndex) in cluster[1].top_keywords.slice(0, 10)\"\n                :key=\"kIndex\"\n                type=\"success\"\n                effect=\"dark\"\n              >\n                {{ keyword }}\n              </el-tag>\n            </el-space>\n            <el-empty v-else description=\"暂无关键词\" :image-size=\"60\" />\n\n            <h4 style=\"margin-top: 20px\">包含论文</h4>\n            <ul v-if=\"cluster[1].papers && cluster[1].papers.length > 0\" class=\"paper-list\">\n              <li v-for=\"(paper, pIndex) in cluster[1].papers\" :key=\"pIndex\">\n                {{ paper }}\n              </li>\n            </ul>\n            <el-empty v-else description=\"暂无论文\" :image-size=\"60\" />\n\n            <h4 style=\"margin-top: 20px\">代表性论文</h4>\n            <div\n              v-if=\"cluster[1].representative_papers && cluster[1].representative_papers.length > 0\"\n            >\n              <div\n                v-for=\"(rep, rIndex) in cluster[1].representative_papers\"\n                :key=\"rIndex\"\n                class=\"rep-paper\"\n              >\n                <p><strong>{{ rep.title || '无标题' }}</strong></p>\n                <p class=\"rep-abstract\">{{ rep.abstract || '无摘要' }}</p>\n              </div>\n            </div>\n            <el-empty v-else description=\"暂无代表性论文\" :image-size=\"60\" />\n          </div>\n        </el-collapse-item>\n      </el-collapse>\n\n      <div class=\"result-actions\">\n        <el-button type=\"primary\" @click=\"downloadVisualization\">\n          <el-icon><PictureIcon /></el-icon>\n          下载高清可视化图\n        </el-button>\n        <el-button @click=\"downloadReport\">\n          <el-icon><Document /></el-icon>\n          下载聚类报告\n        </el-button>\n      </div>\n    </el-card>\n\n    <!-- 聚类可视化对话框 -->\n    <el-dialog\n      v-model=\"showVisualization\"\n      title=\"聚类可视化\"\n      width=\"90%\"\n      :fullscreen=\"true\"\n    >\n      <div class=\"visualization-container\">\n        <canvas ref=\"vizCanvas\" class=\"viz-canvas\"></canvas>\n      </div>\n      <template #footer>\n        <el-button @click=\"showVisualization = false\">关闭</el-button>\n        <el-button type=\"primary\" @click=\"downloadHighResVisualization\">下载高清图</el-button>\n      </template>\n    </el-dialog>\n  </div>\n</template>\n\n<script>\nimport { ref, computed, onMounted } from 'vue'\nimport { useStore } from 'vuex'\nimport api, { connectSocket } from '@/api'\nimport { ElMessage } from 'element-plus'\nimport { DataAnalysis, Refresh, Star, Picture as PictureIcon, Document } from '@element-plus/icons-vue'\n\nexport default {\n  name: 'Cluster',\n  components: {\n    DataAnalysis,\n    Refresh,\n    Star,\n    PictureIcon,\n    Document\n  },\n  setup() {\n    const store = useStore()\n\n    const files = computed(() => store.state.files)\n    const selectedFiles = ref([])\n    const loading = ref(false)\n    const options = ref({\n      nClusters: 5,\n      method: 'kmeans',\n      language: 'chinese'\n    })\n    const clustering = ref(false)\n    const result = ref(null)\n    const activeClusters = ref(['0', '1', '2'])\n    const showVisualization = ref(false)\n    const vizCanvas = ref(null)\n\n    // 当前聚类结果ID\n    const currentResultId = ref(null)\n\n    // 聚类历史记录\n    const clusterHistory = ref([])\n\n    // 从localStorage加载历史记录\n    const loadHistory = () => {\n      try {\n        const saved = localStorage.getItem('cluster_history')\n        if (saved) {\n          clusterHistory.value = JSON.parse(saved)\n        }\n      } catch (e) {\n        console.error('加载历史记录失败:', e)\n      }\n    }\n\n    // 保存历史记录到localStorage\n    const saveHistory = () => {\n      try {\n        localStorage.setItem('cluster_history', JSON.stringify(clusterHistory.value))\n      } catch (e) {\n        console.error('保存历史记录失败:', e)\n      }\n    }\n\n    // 格式化日期\n    const formatDate = (dateStr) => {\n      if (!dateStr) return ''\n      const date = new Date(dateStr)\n      return date.toLocaleString('zh-CN')\n    }\n\n    // 加载历史结果\n    const loadHistoryResult = (historyItem) => {\n      result.value = historyItem.data\n      currentResultId.value = null // 历史结果不需要再保存\n      activeClusters.value = Object.keys(historyItem.data.clusterAnalysis).slice(0, 3)\n      ElMessage.success('已加载历史聚类结果')\n    }\n\n    // 删除历史结果\n    const deleteHistoryResult = (index) => {\n      clusterHistory.value.splice(index, 1)\n      saveHistory()\n      ElMessage.success('已删除')\n    }\n\n    // 清空历史\n    const clearHistory = () => {\n      clusterHistory.value = []\n      saveHistory()\n      ElMessage.success('历史记录已清空')\n    }\n\n    // 保存当前结果\n    const saveCurrentResult = () => {\n      if (!result.value) return\n\n      const historyItem = {\n        id: Date.now().toString(),\n        createdAt: new Date().toISOString(),\n        clusterCount: result.value.clusterCount,\n        method: result.value.method,\n        paperCount: result.value.papers?.length || 0,\n        data: result.value\n      }\n\n      clusterHistory.value.unshift(historyItem)\n      saveHistory()\n      currentResultId.value = null // 已保存，不需要再显示保存按钮\n      ElMessage.success('聚类结果已保存到历史记录')\n    }\n\n    const handleSelectionChange = (selection) => {\n      selectedFiles.value = selection\n    }\n\n    const refreshFiles = async () => {\n      loading.value = true\n      try {\n        await store.dispatch('fetchFiles')\n        ElMessage.success('论文列表已刷新')\n      } catch (error) {\n        console.error('刷新失败:', error)\n        ElMessage.error('刷新失败')\n      } finally {\n        loading.value = false\n      }\n    }\n\n    const startCluster = async () => {\n      if (selectedFiles.value.length < 2) {\n        ElMessage.warning('请至少选择2篇论文')\n        return\n      }\n\n      // 验证聚类数量\n      const maxClusters = Math.min(20, selectedFiles.value.length)\n      if (options.value.method !== 'dbscan' && (options.value.nClusters < 2 || options.value.nClusters > maxClusters)) {\n        ElMessage.warning(`聚类数量必须在 2 到 ${maxClusters} 之间`)\n        return\n      }\n\n      // 连接WebSocket\n      connectSocket()\n      store.commit('SHOW_PROGRESS_DIALOG', true)\n      store.commit('SET_PROGRESS', { progress: 0, message: '开始聚类分析...', step: '' })\n\n      clustering.value = true\n\n      try {\n        // 使用论文ID而不是文件路径\n        const paperIds = selectedFiles.value.map(f => f.id)\n\n        console.log('[DEBUG] 开始聚类, paper_ids:', paperIds)\n        console.log('[DEBUG] 聚类选项:', options.value)\n\n        const response = await api.clusterPapers(\n          paperIds,\n          options.value.nClusters,\n          options.value.method,\n          options.value.language\n        )\n\n        console.log('[DEBUG] 聚类响应:', response)\n\n        if (response.success) {\n          // 格式化结果\n          result.value = {\n            clusterCount: response.data.n_clusters,\n            clusterAnalysis: response.data.cluster_analysis,\n            papers: response.data.papers || [],\n            method: options.value.method,\n            createdAt: new Date().toISOString()\n          }\n\n          // 生成新的结果ID\n          currentResultId.value = Date.now().toString()\n\n          store.commit('SET_PROGRESS', { progress: 100, message: '聚类完成!' })\n          ElMessage.success(`聚类分析完成! 共发现 ${response.data.n_clusters} 个主题类别`)\n\n          // 自动展开前3个聚类\n          const clusterIds = Object.keys(response.data.cluster_analysis)\n          activeClusters.value = clusterIds.slice(0, 3)\n\n          // 自动保存到历史记录\n          saveCurrentResult()\n        } else {\n          ElMessage.error({\n            message: response.error || '聚类失败',\n            duration: 5000,\n            showClose: true\n          })\n        }\n      } catch (error) {\n        console.error('[ERROR] 聚类错误:', error)\n\n        // 提供更详细的错误提示\n        let errorMsg = '聚类失败'\n        const errorDetail = error.response?.data?.error || error.message\n\n        if (errorDetail) {\n          if (errorDetail.includes('论文') || errorDetail.includes('PDF')) {\n            errorMsg = '论文加载或解析失败，请检查文件是否完整'\n          } else if (errorDetail.includes('聚类') || errorDetail.includes('算法')) {\n            errorMsg = '聚类算法执行失败，请尝试调整参数'\n          } else if (errorDetail.includes('数量') || errorDetail.includes('不足')) {\n            errorMsg = '可用论文数量不足，无法进行聚类'\n          } else if (errorDetail.includes('timeout') || errorDetail.includes('超时')) {\n            errorMsg = '聚类超时，请减少论文数量或降低聚类数量'\n          } else {\n            errorMsg = `聚类失败: ${errorDetail}`\n          }\n        } else if (error.message) {\n          errorMsg = `聚类失败: ${error.message}`\n        }\n\n        ElMessage.error({\n          message: errorMsg,\n          duration: 5000,\n          showClose: true\n        })\n      } finally {\n        clustering.value = false\n        store.commit('SHOW_PROGRESS_DIALOG', false)\n      }\n    }\n\n    const downloadVisualization = () => {\n      showVisualization.value = true\n      // 在对话框打开后绘制可视化\n      setTimeout(() => {\n        drawVisualization()\n      }, 100)\n    }\n\n    const drawVisualization = () => {\n      const canvas = vizCanvas.value\n      if (!canvas) return\n\n      // 设置高分辨率画布\n      const dpr = window.devicePixelRatio || 1\n      const width = window.innerWidth * 0.85\n      const height = window.innerHeight * 0.75\n\n      canvas.width = width * dpr\n      canvas.height = height * dpr\n      canvas.style.width = width + 'px'\n      canvas.style.height = height + 'px'\n\n      const ctx = canvas.getContext('2d')\n      ctx.scale(dpr, dpr)\n\n      // 背景\n      ctx.fillStyle = '#f8f9fa'\n      ctx.fillRect(0, 0, width, height)\n\n      // 标题\n      ctx.fillStyle = '#333'\n      ctx.font = 'bold 28px Arial'\n      ctx.textAlign = 'center'\n      ctx.fillText('论文主题聚类可视化', width / 2, 50)\n\n      if (!result.value || !result.value.clusterAnalysis) {\n        return\n      }\n\n      // 绘制聚类圆形图\n      const clusters = Object.entries(result.value.clusterAnalysis)\n      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#6C5CE7']\n\n      const centerX = width / 2\n      const centerY = height / 2 + 30\n      const maxRadius = Math.min(width, height) * 0.35\n\n      // 计算总论文数\n      const totalPapers = clusters.reduce((sum, [, info]) => sum + (info.paper_count || 0), 0)\n\n      // 绘制聚类圆圈\n      let currentAngle = 0\n      clusters.forEach(([clusterId, info], index) => {\n        const color = colors[index % colors.length]\n        const ratio = (info.paper_count || 0) / Math.max(totalPapers, 1)\n        const angle = ratio * Math.PI * 2\n\n        // 绘制扇形\n        ctx.beginPath()\n        ctx.moveTo(centerX, centerY)\n        ctx.arc(centerX, centerY, maxRadius, currentAngle, currentAngle + angle)\n        ctx.closePath()\n        ctx.fillStyle = color + '40' // 添加透明度\n        ctx.fill()\n        ctx.strokeStyle = color\n        ctx.lineWidth = 3\n        ctx.stroke()\n\n        // 绘制标签\n        const labelAngle = currentAngle + angle / 2\n        const labelRadius = maxRadius + 40\n        const labelX = centerX + Math.cos(labelAngle) * labelRadius\n        const labelY = centerY + Math.sin(labelAngle) * labelRadius\n\n        ctx.fillStyle = color\n        ctx.font = 'bold 16px Arial'\n        ctx.textAlign = 'center'\n        ctx.fillText(`聚类 ${parseInt(clusterId) + 1}`, labelX, labelY - 10)\n        ctx.font = '14px Arial'\n        ctx.fillStyle = '#666'\n        ctx.fillText(`${info.paper_count || 0}篇`, labelX, labelY + 10)\n\n        currentAngle += angle\n      })\n\n      // 中心圆\n      ctx.beginPath()\n      ctx.arc(centerX, centerY, maxRadius * 0.3, 0, Math.PI * 2)\n      ctx.fillStyle = 'white'\n      ctx.fill()\n      ctx.strokeStyle = '#ddd'\n      ctx.lineWidth = 2\n      ctx.stroke()\n\n      // 中心文字\n      ctx.fillStyle = '#333'\n      ctx.font = 'bold 20px Arial'\n      ctx.textAlign = 'center'\n      ctx.fillText(`${clusters.length}`, centerX, centerY - 5)\n      ctx.font = '14px Arial'\n      ctx.fillStyle = '#666'\n      ctx.fillText('个聚类', centerX, centerY + 15)\n\n      // 绘制图例\n      let legendY = height - 100\n      const legendX = width / 2 - (clusters.length * 150) / 2\n\n      clusters.forEach(([clusterId, info], index) => {\n        const color = colors[index % colors.length]\n        const x = legendX + (index % 5) * 150\n        const y = legendY + Math.floor(index / 5) * 40\n\n        ctx.fillStyle = color\n        ctx.fillRect(x, y, 20, 20)\n        ctx.fillStyle = '#333'\n        ctx.font = '12px Arial'\n        ctx.textAlign = 'left'\n        const keywords = info.top_keywords?.slice(0, 2).join(', ') || '无关键词'\n        ctx.fillText(`聚类${parseInt(clusterId) + 1}: ${keywords}`, x + 30, y + 15)\n      })\n    }\n\n    const downloadHighResVisualization = () => {\n      const canvas = vizCanvas.value\n      if (!canvas) return\n\n      // 创建高分辨率下载\n      const link = document.createElement('a')\n      link.download = `cluster_visualization_${Date.now()}_highres.png`\n      link.href = canvas.toDataURL('image/png', 1.0)\n      link.click()\n      ElMessage.success('高清可视化图下载成功')\n    }\n\n    const downloadReport = async () => {\n      if (!result.value) {\n        ElMessage.warning('没有可导出的聚类结果')\n        return\n      }\n\n      try {\n        // 生成报告内容\n        let content = '论文主题聚类分析报告\\n'\n        content += '=' .repeat(80) + '\\n\\n'\n        content += `生成时间: ${formatDate(result.value.createdAt)}\\n`\n        content += `聚类方法: ${result.value.method || 'K-Means'}\\n`\n        content += `聚类数量: ${result.value.clusterCount}\\n`\n        content += `论文总数: ${result.value.papers?.length || 0}\\n\\n`\n\n        // 每个聚类的详细信息\n        Object.entries(result.value.clusterAnalysis).forEach(([clusterId, info], index) => {\n          content += `\\n${'=' .repeat(80)}\\n`\n          content += `聚类 ${parseInt(clusterId) + 1}\\n`\n          content += `${'-' .repeat(40)}\\n`\n          content += `论文数: ${info.paper_count || 0}\\n`\n          content += `关键词: ${info.top_keywords?.join(', ') || '无'}\\n\\n`\n\n          if (info.papers && info.papers.length > 0) {\n            content += '包含论文:\\n'\n            info.papers.forEach((paper, i) => {\n              content += `  ${i + 1}. ${paper}\\n`\n            })\n          }\n\n          if (info.representative_papers && info.representative_papers.length > 0) {\n            content += '\\n代表性论文:\\n'\n            info.representative_papers.forEach((paper, i) => {\n              content += `  ${i + 1}. ${paper.title || '无标题'}\\n`\n              if (paper.abstract) {\n                content += `     摘要: ${paper.abstract}\\n`\n              }\n            })\n          }\n        })\n\n        content += `\\n${'=' .repeat(80)}\\n`\n        content += '报告结束\\n'\n\n        // 下载文件\n        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' })\n        const url = URL.createObjectURL(blob)\n        const a = document.createElement('a')\n        a.href = url\n        a.download = `cluster_report_${Date.now()}.txt`\n        a.click()\n        URL.revokeObjectURL(url)\n\n        ElMessage.success('聚类报告下载成功')\n      } catch (error) {\n        console.error('[ERROR] 导出报告失败:', error)\n        ElMessage.error('导出报告失败')\n      }\n    }\n\n    onMounted(() => {\n      store.dispatch('fetchFiles')\n      loadHistory()\n    })\n\n    return {\n      files,\n      selectedFiles,\n      loading,\n      options,\n      clustering,\n      result,\n      activeClusters,\n      currentResultId,\n      clusterHistory,\n      showVisualization,\n      vizCanvas,\n      handleSelectionChange,\n      refreshFiles,\n      formatDate,\n      startCluster,\n      downloadVisualization,\n      drawVisualization,\n      downloadHighResVisualization,\n      downloadReport,\n      saveCurrentResult,\n      loadHistoryResult,\n      deleteHistoryResult,\n      clearHistory\n    }\n  }\n}\n</script>\n\n<style scoped>\n.cluster {\n  max-width: 1200px;\n  margin: 0 auto;\n}\n\nh2 {\n  margin-bottom: 20px;\n  color: #303133;\n}\n\n.select-card,\n.options-card,\n.result-card,\n.history-card {\n  margin-bottom: 20px;\n}\n\n.select-header,\n.history-header,\n.result-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 10px;\n}\n\n.select-header h3,\n.history-header h3,\n.result-header h3 {\n  margin: 0;\n}\n\n.result-actions-top {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n}\n\n.cluster-title {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n}\n\n.cluster-name {\n  font-weight: 600;\n}\n\n.cluster-content h4 {\n  color: #409eff;\n  margin: 20px 0 10px 0;\n}\n\n.paper-list {\n  list-style: none;\n  padding: 0;\n  margin: 0;\n}\n\n.paper-list li {\n  padding: 8px 0;\n  padding-left: 20px;\n  position: relative;\n  border-bottom: 1px solid #eee;\n}\n\n.paper-list li:before {\n  content: '•';\n  position: absolute;\n  left: 0;\n  color: #409eff;\n  font-weight: bold;\n}\n\n.rep-paper {\n  padding: 15px;\n  background: #f5f7fa;\n  border-radius: 4px;\n  margin-bottom: 10px;\n}\n\n.rep-paper p {\n  margin: 5px 0;\n}\n\n.rep-abstract {\n  color: #606266;\n  font-size: 14px;\n  line-height: 1.6;\n}\n\n.result-actions {\n  margin-top: 20px;\n  display: flex;\n  gap: 10px;\n  justify-content: flex-end;\n}\n\n.visualization-container {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 500px;\n  background: #f8f9fa;\n  border-radius: 8px;\n}\n\n.viz-canvas {\n  max-width: 100%;\n  max-height: 80vh;\n}\n\n/* 表格样式优化 */\n:deep(.el-table) {\n  font-size: 14px;\n}\n\n:deep(.el-tag) {\n  font-size: 12px;\n}\n</style>\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}