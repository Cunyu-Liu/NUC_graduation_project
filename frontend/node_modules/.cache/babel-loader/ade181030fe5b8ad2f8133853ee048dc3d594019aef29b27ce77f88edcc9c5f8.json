{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport { getCurrentInstance, ref, unref } from 'vue';\nimport { isNull } from 'lodash-unified';\nimport { getRowIdentity } from '../util.mjs';\nfunction useCurrent(watcherData) {\n  const instance = getCurrentInstance();\n  const _currentRowKey = ref(null);\n  const currentRow = ref(null);\n  const setCurrentRowKey = key => {\n    instance.store.assertRowKey();\n    _currentRowKey.value = key;\n    setCurrentRowByKey(key);\n  };\n  const restoreCurrentRowKey = () => {\n    _currentRowKey.value = null;\n  };\n  const setCurrentRowByKey = key => {\n    var _a;\n    const {\n      data,\n      rowKey\n    } = watcherData;\n    let _currentRow = null;\n    if (rowKey.value) {\n      _currentRow = (_a = (unref(data) || []).find(item => getRowIdentity(item, rowKey.value) === key)) != null ? _a : null;\n    }\n    currentRow.value = _currentRow != null ? _currentRow : null;\n    instance.emit(\"current-change\", currentRow.value, null);\n  };\n  const updateCurrentRow = _currentRow => {\n    const oldCurrentRow = currentRow.value;\n    if (_currentRow && _currentRow !== oldCurrentRow) {\n      currentRow.value = _currentRow;\n      instance.emit(\"current-change\", currentRow.value, oldCurrentRow);\n      return;\n    }\n    if (!_currentRow && oldCurrentRow) {\n      currentRow.value = null;\n      instance.emit(\"current-change\", null, oldCurrentRow);\n    }\n  };\n  const updateCurrentRowData = () => {\n    const rowKey = watcherData.rowKey.value;\n    const data = watcherData.data.value || [];\n    const oldCurrentRow = currentRow.value;\n    if (oldCurrentRow && !data.includes(oldCurrentRow)) {\n      if (rowKey) {\n        const currentRowKey = getRowIdentity(oldCurrentRow, rowKey);\n        setCurrentRowByKey(currentRowKey);\n      } else {\n        currentRow.value = null;\n      }\n      if (isNull(currentRow.value)) {\n        instance.emit(\"current-change\", null, oldCurrentRow);\n      }\n    } else if (_currentRowKey.value) {\n      setCurrentRowByKey(_currentRowKey.value);\n      restoreCurrentRowKey();\n    }\n  };\n  return {\n    setCurrentRowKey,\n    restoreCurrentRowKey,\n    setCurrentRowByKey,\n    updateCurrentRow,\n    updateCurrentRowData,\n    states: {\n      _currentRowKey,\n      currentRow\n    }\n  };\n}\nexport { useCurrent as default };","map":{"version":3,"names":["useCurrent","watcherData","instance","getCurrentInstance","_currentRowKey","ref","currentRow","setCurrentRowKey","key","store","assertRowKey","value","setCurrentRowByKey","restoreCurrentRowKey","_a","data","rowKey","_currentRow","unref","find","item","getRowIdentity","emit","updateCurrentRow","oldCurrentRow","updateCurrentRowData","includes","currentRowKey","isNull","states"],"sources":["../../../../../../../packages/components/table/src/store/current.ts"],"sourcesContent":["import { getCurrentInstance, ref, unref } from 'vue'\nimport { isNull } from 'lodash-unified'\nimport { getRowIdentity } from '../util'\n\nimport type { Ref } from 'vue'\nimport type { DefaultRow, Table } from '../table/defaults'\nimport type { WatcherPropsData } from '.'\n\nfunction useCurrent<T extends DefaultRow>(watcherData: WatcherPropsData<T>) {\n  const instance = getCurrentInstance() as Table<T>\n  const _currentRowKey: Ref<string | null> = ref(null)\n  const currentRow: Ref<T | null> = ref(null)\n\n  const setCurrentRowKey = (key: string) => {\n    instance.store.assertRowKey()\n    _currentRowKey.value = key\n    setCurrentRowByKey(key)\n  }\n\n  const restoreCurrentRowKey = () => {\n    _currentRowKey.value = null\n  }\n\n  const setCurrentRowByKey = (key: string) => {\n    const { data, rowKey } = watcherData\n    let _currentRow: T | null = null\n    if (rowKey.value) {\n      _currentRow =\n        (unref(data) || []).find(\n          (item) => getRowIdentity(item, rowKey.value) === key\n        ) ?? null\n    }\n    currentRow.value = _currentRow ?? null\n    instance.emit('current-change', currentRow.value, null)\n  }\n\n  const updateCurrentRow = (_currentRow: T) => {\n    const oldCurrentRow = currentRow.value\n    if (_currentRow && _currentRow !== oldCurrentRow) {\n      currentRow.value = _currentRow\n      instance.emit('current-change', currentRow.value, oldCurrentRow)\n      return\n    }\n    if (!_currentRow && oldCurrentRow) {\n      currentRow.value = null\n      instance.emit('current-change', null, oldCurrentRow)\n    }\n  }\n\n  const updateCurrentRowData = () => {\n    const rowKey = watcherData.rowKey.value\n    // data 为 null 时，解构时的默认值会被忽略\n    const data = watcherData.data.value || []\n    const oldCurrentRow = currentRow.value\n    // 当 currentRow 不在 data 中时尝试更新数据\n    if (oldCurrentRow && !data.includes(oldCurrentRow)) {\n      if (rowKey) {\n        const currentRowKey = getRowIdentity(oldCurrentRow, rowKey)\n        setCurrentRowByKey(currentRowKey)\n      } else {\n        currentRow.value = null\n      }\n      if (isNull(currentRow.value)) {\n        instance.emit('current-change', null, oldCurrentRow)\n      }\n    } else if (_currentRowKey.value) {\n      // 把初始时下设置的 rowKey 转化成 rowData\n      setCurrentRowByKey(_currentRowKey.value)\n      restoreCurrentRowKey()\n    }\n  }\n\n  return {\n    setCurrentRowKey,\n    restoreCurrentRowKey,\n    setCurrentRowByKey,\n    updateCurrentRow,\n    updateCurrentRowData,\n    states: {\n      _currentRowKey,\n      currentRow,\n    },\n  }\n}\n\nexport default useCurrent\n"],"mappings":";;;;;AAQA,SAASA,WAAiCC,WAAkC;EAC1E,MAAMC,QAAA,GAAWC,kBAAmB;EAC9B,MAAAC,cAAA,GAAqCC,GAAA,CAAI,IAAI;EAC7C,MAAAC,UAAA,GAA4BD,GAAA,CAAI,IAAI;EAEpC,MAAAE,gBAAA,GAAoBC,GAAgB;IACxCN,QAAA,CAASO,KAAA,CAAMC,YAAa;IAC5BN,cAAA,CAAeO,KAAQ,GAAAH,GAAA;IACvBI,kBAAA,CAAmBJ,GAAG;EAAA,CACxB;EAEA,MAAMK,oBAAA,GAAuBA,CAAA,KAAM;IACjCT,cAAA,CAAeO,KAAQ;EAAA,CACzB;EAEM,MAAAC,kBAAA,GAAsBJ,GAAgB;IAvB9C,IAAAM,EAAA;IAwBU;MAAEC,IAAM;MAAAC;IAAA,CAAW,GAAAf,WAAA;IACzB,IAAIgB,WAAwB;IAC5B,IAAID,MAAA,CAAOL,KAAO;MAChBM,WAAA,IACGH,EAAM,IAAAI,KAAA,CAAAH,IAAI,CAAK,MAAI,EAAAI,IAAA,CACjBC,IAAS,IAAAC,cAAA,CAAeD,IAAM,EAAAJ,MAAA,CAAOL,KAAK,CAAM,KAAAH,GAAA,MADlD,IAEI,GAAAM,EAAA;IAAA;IAETR,UAAA,CAAWK,KAAA,GAAQM,WAAe,WAAAA,WAAA;IAClCf,QAAA,CAASoB,IAAK,mBAAkBhB,UAAW,CAAAK,KAAA,EAAO,IAAI;EAAA,CACxD;EAEM,MAAAY,gBAAA,GAAoBN,WAAmB;IAC3C,MAAMO,aAAA,GAAgBlB,UAAW,CAAAK,KAAA;IAC7B,IAAAM,WAAA,IAAeA,WAAA,KAAgBO,aAAe;MAChDlB,UAAA,CAAWK,KAAQ,GAAAM,WAAA;MACnBf,QAAA,CAASoB,IAAK,mBAAkBhB,UAAW,CAAAK,KAAA,EAAOa,aAAa;MAC/D;IAAA;IAEE,KAACP,WAAA,IAAeO,aAAe;MACjClB,UAAA,CAAWK,KAAQ;MACVT,QAAA,CAAAoB,IAAA,CAAK,gBAAkB,QAAME,aAAa;IAAA;EACrD,CACF;EAEA,MAAMC,oBAAA,GAAuBA,CAAA,KAAM;IAC3B,MAAAT,MAAA,GAASf,WAAA,CAAYe,MAAO,CAAAL,KAAA;IAElC,MAAMI,IAAO,GAAAd,WAAA,CAAYc,IAAK,CAAAJ,KAAA,IAAS,EAAC;IACxC,MAAMa,aAAA,GAAgBlB,UAAW,CAAAK,KAAA;IAEjC,IAAIa,aAAiB,KAACT,IAAK,CAAAW,QAAA,CAASF,aAAa,CAAG;MAClD,IAAIR,MAAQ;QACJ,MAAAW,aAAA,GAAgBN,cAAe,CAAAG,aAAA,EAAeR,MAAM;QAC1DJ,kBAAA,CAAmBe,aAAa;MAAA,CAC3B;QACLrB,UAAA,CAAWK,KAAQ;MAAA;MAEjB,IAAAiB,MAAA,CAAOtB,UAAW,CAAAK,KAAK,CAAG;QACnBT,QAAA,CAAAoB,IAAA,CAAK,gBAAkB,QAAME,aAAa;MAAA;IACrD,CACF,UAAWpB,cAAA,CAAeO,KAAO;MAE/BC,kBAAA,CAAmBR,cAAA,CAAeO,KAAK;MAClBE,oBAAA;IAAA;EACvB,CACF;EAEO;IACLN,gBAAA;IACAM,oBAAA;IACAD,kBAAA;IACAW,gBAAA;IACAE,oBAAA;IACAI,MAAQ;MACNzB,cAAA;MACAE;IAAA;EACF,CACF;AACF","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}