{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.reduce.js\";\nimport { ref, toRef, getCurrentInstance, shallowRef, computed, unref, watch } from 'vue';\nimport { useColumns } from './composables/use-columns.mjs';\nimport { useScrollbar } from './composables/use-scrollbar.mjs';\nimport { useRow } from './composables/use-row.mjs';\nimport { useData } from './composables/use-data.mjs';\nimport { useStyles } from './composables/use-styles.mjs';\nimport { useNamespace } from '../../../hooks/use-namespace/index.mjs';\nimport { isNumber } from '../../../utils/types.mjs';\nimport { isArray } from '@vue/shared';\nfunction useTable(props) {\n  const mainTableRef = ref();\n  const leftTableRef = ref();\n  const rightTableRef = ref();\n  const {\n    columns,\n    columnsStyles,\n    columnsTotalWidth,\n    fixedColumnsOnLeft,\n    fixedColumnsOnRight,\n    hasFixedColumns,\n    mainColumns,\n    onColumnSorted\n  } = useColumns(props, toRef(props, \"columns\"), toRef(props, \"fixed\"));\n  const {\n    scrollTo,\n    scrollToLeft,\n    scrollToTop,\n    scrollToRow,\n    onScroll,\n    onVerticalScroll,\n    scrollPos\n  } = useScrollbar(props, {\n    mainTableRef,\n    leftTableRef,\n    rightTableRef,\n    onMaybeEndReached\n  });\n  const ns = useNamespace(\"table-v2\");\n  const instance = getCurrentInstance();\n  const isScrolling = shallowRef(false);\n  const {\n    expandedRowKeys,\n    lastRenderedRowIndex,\n    isDynamic,\n    isResetting,\n    rowHeights,\n    resetAfterIndex,\n    onRowExpanded,\n    onRowHeightChange,\n    onRowHovered,\n    onRowsRendered\n  } = useRow(props, {\n    mainTableRef,\n    leftTableRef,\n    rightTableRef,\n    tableInstance: instance,\n    ns,\n    isScrolling\n  });\n  const {\n    data,\n    depthMap\n  } = useData(props, {\n    expandedRowKeys,\n    lastRenderedRowIndex,\n    resetAfterIndex\n  });\n  const rowsHeight = computed(() => {\n    const {\n      estimatedRowHeight,\n      rowHeight\n    } = props;\n    const _data = unref(data);\n    if (isNumber(estimatedRowHeight)) {\n      return Object.values(unref(rowHeights)).reduce((acc, curr) => acc + curr, 0);\n    }\n    return _data.length * rowHeight;\n  });\n  const {\n    bodyWidth,\n    fixedTableHeight,\n    mainTableHeight,\n    leftTableWidth,\n    rightTableWidth,\n    windowHeight,\n    footerHeight,\n    emptyStyle,\n    rootStyle,\n    headerHeight\n  } = useStyles(props, {\n    columnsTotalWidth,\n    fixedColumnsOnLeft,\n    fixedColumnsOnRight,\n    rowsHeight\n  });\n  const containerRef = ref();\n  const showEmpty = computed(() => {\n    const noData = unref(data).length === 0;\n    return isArray(props.fixedData) ? props.fixedData.length === 0 && noData : noData;\n  });\n  function getRowHeight(rowIndex) {\n    const {\n      estimatedRowHeight,\n      rowHeight,\n      rowKey\n    } = props;\n    if (!estimatedRowHeight) return rowHeight;\n    return unref(rowHeights)[unref(data)[rowIndex][rowKey]] || estimatedRowHeight;\n  }\n  const isEndReached = ref(false);\n  function onMaybeEndReached() {\n    const {\n      onEndReached\n    } = props;\n    if (!onEndReached) return;\n    const {\n      scrollTop\n    } = unref(scrollPos);\n    const _totalHeight = unref(rowsHeight);\n    const clientHeight = unref(windowHeight);\n    const remainDistance = _totalHeight - (scrollTop + clientHeight) + props.hScrollbarSize;\n    if (!isEndReached.value && unref(lastRenderedRowIndex) >= 0 && _totalHeight <= scrollTop + unref(mainTableHeight) - unref(headerHeight)) {\n      isEndReached.value = true;\n      onEndReached(remainDistance);\n    } else {\n      isEndReached.value = false;\n    }\n  }\n  watch(() => unref(rowsHeight), () => isEndReached.value = false);\n  watch(() => props.expandedRowKeys, val => expandedRowKeys.value = val, {\n    deep: true\n  });\n  return {\n    columns,\n    containerRef,\n    mainTableRef,\n    leftTableRef,\n    rightTableRef,\n    isDynamic,\n    isResetting,\n    isScrolling,\n    hasFixedColumns,\n    columnsStyles,\n    columnsTotalWidth,\n    data,\n    expandedRowKeys,\n    depthMap,\n    fixedColumnsOnLeft,\n    fixedColumnsOnRight,\n    mainColumns,\n    bodyWidth,\n    emptyStyle,\n    rootStyle,\n    footerHeight,\n    mainTableHeight,\n    fixedTableHeight,\n    leftTableWidth,\n    rightTableWidth,\n    showEmpty,\n    getRowHeight,\n    onColumnSorted,\n    onRowHovered,\n    onRowExpanded,\n    onRowsRendered,\n    onRowHeightChange,\n    scrollTo,\n    scrollToLeft,\n    scrollToTop,\n    scrollToRow,\n    onScroll,\n    onVerticalScroll\n  };\n}\nexport { useTable };","map":{"version":3,"names":["useTable","props","mainTableRef","ref","leftTableRef","rightTableRef","columns","columnsStyles","columnsTotalWidth","fixedColumnsOnLeft","fixedColumnsOnRight","hasFixedColumns","mainColumns","onColumnSorted","useColumns","toRef","scrollTo","scrollToLeft","scrollToTop","scrollToRow","onScroll","onVerticalScroll","scrollPos","useScrollbar","onMaybeEndReached","ns","useNamespace","instance","getCurrentInstance","isScrolling","shallowRef","expandedRowKeys","lastRenderedRowIndex","isDynamic","isResetting","rowHeights","resetAfterIndex","onRowExpanded","onRowHeightChange","onRowHovered","onRowsRendered","useRow","tableInstance","data","depthMap","useData","rowsHeight","computed","estimatedRowHeight","rowHeight","_data","unref","isNumber","Object","values","reduce","acc","curr","length","bodyWidth","fixedTableHeight","mainTableHeight","leftTableWidth","rightTableWidth","windowHeight","footerHeight","emptyStyle","rootStyle","headerHeight","useStyles","containerRef","showEmpty","noData","isArray","fixedData","getRowHeight","rowIndex","rowKey","isEndReached","onEndReached","scrollTop","_totalHeight","clientHeight","remainDistance","hScrollbarSize","value","watch","val","deep"],"sources":["../../../../../../packages/components/table-v2/src/use-table.ts"],"sourcesContent":["import {\n  computed,\n  getCurrentInstance,\n  ref,\n  shallowRef,\n  toRef,\n  unref,\n  watch,\n} from 'vue'\nimport { isArray, isNumber } from '@element-plus/utils'\nimport { useNamespace } from '@element-plus/hooks'\nimport {\n  useColumns,\n  useData,\n  useRow,\n  useScrollbar,\n  useStyles,\n} from './composables'\n\nimport type { TableV2Props } from './table'\nimport type { TableGridInstance } from './table-grid'\n\nfunction useTable(props: TableV2Props) {\n  const mainTableRef = ref<TableGridInstance>()\n  const leftTableRef = ref<TableGridInstance>()\n  const rightTableRef = ref<TableGridInstance>()\n  const {\n    columns,\n    columnsStyles,\n    columnsTotalWidth,\n    fixedColumnsOnLeft,\n    fixedColumnsOnRight,\n    hasFixedColumns,\n    mainColumns,\n\n    onColumnSorted,\n  } = useColumns(props, toRef(props, 'columns'), toRef(props, 'fixed'))\n\n  const {\n    scrollTo,\n    scrollToLeft,\n    scrollToTop,\n    scrollToRow,\n    onScroll,\n    onVerticalScroll,\n    scrollPos,\n  } = useScrollbar(props, {\n    mainTableRef,\n    leftTableRef,\n    rightTableRef,\n\n    onMaybeEndReached,\n  })\n\n  const ns = useNamespace('table-v2')\n  const instance = getCurrentInstance()!\n\n  // state\n  const isScrolling = shallowRef(false)\n\n  const {\n    expandedRowKeys,\n    lastRenderedRowIndex,\n    isDynamic,\n    isResetting,\n    rowHeights,\n    resetAfterIndex,\n    onRowExpanded,\n    onRowHeightChange,\n    onRowHovered,\n    onRowsRendered,\n  } = useRow(props, {\n    mainTableRef,\n    leftTableRef,\n    rightTableRef,\n    tableInstance: instance,\n    ns,\n    isScrolling,\n  })\n\n  const { data, depthMap } = useData(props, {\n    expandedRowKeys,\n    lastRenderedRowIndex,\n    resetAfterIndex,\n  })\n\n  const rowsHeight = computed(() => {\n    const { estimatedRowHeight, rowHeight } = props\n    const _data = unref(data)\n    if (isNumber(estimatedRowHeight)) {\n      // calculate the actual height\n      return Object.values(unref(rowHeights)).reduce(\n        (acc, curr) => acc + curr,\n        0\n      )\n    }\n\n    return _data.length * rowHeight\n  })\n\n  const {\n    bodyWidth,\n    fixedTableHeight,\n    mainTableHeight,\n    leftTableWidth,\n    rightTableWidth,\n    windowHeight,\n    footerHeight,\n    emptyStyle,\n    rootStyle,\n    headerHeight,\n  } = useStyles(props, {\n    columnsTotalWidth,\n    fixedColumnsOnLeft,\n    fixedColumnsOnRight,\n    rowsHeight,\n  })\n\n  // DOM/Component refs\n  const containerRef = ref()\n\n  const showEmpty = computed(() => {\n    const noData = unref(data).length === 0\n\n    return isArray(props.fixedData)\n      ? props.fixedData.length === 0 && noData\n      : noData\n  })\n\n  function getRowHeight(rowIndex: number) {\n    const { estimatedRowHeight, rowHeight, rowKey } = props\n\n    if (!estimatedRowHeight) return rowHeight\n\n    return (\n      unref(rowHeights)[unref(data)[rowIndex][rowKey]] || estimatedRowHeight\n    )\n  }\n\n  const isEndReached = ref(false)\n  function onMaybeEndReached() {\n    const { onEndReached } = props\n    if (!onEndReached) return\n\n    const { scrollTop } = unref(scrollPos)\n\n    const _totalHeight = unref(rowsHeight)\n    const clientHeight = unref(windowHeight)\n\n    const remainDistance =\n      _totalHeight - (scrollTop + clientHeight) + props.hScrollbarSize\n\n    if (\n      !isEndReached.value &&\n      unref(lastRenderedRowIndex) >= 0 &&\n      _totalHeight <= scrollTop + unref(mainTableHeight) - unref(headerHeight)\n    ) {\n      isEndReached.value = true\n      onEndReached(remainDistance)\n    } else {\n      isEndReached.value = false\n    }\n  }\n\n  // events\n\n  watch(\n    () => unref(rowsHeight),\n    () => (isEndReached.value = false)\n  )\n\n  watch(\n    () => props.expandedRowKeys,\n    (val) => (expandedRowKeys.value = val),\n    {\n      deep: true,\n    }\n  )\n\n  return {\n    // models\n    columns,\n    containerRef,\n    mainTableRef,\n    leftTableRef,\n    rightTableRef,\n    // states\n    isDynamic,\n    isResetting,\n    isScrolling,\n    hasFixedColumns,\n    // records\n    columnsStyles,\n    columnsTotalWidth,\n    data,\n    expandedRowKeys,\n    depthMap,\n    fixedColumnsOnLeft,\n    fixedColumnsOnRight,\n    mainColumns,\n    // metadata\n    bodyWidth,\n    emptyStyle,\n    rootStyle,\n    footerHeight,\n    mainTableHeight,\n    fixedTableHeight,\n    leftTableWidth,\n    rightTableWidth,\n    // flags\n    showEmpty,\n\n    // methods\n    getRowHeight,\n\n    // event handlers\n    onColumnSorted,\n    onRowHovered,\n    onRowExpanded,\n    onRowsRendered,\n    onRowHeightChange,\n    // use scrollbars\n    scrollTo,\n    scrollToLeft,\n    scrollToTop,\n    scrollToRow,\n    onScroll,\n    onVerticalScroll,\n  }\n}\n\nexport { useTable }\n\nexport type UseTableReturn = ReturnType<typeof useTable>\n"],"mappings":";;;;;;;;;;;AAsBA,SAASA,SAASC,KAAqB;EACrC,MAAMC,YAAA,GAAeC,GAAuB;EAC5C,MAAMC,YAAA,GAAeD,GAAuB;EAC5C,MAAME,aAAA,GAAgBF,GAAuB;EACvC;IACJG,OAAA;IACAC,aAAA;IACAC,iBAAA;IACAC,kBAAA;IACAC,mBAAA;IACAC,eAAA;IACAC,WAAA;IAEAC;EAAA,CACF,GAAIC,UAAW,CAAAb,KAAA,EAAOc,KAAM,CAAAd,KAAA,EAAO,SAAS,CAAG,EAAAc,KAAA,CAAMd,KAAO,SAAO,CAAC;EAE9D;IACJe,QAAA;IACAC,YAAA;IACAC,WAAA;IACAC,WAAA;IACAC,QAAA;IACAC,gBAAA;IACAC;EAAA,CACF,GAAIC,YAAA,CAAatB,KAAO;IACtBC,YAAA;IACAE,YAAA;IACAC,aAAA;IAEAmB;EAAA,CACD;EAEK,MAAAC,EAAA,GAAKC,YAAA,CAAa,UAAU;EAClC,MAAMC,QAAA,GAAWC,kBAAmB;EAG9B,MAAAC,WAAA,GAAcC,UAAA,CAAW,KAAK;EAE9B;IACJC,eAAA;IACAC,oBAAA;IACAC,SAAA;IACAC,WAAA;IACAC,UAAA;IACAC,eAAA;IACAC,aAAA;IACAC,iBAAA;IACAC,YAAA;IACAC;EAAA,CACF,GAAIC,MAAA,CAAOxC,KAAO;IAChBC,YAAA;IACAE,YAAA;IACAC,aAAA;IACAqC,aAAe,EAAAf,QAAA;IACfF,EAAA;IACAI;EAAA,CACD;EAED,MAAM;IAAEc,IAAA;IAAMC;EAAS,IAAIC,OAAA,CAAQ5C,KAAO;IACxC8B,eAAA;IACAC,oBAAA;IACAI;EAAA,CACD;EAEK,MAAAU,UAAA,GAAaC,QAAA,CAAS,MAAM;IAC1B;MAAEC,kBAAoB;MAAAC;IAAA,CAAc,GAAAhD,KAAA;IACpC,MAAAiD,KAAA,GAAQC,KAAA,CAAMR,IAAI;IACpB,IAAAS,QAAA,CAASJ,kBAAkB,CAAG;MAEhC,OAAOK,MAAO,CAAAC,MAAA,CAAOH,KAAM,CAAAhB,UAAU,CAAC,CAAE,CAAAoB,MAAA,CACtC,CAACC,GAAK,EAAAC,IAAA,KAASD,GAAM,GAAAC,IAAA,EACrB,EACF;IAAA;IAGF,OAAOP,KAAA,CAAMQ,MAAS,GAAAT,SAAA;EAAA,CACvB;EAEK;IACJU,SAAA;IACAC,gBAAA;IACAC,eAAA;IACAC,cAAA;IACAC,eAAA;IACAC,YAAA;IACAC,YAAA;IACAC,UAAA;IACAC,SAAA;IACAC;EAAA,CACF,GAAIC,SAAA,CAAUpE,KAAO;IACnBO,iBAAA;IACAC,kBAAA;IACAC,mBAAA;IACAoC;EAAA,CACD;EAGD,MAAMwB,YAAA,GAAenE,GAAI;EAEnB,MAAAoE,SAAA,GAAYxB,QAAA,CAAS,MAAM;IAC/B,MAAMyB,MAAS,GAAArB,KAAA,CAAMR,IAAI,EAAEe,MAAW;IAE/B,OAAAe,OAAA,CAAQxE,KAAA,CAAMyE,SAAS,IAC1BzE,KAAA,CAAMyE,SAAU,CAAAhB,MAAA,KAAW,KAAKc,MAChC,GAAAA,MAAA;EAAA,CACL;EAED,SAASG,aAAaC,QAAkB;IACtC,MAAM;MAAE5B,kBAAA;MAAoBC,SAAW;MAAA4B;IAAA,CAAW,GAAA5E,KAAA;IAElD,IAAI,CAAC+C,kBAAA,EAA2B,OAAAC,SAAA;IAEhC,OACEE,KAAA,CAAMhB,UAAU,EAAEgB,KAAA,CAAMR,IAAI,EAAEiC,QAAA,EAAUC,MAAY,MAAA7B,kBAAA;EAAA;EAIlD,MAAA8B,YAAA,GAAe3E,GAAA,CAAI,KAAK;EAC9B,SAASqB,iBAAoBA,CAAA;IACrB;MAAEuD;IAAA,CAAiB,GAAA9E,KAAA;IACzB,IAAI,CAAC8E,YAAA,EAAc;IAEnB,MAAM;MAAEC;IAAA,CAAc,GAAA7B,KAAA,CAAM7B,SAAS;IAE/B,MAAA2D,YAAA,GAAe9B,KAAA,CAAML,UAAU;IAC/B,MAAAoC,YAAA,GAAe/B,KAAA,CAAMa,YAAY;IAEvC,MAAMmB,cACJ,GAAAF,YAAA,IAAgBD,SAAY,GAAAE,YAAA,IAAgBjF,KAAM,CAAAmF,cAAA;IAEpD,IACE,CAACN,YAAA,CAAaO,KACd,IAAAlC,KAAA,CAAMnB,oBAAoB,CAAK,SAC/BiD,YAAgB,IAAAD,SAAA,GAAY7B,KAAM,CAAAU,eAAe,CAAI,GAAAV,KAAA,CAAMiB,YAAY,CACvE;MACAU,YAAA,CAAaO,KAAQ;MACrBN,YAAA,CAAaI,cAAc;IAAA,CACtB;MACLL,YAAA,CAAaO,KAAQ;IAAA;EACvB;EAKFC,KAAA,CACE,MAAMnC,KAAA,CAAML,UAAU,GACtB,MAAOgC,YAAA,CAAaO,KAAQ,SAC9B;EAEAC,KAAA,CACE,MAAMrF,KAAM,CAAA8B,eAAA,EACXwD,GAAS,IAAAxD,eAAA,CAAgBsD,KAAQ,GAAAE,GAAA,EAClC;IACEC,IAAM;EAAA,CACR,CACF;EAEO;IAELlF,OAAA;IACAgE,YAAA;IACApE,YAAA;IACAE,YAAA;IACAC,aAAA;IAEA4B,SAAA;IACAC,WAAA;IACAL,WAAA;IACAlB,eAAA;IAEAJ,aAAA;IACAC,iBAAA;IACAmC,IAAA;IACAZ,eAAA;IACAa,QAAA;IACAnC,kBAAA;IACAC,mBAAA;IACAE,WAAA;IAEA+C,SAAA;IACAO,UAAA;IACAC,SAAA;IACAF,YAAA;IACAJ,eAAA;IACAD,gBAAA;IACAE,cAAA;IACAC,eAAA;IAEAQ,SAAA;IAGAI,YAAA;IAGA9D,cAAA;IACA0B,YAAA;IACAF,aAAA;IACAG,cAAA;IACAF,iBAAA;IAEAtB,QAAA;IACAC,YAAA;IACAC,WAAA;IACAC,WAAA;IACAC,QAAA;IACAC;EAAA,CACF;AACF","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}