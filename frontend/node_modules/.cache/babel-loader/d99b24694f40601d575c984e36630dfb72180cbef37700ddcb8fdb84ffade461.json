{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport { watch, nextTick, onMounted, toRefs, computed } from 'vue';\nimport { useEventListener } from '@vueuse/core';\nimport { pick } from 'lodash-unified';\nimport { ElSelect } from '../../select/index.mjs';\nimport { useNamespace } from '../../../hooks/use-namespace/index.mjs';\nimport { getEventCode } from '../../../utils/dom/event.mjs';\nimport { EVENT_CODE } from '../../../constants/aria.mjs';\nimport { UPDATE_MODEL_EVENT } from '../../../constants/event.mjs';\nconst useSelect = (props, {\n  attrs,\n  emit\n}, {\n  select,\n  tree,\n  key\n}) => {\n  const ns = useNamespace(\"tree-select\");\n  watch(() => props.data, () => {\n    if (props.filterable) {\n      nextTick(() => {\n        var _a, _b;\n        (_b = tree.value) == null ? void 0 : _b.filter((_a = select.value) == null ? void 0 : _a.states.inputValue);\n      });\n    }\n  }, {\n    flush: \"post\"\n  });\n  const focusLastNode = listNode => {\n    var _a;\n    const lastNode = listNode.at(-1);\n    if (lastNode.expanded && lastNode.childNodes.at(-1)) {\n      focusLastNode([lastNode.childNodes.at(-1)]);\n    } else {\n      const el = (_a = tree.value.el$) == null ? void 0 : _a.querySelector(`[data-key=\"${listNode.at(-1).key}\"]`);\n      el == null ? void 0 : el.focus({\n        preventScroll: true\n      });\n      return;\n    }\n  };\n  onMounted(() => {\n    useEventListener(() => {\n      var _a;\n      return (_a = select.value) == null ? void 0 : _a.$el;\n    }, \"keydown\", async evt => {\n      const code = getEventCode(evt);\n      const {\n        dropdownMenuVisible\n      } = select.value;\n      if ([EVENT_CODE.down, EVENT_CODE.up].includes(code) && dropdownMenuVisible) {\n        await nextTick();\n        setTimeout(() => {\n          var _a, _b, _c;\n          if (EVENT_CODE.up === code) {\n            const listNode = tree.value.store.root.childNodes;\n            focusLastNode(listNode);\n            return;\n          }\n          (_c = (_b = (_a = select.value.optionsArray[select.value.states.hoveringIndex].$el) == null ? void 0 : _a.parentNode) == null ? void 0 : _b.parentNode) == null ? void 0 : _c.focus({\n            preventScroll: true\n          });\n        });\n      }\n    }, {\n      capture: true\n    });\n  });\n  const result = {\n    ...pick(toRefs(props), Object.keys(ElSelect.props)),\n    ...attrs,\n    class: computed(() => attrs.class),\n    style: computed(() => attrs.style),\n    \"onUpdate:modelValue\": value => emit(UPDATE_MODEL_EVENT, value),\n    valueKey: key,\n    popperClass: computed(() => {\n      const classes = [ns.e(\"popper\")];\n      if (props.popperClass) classes.push(props.popperClass);\n      return classes.join(\" \");\n    }),\n    filterMethod: (keyword = \"\") => {\n      var _a;\n      if (props.filterMethod) {\n        props.filterMethod(keyword);\n      } else if (props.remoteMethod) {\n        props.remoteMethod(keyword);\n      } else {\n        (_a = tree.value) == null ? void 0 : _a.filter(keyword);\n      }\n    }\n  };\n  return result;\n};\nexport { useSelect };","map":{"version":3,"names":["useSelect","props","attrs","emit","select","tree","key","ns","useNamespace","watch","data","filterable","nextTick","_a","_b","value","filter","states","inputValue","flush","focusLastNode","listNode","lastNode","at","expanded","childNodes","el","el$","querySelector","focus","preventScroll","onMounted","useEventListener","$el","evt","code","getEventCode","dropdownMenuVisible","EVENT_CODE","down","up","includes","setTimeout","_c","store","root","optionsArray","hoveringIndex","parentNode","capture","result","pick","toRefs","Object","keys","ElSelect","class","computed","style","UPDATE_MODEL_EVENT","valueKey","popperClass","classes","e","push","join","filterMethod","keyword","remoteMethod"],"sources":["../../../../../../packages/components/tree-select/src/select.ts"],"sourcesContent":["// @ts-nocheck\nimport { computed, nextTick, onMounted, toRefs, watch } from 'vue'\nimport { useEventListener } from '@vueuse/core'\nimport { pick } from 'lodash-unified'\nimport ElSelect from '@element-plus/components/select'\nimport { useNamespace } from '@element-plus/hooks'\nimport { EVENT_CODE, UPDATE_MODEL_EVENT } from '@element-plus/constants'\nimport { getEventCode } from '@element-plus/utils'\n\nimport type { Ref } from 'vue'\nimport type { SelectInstance } from '@element-plus/components/select'\nimport type { TreeInstance } from '@element-plus/components/tree'\n\nexport const useSelect = (\n  props,\n  { attrs, emit },\n  {\n    select,\n    tree,\n    key,\n  }: {\n    select: Ref<SelectInstance | undefined>\n    tree: Ref<TreeInstance | undefined>\n    key: Ref<string>\n  }\n) => {\n  const ns = useNamespace('tree-select')\n\n  // update tree data when use filterMethod/remoteMethod\n  watch(\n    () => props.data,\n    () => {\n      if (props.filterable) {\n        nextTick(() => {\n          // let tree node expand only, same with tree filter\n          tree.value?.filter(select.value?.states.inputValue)\n        })\n      }\n    },\n    { flush: 'post' }\n  )\n\n  const focusLastNode = (listNode) => {\n    const lastNode = listNode.at(-1)\n    if (lastNode.expanded && lastNode.childNodes.at(-1)) {\n      focusLastNode([lastNode.childNodes.at(-1)])\n    } else {\n      const el = tree.value.el$?.querySelector(\n        `[data-key=\"${listNode.at(-1).key}\"]`\n      )\n      el?.focus({ preventScroll: true })\n      return\n    }\n  }\n\n  onMounted(() => {\n    useEventListener(\n      () => select.value?.$el,\n      'keydown',\n      async (evt) => {\n        const code = getEventCode(evt)\n        const { dropdownMenuVisible } = select.value!\n        if (\n          [EVENT_CODE.down, EVENT_CODE.up].includes(code) &&\n          dropdownMenuVisible\n        ) {\n          await nextTick()\n          // wait navigateOption to finish\n          setTimeout(() => {\n            if (EVENT_CODE.up === code) {\n              const listNode = tree.value.store.root.childNodes\n              focusLastNode(listNode)\n              return\n            }\n            // el-select-dropdown__item => el-tree-node__content => el-tree-node__content\n            select.value.optionsArray[\n              select.value.states.hoveringIndex\n            ].$el?.parentNode?.parentNode?.focus({ preventScroll: true })\n          })\n        }\n      },\n      {\n        capture: true,\n      }\n    )\n  })\n\n  const result = {\n    ...pick(toRefs(props), Object.keys(ElSelect.props)),\n    ...attrs,\n    class: computed(() => attrs.class),\n    style: computed(() => attrs.style),\n    // attrs is not reactive, when v-model binding source changes,\n    // this listener is still old, see the bug(or test 'v-model source change'):\n    // https://github.com/element-plus/element-plus/issues/14204\n    'onUpdate:modelValue': (value) => emit(UPDATE_MODEL_EVENT, value),\n    valueKey: key,\n    popperClass: computed(() => {\n      const classes = [ns.e('popper')]\n      if (props.popperClass) classes.push(props.popperClass)\n      return classes.join(' ')\n    }),\n    filterMethod: (keyword = '') => {\n      if (props.filterMethod) {\n        props.filterMethod(keyword)\n      } else if (props.remoteMethod) {\n        props.remoteMethod(keyword)\n      } else {\n        // let tree node expand only, same with tree filter\n        tree.value?.filter(keyword)\n      }\n    },\n  }\n\n  return result\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}