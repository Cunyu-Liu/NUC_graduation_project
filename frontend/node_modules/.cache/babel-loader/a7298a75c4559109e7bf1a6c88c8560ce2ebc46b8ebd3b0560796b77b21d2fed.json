{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/esnext.json.parse.js\";\nimport { isNil } from 'lodash-unified';\nimport { throwError } from '../../../utils/error.mjs';\nimport { isArray } from '@vue/shared';\nconst SCOPE = \"ElUpload\";\nclass UploadAjaxError extends Error {\n  constructor(message, status, method, url) {\n    super(message);\n    this.name = \"UploadAjaxError\";\n    this.status = status;\n    this.method = method;\n    this.url = url;\n  }\n}\nfunction getError(action, option, xhr) {\n  let msg;\n  if (xhr.response) {\n    msg = `${xhr.response.error || xhr.response}`;\n  } else if (xhr.responseText) {\n    msg = `${xhr.responseText}`;\n  } else {\n    msg = `fail to ${option.method} ${action} ${xhr.status}`;\n  }\n  return new UploadAjaxError(msg, xhr.status, option.method, action);\n}\nfunction getBody(xhr) {\n  const text = xhr.responseText || xhr.response;\n  if (!text) {\n    return text;\n  }\n  try {\n    return JSON.parse(text);\n  } catch (e) {\n    return text;\n  }\n}\nconst ajaxUpload = option => {\n  if (typeof XMLHttpRequest === \"undefined\") throwError(SCOPE, \"XMLHttpRequest is undefined\");\n  const xhr = new XMLHttpRequest();\n  const action = option.action;\n  if (xhr.upload) {\n    xhr.upload.addEventListener(\"progress\", evt => {\n      const progressEvt = evt;\n      progressEvt.percent = evt.total > 0 ? evt.loaded / evt.total * 100 : 0;\n      option.onProgress(progressEvt);\n    });\n  }\n  const formData = new FormData();\n  if (option.data) {\n    for (const [key, value] of Object.entries(option.data)) {\n      if (isArray(value) && value.length) formData.append(key, ...value);else formData.append(key, value);\n    }\n  }\n  formData.append(option.filename, option.file, option.file.name);\n  xhr.addEventListener(\"error\", () => {\n    option.onError(getError(action, option, xhr));\n  });\n  xhr.addEventListener(\"load\", () => {\n    if (xhr.status < 200 || xhr.status >= 300) {\n      return option.onError(getError(action, option, xhr));\n    }\n    option.onSuccess(getBody(xhr));\n  });\n  xhr.open(option.method, action, true);\n  if (option.withCredentials && \"withCredentials\" in xhr) {\n    xhr.withCredentials = true;\n  }\n  const headers = option.headers || {};\n  if (headers instanceof Headers) {\n    headers.forEach((value, key) => xhr.setRequestHeader(key, value));\n  } else {\n    for (const [key, value] of Object.entries(headers)) {\n      if (isNil(value)) continue;\n      xhr.setRequestHeader(key, String(value));\n    }\n  }\n  xhr.send(formData);\n  return xhr;\n};\nexport { UploadAjaxError, ajaxUpload };","map":{"version":3,"names":["SCOPE","UploadAjaxError","Error","constructor","message","status","method","url","name","getError","action","option","xhr","msg","response","error","responseText","getBody","text","JSON","parse","e","ajaxUpload","XMLHttpRequest","throwError","upload","addEventListener","evt","progressEvt","percent","total","loaded","onProgress","formData","FormData","data","key","value","Object","entries","isArray","length","append","filename","file","onError","onSuccess","open","withCredentials","headers","Headers","forEach","setRequestHeader","isNil","String","send"],"sources":["../../../../../../packages/components/upload/src/ajax.ts"],"sourcesContent":["import { isNil } from 'lodash-unified'\nimport { isArray, throwError } from '@element-plus/utils'\n\nimport type {\n  UploadProgressEvent,\n  UploadRequestHandler,\n  UploadRequestOptions,\n} from './upload'\n\nconst SCOPE = 'ElUpload'\n\nexport class UploadAjaxError extends Error {\n  name = 'UploadAjaxError'\n  status: number\n  method: string\n  url: string\n\n  constructor(message: string, status: number, method: string, url: string) {\n    super(message)\n    this.status = status\n    this.method = method\n    this.url = url\n  }\n}\n\nfunction getError(\n  action: string,\n  option: UploadRequestOptions,\n  xhr: XMLHttpRequest\n) {\n  let msg: string\n  if (xhr.response) {\n    msg = `${xhr.response.error || xhr.response}`\n  } else if (xhr.responseText) {\n    msg = `${xhr.responseText}`\n  } else {\n    msg = `fail to ${option.method} ${action} ${xhr.status}`\n  }\n\n  return new UploadAjaxError(msg, xhr.status, option.method, action)\n}\n\nfunction getBody(xhr: XMLHttpRequest): XMLHttpRequestResponseType {\n  const text = xhr.responseText || xhr.response\n  if (!text) {\n    return text\n  }\n\n  try {\n    return JSON.parse(text)\n  } catch {\n    return text\n  }\n}\n\nexport const ajaxUpload: UploadRequestHandler = (option) => {\n  if (typeof XMLHttpRequest === 'undefined')\n    throwError(SCOPE, 'XMLHttpRequest is undefined')\n\n  const xhr = new XMLHttpRequest()\n  const action = option.action\n\n  if (xhr.upload) {\n    xhr.upload.addEventListener('progress', (evt) => {\n      const progressEvt = evt as UploadProgressEvent\n      progressEvt.percent = evt.total > 0 ? (evt.loaded / evt.total) * 100 : 0\n      option.onProgress(progressEvt)\n    })\n  }\n\n  const formData = new FormData()\n  if (option.data) {\n    for (const [key, value] of Object.entries(option.data)) {\n      if (isArray(value) && value.length) formData.append(key, ...value)\n      else formData.append(key, value)\n    }\n  }\n  formData.append(option.filename, option.file, option.file.name)\n\n  xhr.addEventListener('error', () => {\n    option.onError(getError(action, option, xhr))\n  })\n\n  xhr.addEventListener('load', () => {\n    if (xhr.status < 200 || xhr.status >= 300) {\n      return option.onError(getError(action, option, xhr))\n    }\n    option.onSuccess(getBody(xhr))\n  })\n\n  xhr.open(option.method, action, true)\n\n  if (option.withCredentials && 'withCredentials' in xhr) {\n    xhr.withCredentials = true\n  }\n\n  const headers = option.headers || {}\n  if (headers instanceof Headers) {\n    headers.forEach((value, key) => xhr.setRequestHeader(key, value))\n  } else {\n    for (const [key, value] of Object.entries(headers)) {\n      if (isNil(value)) continue\n      xhr.setRequestHeader(key, String(value))\n    }\n  }\n\n  xhr.send(formData)\n  return xhr\n}\n"],"mappings":";;;;;;AASA,MAAMA,KAAQ;AAEP,MAAMC,eAAA,SAAwBC,KAAM;EAMzCC,WAAYA,CAAAC,OAAA,EAAiBC,MAAgB,EAAAC,MAAA,EAAgBC,GAAa;IACxE,MAAMH,OAAO;IANR,KAAAI,IAAA;IAOL,KAAKH,MAAS,GAAAA,MAAA;IACd,KAAKC,MAAS,GAAAA,MAAA;IACd,KAAKC,GAAM,GAAAA,GAAA;EAAA;AAEf;AAEA,SAASE,SACPC,MACA,EAAAC,MAAA,EACAC,GACA;EACI,IAAAC,GAAA;EACJ,IAAID,GAAA,CAAIE,QAAU;IAChBD,GAAA,GAAM,GAAGD,GAAA,CAAIE,QAAS,CAAAC,KAAA,IAASH,GAAI,CAAAE,QAAA;EAAA,CACrC,UAAWF,GAAA,CAAII,YAAc;IAC3BH,GAAA,GAAM,GAAGD,GAAI,CAAAI,YAAA;EAAA,CACR;IACLH,GAAA,GAAM,WAAWF,MAAA,CAAOL,MAAU,IAAAI,MAAA,IAAUE,GAAI,CAAAP,MAAA;EAAA;EAGlD,OAAO,IAAIJ,eAAgB,CAAAY,GAAA,EAAKD,GAAA,CAAIP,MAAQ,EAAAM,MAAA,CAAOL,MAAA,EAAQI,MAAM;AACnE;AAEA,SAASO,QAAQL,GAAiD;EAC1D,MAAAM,IAAA,GAAON,GAAI,CAAAI,YAAA,IAAgBJ,GAAI,CAAAE,QAAA;EACrC,IAAI,CAACI,IAAM;IACF,OAAAA,IAAA;EAAA;EAGL;IACK,OAAAC,IAAA,CAAKC,KAAA,CAAMF,IAAI;EAAA,SAChBG,CAAN;IACO,OAAAH,IAAA;EAAA;AAEX;AAEa,MAAAI,UAAA,GAAoCX,MAAW;EAC1D,IAAI,OAAOY,cAAmB,kBAC5BC,UAAA,CAAWxB,KAAA,EAAO,6BAA6B;EAE3C,MAAAY,GAAA,GAAM,IAAIW,cAAe;EAC/B,MAAMb,MAAA,GAASC,MAAO,CAAAD,MAAA;EAEtB,IAAIE,GAAA,CAAIa,MAAQ;IACdb,GAAA,CAAIa,MAAO,CAAAC,gBAAA,CAAiB,UAAY,EAACC,GAAQ;MAC/C,MAAMC,WAAc,GAAAD,GAAA;MACRC,WAAA,CAAAC,OAAA,GAAUF,GAAA,CAAIG,KAAQ,OAAKH,GAAA,CAAII,MAAS,GAAAJ,GAAA,CAAIG,KAAA,GAAS,GAAM;MACvEnB,MAAA,CAAOqB,UAAA,CAAWJ,WAAW;IAAA,CAC9B;EAAA;EAGG,MAAAK,QAAA,GAAW,IAAIC,QAAS;EAC9B,IAAIvB,MAAA,CAAOwB,IAAM;IACJ,YAACC,GAAA,EAAKC,KAAK,KAAKC,MAAA,CAAOC,OAAQ,CAAA5B,MAAA,CAAOwB,IAAI,CAAG;MAClD,IAAAK,OAAA,CAAQH,KAAK,KAAKA,KAAM,CAAAI,MAAA,EAAiBR,QAAA,CAAAS,MAAA,CAAON,GAAK,KAAGC,KAAK,OACnDJ,QAAA,CAAAS,MAAA,CAAON,GAAA,EAAKC,KAAK;IAAA;EACjC;EAEFJ,QAAA,CAASS,MAAA,CAAO/B,MAAO,CAAAgC,QAAA,EAAUhC,MAAA,CAAOiC,IAAM,EAAAjC,MAAA,CAAOiC,IAAA,CAAKpC,IAAI;EAE1DI,GAAA,CAAAc,gBAAA,CAAiB,SAAS,MAAM;IAClCf,MAAA,CAAOkC,OAAQ,CAAApC,QAAA,CAASC,MAAQ,EAAAC,MAAA,EAAQC,GAAG,CAAC;EAAA,CAC7C;EAEGA,GAAA,CAAAc,gBAAA,CAAiB,QAAQ,MAAM;IACjC,IAAId,GAAI,CAAAP,MAAA,GAAS,GAAO,IAAAO,GAAA,CAAIP,MAAA,IAAU,GAAK;MACzC,OAAOM,MAAA,CAAOkC,OAAQ,CAAApC,QAAA,CAASC,MAAQ,EAAAC,MAAA,EAAQC,GAAG,CAAC;IAAA;IAE9CD,MAAA,CAAAmC,SAAA,CAAU7B,OAAQ,CAAAL,GAAG,CAAC;EAAA,CAC9B;EAEDA,GAAA,CAAImC,IAAK,CAAApC,MAAA,CAAOL,MAAQ,EAAAI,MAAA,EAAQ,IAAI;EAEhC,IAAAC,MAAA,CAAOqC,eAAmB,yBAAqBpC,GAAK;IACtDA,GAAA,CAAIoC,eAAkB;EAAA;EAGlB,MAAAC,OAAA,GAAUtC,MAAO,CAAAsC,OAAA,IAAW,EAAC;EACnC,IAAIA,OAAA,YAAmBC,OAAS;IACtBD,OAAA,CAAAE,OAAA,CAAQ,CAACd,KAAO,EAAAD,GAAA,KAAQxB,GAAA,CAAIwC,gBAAiB,CAAAhB,GAAA,EAAKC,KAAK,CAAC;EAAA,CAC3D;IACL,WAAW,CAACD,GAAK,EAAAC,KAAK,KAAKC,MAAO,CAAAC,OAAA,CAAQU,OAAO,CAAG;MAClD,IAAII,KAAA,CAAMhB,KAAK,GAAG;MAClBzB,GAAA,CAAIwC,gBAAiB,CAAAhB,GAAA,EAAKkB,MAAO,CAAAjB,KAAK,CAAC;IAAA;EACzC;EAGFzB,GAAA,CAAI2C,IAAA,CAAKtB,QAAQ;EACV,OAAArB,GAAA;AACT","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}