{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport { computed, ref } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { UploadFilled } from '@element-plus/icons-vue';\nimport axios from 'axios';\nexport default {\n  name: 'UploadDialog',\n  components: {\n    UploadFilled\n  },\n  setup(_, {\n    emit\n  }) {\n    const store = useStore();\n    const uploadRef = ref(null);\n    const fileList = ref([]);\n    const uploading = ref(false);\n    const visible = computed({\n      get: () => store.state.showUploadDialog,\n      set: val => store.commit('SHOW_UPLOAD_DIALOG', val)\n    });\n    const beforeUpload = file => {\n      const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');\n      const isLt50M = file.size / 1024 / 1024 < 50;\n      if (!isPDF) {\n        ElMessage.error('只能上传PDF文件!');\n        return false;\n      }\n      if (!isLt50M) {\n        ElMessage.error('文件大小不能超过50MB!');\n        return false;\n      }\n      return true;\n    };\n    const customUpload = async options => {\n      // 这个函数不会被直接调用，因为我们使用批量上传\n      console.log('customUpload', options);\n    };\n    const submitUpload = async () => {\n      if (fileList.value.length === 0) {\n        ElMessage.warning('请先选择要上传的文件');\n        return;\n      }\n      uploading.value = true;\n      try {\n        const formData = new FormData();\n\n        // 添加所有文件到FormData\n        fileList.value.forEach(file => {\n          formData.append('files', file.raw);\n        });\n        console.log(`[DEBUG] 开始批量上传 ${fileList.value.length} 个文件`);\n        const response = await axios.post('/api/upload/batch', formData, {\n          headers: {\n            'Content-Type': 'multipart/form-data'\n          },\n          timeout: 300000 // 5分钟超时\n        });\n        console.log('[DEBUG] 批量上传响应:', response.data);\n        if (response.data.success) {\n          const result = response.data.data;\n          const successCount = result.success?.length || 0;\n          const failCount = result.failed?.length || 0;\n          if (successCount > 0) {\n            ElMessage.success({\n              message: `成功上传 ${successCount} 个文件${failCount > 0 ? `，${failCount}个失败` : ''}`,\n              duration: 5000,\n              showClose: true\n            });\n\n            // 通知父组件刷新文件列表\n            emit('uploaded', result.success);\n          }\n          if (failCount > 0) {\n            const failNames = result.failed.map(f => f.filename).join(', ');\n            ElMessage.error({\n              message: `以下文件上传失败: ${failNames}`,\n              duration: 8000,\n              showClose: true\n            });\n          }\n\n          // 清空文件列表\n          fileList.value = [];\n          visible.value = false;\n        } else {\n          ElMessage.error({\n            message: response.data.error || '上传失败',\n            duration: 5000,\n            showClose: true\n          });\n        }\n      } catch (error) {\n        console.error('[ERROR] 批量上传失败:', error);\n        let errorMsg = '上传失败';\n        if (error.response?.data?.error) {\n          errorMsg = error.response.data.error;\n        } else if (error.message) {\n          errorMsg = error.message;\n        }\n        ElMessage.error({\n          message: errorMsg,\n          duration: 5000,\n          showClose: true\n        });\n      } finally {\n        uploading.value = false;\n      }\n    };\n    const handleSuccess = (response, file) => {\n      // 批量上传不使用这个方法\n      console.log('handleSuccess', response, file);\n    };\n    const handleError = error => {\n      console.error('上传错误:', error);\n      let errorMsg = '上传失败';\n      if (error.message) {\n        if (error.message.includes('403') || error.message.includes('CORS')) {\n          errorMsg = '权限错误：请检查后端CORS配置';\n        } else if (error.message.includes('Network Error')) {\n          errorMsg = '网络错误：请检查后端服务是否启动（端口5001）';\n        } else if (error.message.includes('timeout')) {\n          errorMsg = '上传超时：文件可能过大，请尝试更小的文件';\n        } else if (error.message.includes('413')) {\n          errorMsg = '文件过大：单个文件不能超过50MB';\n        } else {\n          errorMsg = `上传失败: ${error.message}`;\n        }\n      }\n      ElMessage.error({\n        message: errorMsg,\n        duration: 5000,\n        showClose: true\n      });\n    };\n    return {\n      visible,\n      uploadRef,\n      fileList,\n      uploading,\n      beforeUpload,\n      customUpload,\n      submitUpload,\n      handleSuccess,\n      handleError\n    };\n  }\n};","map":{"version":3,"names":["computed","ref","useStore","ElMessage","UploadFilled","axios","name","components","setup","_","emit","store","uploadRef","fileList","uploading","visible","get","state","showUploadDialog","set","val","commit","beforeUpload","file","isPDF","type","toLowerCase","endsWith","isLt50M","size","error","customUpload","options","console","log","submitUpload","value","length","warning","formData","FormData","forEach","append","raw","response","post","headers","timeout","data","success","result","successCount","failCount","failed","message","duration","showClose","failNames","map","f","filename","join","errorMsg","handleSuccess","handleError","includes"],"sources":["/Users/liucunyu/Documents/all_code/NUC_graduation_project/frontend/src/components/UploadDialog.vue"],"sourcesContent":["<template>\n  <el-dialog\n    v-model=\"visible\"\n    title=\"上传PDF论文\"\n    width=\"550px\"\n    :close-on-click-modal=\"false\"\n  >\n    <el-upload\n      ref=\"uploadRef\"\n      class=\"upload-demo\"\n      drag\n      action=\"/api/upload/batch\"\n      :on-success=\"handleSuccess\"\n      :on-error=\"handleError\"\n      :before-upload=\"beforeUpload\"\n      :http-request=\"customUpload\"\n      :file-list=\"fileList\"\n      accept=\".pdf\"\n      :limit=\"10\"\n      multiple\n      :auto-upload=\"false\"\n    >\n      <el-icon :size=\"67\" color=\"#409eff\"><Upload-filled /></el-icon>\n      <div class=\"el-upload__text\">\n        将PDF文件拖到此处，或<em>点击上传</em>\n      </div>\n      <template #tip>\n        <div class=\"el-upload__tip\">\n          只支持PDF格式，单个文件不超过50MB，最多同时上传10个文件\n        </div>\n      </template>\n    </el-upload>\n\n    <template #footer>\n      <div class=\"dialog-footer\">\n        <el-button @click=\"visible = false\">关闭</el-button>\n        <el-button\n          type=\"primary\"\n          @click=\"submitUpload\"\n          :loading=\"uploading\"\n          :disabled=\"fileList.length === 0\"\n        >\n          开始上传 ({{ fileList.length }}个文件)\n        </el-button>\n      </div>\n    </template>\n  </el-dialog>\n</template>\n\n<script>\nimport { computed, ref } from 'vue'\nimport { useStore } from 'vuex'\nimport { ElMessage } from 'element-plus'\nimport { UploadFilled } from '@element-plus/icons-vue'\nimport axios from 'axios'\n\nexport default {\n  name: 'UploadDialog',\n  components: {\n    UploadFilled\n  },\n  setup(_, { emit }) {\n    const store = useStore()\n    const uploadRef = ref(null)\n    const fileList = ref([])\n    const uploading = ref(false)\n\n    const visible = computed({\n      get: () => store.state.showUploadDialog,\n      set: (val) => store.commit('SHOW_UPLOAD_DIALOG', val)\n    })\n\n    const beforeUpload = (file) => {\n      const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')\n      const isLt50M = file.size / 1024 / 1024 < 50\n\n      if (!isPDF) {\n        ElMessage.error('只能上传PDF文件!')\n        return false\n      }\n      if (!isLt50M) {\n        ElMessage.error('文件大小不能超过50MB!')\n        return false\n      }\n      return true\n    }\n\n    const customUpload = async (options) => {\n      // 这个函数不会被直接调用，因为我们使用批量上传\n      console.log('customUpload', options)\n    }\n\n    const submitUpload = async () => {\n      if (fileList.value.length === 0) {\n        ElMessage.warning('请先选择要上传的文件')\n        return\n      }\n\n      uploading.value = true\n\n      try {\n        const formData = new FormData()\n\n        // 添加所有文件到FormData\n        fileList.value.forEach((file) => {\n          formData.append('files', file.raw)\n        })\n\n        console.log(`[DEBUG] 开始批量上传 ${fileList.value.length} 个文件`)\n\n        const response = await axios.post('/api/upload/batch', formData, {\n          headers: {\n            'Content-Type': 'multipart/form-data'\n          },\n          timeout: 300000 // 5分钟超时\n        })\n\n        console.log('[DEBUG] 批量上传响应:', response.data)\n\n        if (response.data.success) {\n          const result = response.data.data\n          const successCount = result.success?.length || 0\n          const failCount = result.failed?.length || 0\n\n          if (successCount > 0) {\n            ElMessage.success({\n              message: `成功上传 ${successCount} 个文件${failCount > 0 ? `，${failCount}个失败` : ''}`,\n              duration: 5000,\n              showClose: true\n            })\n\n            // 通知父组件刷新文件列表\n            emit('uploaded', result.success)\n          }\n\n          if (failCount > 0) {\n            const failNames = result.failed.map(f => f.filename).join(', ')\n            ElMessage.error({\n              message: `以下文件上传失败: ${failNames}`,\n              duration: 8000,\n              showClose: true\n            })\n          }\n\n          // 清空文件列表\n          fileList.value = []\n          visible.value = false\n        } else {\n          ElMessage.error({\n            message: response.data.error || '上传失败',\n            duration: 5000,\n            showClose: true\n          })\n        }\n      } catch (error) {\n        console.error('[ERROR] 批量上传失败:', error)\n\n        let errorMsg = '上传失败'\n        if (error.response?.data?.error) {\n          errorMsg = error.response.data.error\n        } else if (error.message) {\n          errorMsg = error.message\n        }\n\n        ElMessage.error({\n          message: errorMsg,\n          duration: 5000,\n          showClose: true\n        })\n      } finally {\n        uploading.value = false\n      }\n    }\n\n    const handleSuccess = (response, file) => {\n      // 批量上传不使用这个方法\n      console.log('handleSuccess', response, file)\n    }\n\n    const handleError = (error) => {\n      console.error('上传错误:', error)\n\n      let errorMsg = '上传失败'\n\n      if (error.message) {\n        if (error.message.includes('403') || error.message.includes('CORS')) {\n          errorMsg = '权限错误：请检查后端CORS配置'\n        } else if (error.message.includes('Network Error')) {\n          errorMsg = '网络错误：请检查后端服务是否启动（端口5001）'\n        } else if (error.message.includes('timeout')) {\n          errorMsg = '上传超时：文件可能过大，请尝试更小的文件'\n        } else if (error.message.includes('413')) {\n          errorMsg = '文件过大：单个文件不能超过50MB'\n        } else {\n          errorMsg = `上传失败: ${error.message}`\n        }\n      }\n\n      ElMessage.error({\n        message: errorMsg,\n        duration: 5000,\n        showClose: true\n      })\n    }\n\n    return {\n      visible,\n      uploadRef,\n      fileList,\n      uploading,\n      beforeUpload,\n      customUpload,\n      submitUpload,\n      handleSuccess,\n      handleError\n    }\n  }\n}\n</script>\n\n<style scoped>\n.upload-demo {\n  text-align: center;\n}\n\n.el-icon-upload {\n  font-size: 67px;\n  color: #409eff;\n  margin: 20px 0;\n}\n\n.el-upload__text {\n  font-size: 14px;\n  color: #606266;\n}\n\n.el-upload__text em {\n  color: #409eff;\n  font-style: normal;\n}\n\n.dialog-footer {\n  display: flex;\n  justify-content: flex-end;\n  gap: 10px;\n}\n</style>\n"],"mappings":";;;AAkDA,SAASA,QAAQ,EAAEC,GAAE,QAAS,KAAI;AAClC,SAASC,QAAO,QAAS,MAAK;AAC9B,SAASC,SAAQ,QAAS,cAAa;AACvC,SAASC,YAAW,QAAS,yBAAwB;AACrD,OAAOC,KAAI,MAAO,OAAM;AAExB,eAAe;EACbC,IAAI,EAAE,cAAc;EACpBC,UAAU,EAAE;IACVH;EACF,CAAC;EACDI,KAAKA,CAACC,CAAC,EAAE;IAAEC;EAAK,CAAC,EAAE;IACjB,MAAMC,KAAI,GAAIT,QAAQ,CAAC;IACvB,MAAMU,SAAQ,GAAIX,GAAG,CAAC,IAAI;IAC1B,MAAMY,QAAO,GAAIZ,GAAG,CAAC,EAAE;IACvB,MAAMa,SAAQ,GAAIb,GAAG,CAAC,KAAK;IAE3B,MAAMc,OAAM,GAAIf,QAAQ,CAAC;MACvBgB,GAAG,EAAEA,CAAA,KAAML,KAAK,CAACM,KAAK,CAACC,gBAAgB;MACvCC,GAAG,EAAGC,GAAG,IAAKT,KAAK,CAACU,MAAM,CAAC,oBAAoB,EAAED,GAAG;IACtD,CAAC;IAED,MAAME,YAAW,GAAKC,IAAI,IAAK;MAC7B,MAAMC,KAAI,GAAID,IAAI,CAACE,IAAG,KAAM,iBAAgB,IAAKF,IAAI,CAACjB,IAAI,CAACoB,WAAW,CAAC,CAAC,CAACC,QAAQ,CAAC,MAAM;MACxF,MAAMC,OAAM,GAAIL,IAAI,CAACM,IAAG,GAAI,IAAG,GAAI,IAAG,GAAI,EAAC;MAE3C,IAAI,CAACL,KAAK,EAAE;QACVrB,SAAS,CAAC2B,KAAK,CAAC,YAAY;QAC5B,OAAO,KAAI;MACb;MACA,IAAI,CAACF,OAAO,EAAE;QACZzB,SAAS,CAAC2B,KAAK,CAAC,eAAe;QAC/B,OAAO,KAAI;MACb;MACA,OAAO,IAAG;IACZ;IAEA,MAAMC,YAAW,GAAI,MAAOC,OAAO,IAAK;MACtC;MACAC,OAAO,CAACC,GAAG,CAAC,cAAc,EAAEF,OAAO;IACrC;IAEA,MAAMG,YAAW,GAAI,MAAAA,CAAA,KAAY;MAC/B,IAAItB,QAAQ,CAACuB,KAAK,CAACC,MAAK,KAAM,CAAC,EAAE;QAC/BlC,SAAS,CAACmC,OAAO,CAAC,YAAY;QAC9B;MACF;MAEAxB,SAAS,CAACsB,KAAI,GAAI,IAAG;MAErB,IAAI;QACF,MAAMG,QAAO,GAAI,IAAIC,QAAQ,CAAC;;QAE9B;QACA3B,QAAQ,CAACuB,KAAK,CAACK,OAAO,CAAElB,IAAI,IAAK;UAC/BgB,QAAQ,CAACG,MAAM,CAAC,OAAO,EAAEnB,IAAI,CAACoB,GAAG;QACnC,CAAC;QAEDV,OAAO,CAACC,GAAG,CAAC,kBAAkBrB,QAAQ,CAACuB,KAAK,CAACC,MAAM,MAAM;QAEzD,MAAMO,QAAO,GAAI,MAAMvC,KAAK,CAACwC,IAAI,CAAC,mBAAmB,EAAEN,QAAQ,EAAE;UAC/DO,OAAO,EAAE;YACP,cAAc,EAAE;UAClB,CAAC;UACDC,OAAO,EAAE,MAAK,CAAE;QAClB,CAAC;QAEDd,OAAO,CAACC,GAAG,CAAC,iBAAiB,EAAEU,QAAQ,CAACI,IAAI;QAE5C,IAAIJ,QAAQ,CAACI,IAAI,CAACC,OAAO,EAAE;UACzB,MAAMC,MAAK,GAAIN,QAAQ,CAACI,IAAI,CAACA,IAAG;UAChC,MAAMG,YAAW,GAAID,MAAM,CAACD,OAAO,EAAEZ,MAAK,IAAK;UAC/C,MAAMe,SAAQ,GAAIF,MAAM,CAACG,MAAM,EAAEhB,MAAK,IAAK;UAE3C,IAAIc,YAAW,GAAI,CAAC,EAAE;YACpBhD,SAAS,CAAC8C,OAAO,CAAC;cAChBK,OAAO,EAAE,QAAQH,YAAY,OAAOC,SAAQ,GAAI,IAAI,IAAIA,SAAS,KAAI,GAAI,EAAE,EAAE;cAC7EG,QAAQ,EAAE,IAAI;cACdC,SAAS,EAAE;YACb,CAAC;;YAED;YACA9C,IAAI,CAAC,UAAU,EAAEwC,MAAM,CAACD,OAAO;UACjC;UAEA,IAAIG,SAAQ,GAAI,CAAC,EAAE;YACjB,MAAMK,SAAQ,GAAIP,MAAM,CAACG,MAAM,CAACK,GAAG,CAACC,CAAA,IAAKA,CAAC,CAACC,QAAQ,CAAC,CAACC,IAAI,CAAC,IAAI;YAC9D1D,SAAS,CAAC2B,KAAK,CAAC;cACdwB,OAAO,EAAE,aAAaG,SAAS,EAAE;cACjCF,QAAQ,EAAE,IAAI;cACdC,SAAS,EAAE;YACb,CAAC;UACH;;UAEA;UACA3C,QAAQ,CAACuB,KAAI,GAAI,EAAC;UAClBrB,OAAO,CAACqB,KAAI,GAAI,KAAI;QACtB,OAAO;UACLjC,SAAS,CAAC2B,KAAK,CAAC;YACdwB,OAAO,EAAEV,QAAQ,CAACI,IAAI,CAAClB,KAAI,IAAK,MAAM;YACtCyB,QAAQ,EAAE,IAAI;YACdC,SAAS,EAAE;UACb,CAAC;QACH;MACF,EAAE,OAAO1B,KAAK,EAAE;QACdG,OAAO,CAACH,KAAK,CAAC,iBAAiB,EAAEA,KAAK;QAEtC,IAAIgC,QAAO,GAAI,MAAK;QACpB,IAAIhC,KAAK,CAACc,QAAQ,EAAEI,IAAI,EAAElB,KAAK,EAAE;UAC/BgC,QAAO,GAAIhC,KAAK,CAACc,QAAQ,CAACI,IAAI,CAAClB,KAAI;QACrC,OAAO,IAAIA,KAAK,CAACwB,OAAO,EAAE;UACxBQ,QAAO,GAAIhC,KAAK,CAACwB,OAAM;QACzB;QAEAnD,SAAS,CAAC2B,KAAK,CAAC;UACdwB,OAAO,EAAEQ,QAAQ;UACjBP,QAAQ,EAAE,IAAI;UACdC,SAAS,EAAE;QACb,CAAC;MACH,UAAU;QACR1C,SAAS,CAACsB,KAAI,GAAI,KAAI;MACxB;IACF;IAEA,MAAM2B,aAAY,GAAIA,CAACnB,QAAQ,EAAErB,IAAI,KAAK;MACxC;MACAU,OAAO,CAACC,GAAG,CAAC,eAAe,EAAEU,QAAQ,EAAErB,IAAI;IAC7C;IAEA,MAAMyC,WAAU,GAAKlC,KAAK,IAAK;MAC7BG,OAAO,CAACH,KAAK,CAAC,OAAO,EAAEA,KAAK;MAE5B,IAAIgC,QAAO,GAAI,MAAK;MAEpB,IAAIhC,KAAK,CAACwB,OAAO,EAAE;QACjB,IAAIxB,KAAK,CAACwB,OAAO,CAACW,QAAQ,CAAC,KAAK,KAAKnC,KAAK,CAACwB,OAAO,CAACW,QAAQ,CAAC,MAAM,CAAC,EAAE;UACnEH,QAAO,GAAI,kBAAiB;QAC9B,OAAO,IAAIhC,KAAK,CAACwB,OAAO,CAACW,QAAQ,CAAC,eAAe,CAAC,EAAE;UAClDH,QAAO,GAAI,0BAAyB;QACtC,OAAO,IAAIhC,KAAK,CAACwB,OAAO,CAACW,QAAQ,CAAC,SAAS,CAAC,EAAE;UAC5CH,QAAO,GAAI,sBAAqB;QAClC,OAAO,IAAIhC,KAAK,CAACwB,OAAO,CAACW,QAAQ,CAAC,KAAK,CAAC,EAAE;UACxCH,QAAO,GAAI,mBAAkB;QAC/B,OAAO;UACLA,QAAO,GAAI,SAAShC,KAAK,CAACwB,OAAO,EAAC;QACpC;MACF;MAEAnD,SAAS,CAAC2B,KAAK,CAAC;QACdwB,OAAO,EAAEQ,QAAQ;QACjBP,QAAQ,EAAE,IAAI;QACdC,SAAS,EAAE;MACb,CAAC;IACH;IAEA,OAAO;MACLzC,OAAO;MACPH,SAAS;MACTC,QAAQ;MACRC,SAAS;MACTQ,YAAY;MACZS,YAAY;MACZI,YAAY;MACZ4B,aAAa;MACbC;IACF;EACF;AACF","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}