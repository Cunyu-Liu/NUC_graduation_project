{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.iterator.reduce.js\";\nimport \"core-js/modules/es.json.stringify.js\";\nimport \"core-js/modules/es.set.difference.v2.js\";\nimport \"core-js/modules/es.set.intersection.v2.js\";\nimport \"core-js/modules/es.set.is-disjoint-from.v2.js\";\nimport \"core-js/modules/es.set.is-subset-of.v2.js\";\nimport \"core-js/modules/es.set.is-superset-of.v2.js\";\nimport \"core-js/modules/es.set.symmetric-difference.v2.js\";\nimport \"core-js/modules/es.set.union.v2.js\";\nimport \"core-js/modules/esnext.json.parse.js\";\nimport \"core-js/modules/web.url-search-params.delete.js\";\nimport \"core-js/modules/web.url-search-params.has.js\";\nimport \"core-js/modules/web.url-search-params.size.js\";\nimport { ref, computed, onMounted } from 'vue';\nimport { useStore } from 'vuex';\nimport api, { connectSocket } from '@/api';\nimport { ElMessage } from 'element-plus';\nimport { DataAnalysis, Refresh, Star, Picture as PictureIcon, Document, Upload, Connection, Odometer } from '@element-plus/icons-vue';\nexport default {\n  name: 'Cluster',\n  components: {\n    DataAnalysis,\n    Refresh,\n    Star,\n    PictureIcon,\n    Document,\n    Upload,\n    Connection,\n    Odometer\n  },\n  setup() {\n    const store = useStore();\n    const files = computed(() => store.state.files);\n    const selectedFiles = ref([]);\n    const loading = ref(false);\n    const options = ref({\n      nClusters: 5,\n      method: 'kmeans',\n      language: 'chinese'\n    });\n    const clustering = ref(false);\n    const result = ref(null);\n    const activeClusters = ref(['0', '1', '2']);\n    const showVisualization = ref(false);\n    const vizCanvas = ref(null);\n\n    // 向量聚相关\n    const clusterMode = ref('traditional');\n    const vectorOptions = ref({\n      nClusters: 5\n    });\n    const vectorClustering = ref(false);\n    const syncing = ref(false);\n    const vectorStats = ref({\n      total_papers: 0,\n      dimension: 0,\n      connected: false,\n      collection_name: ''\n    });\n    const paperTable = ref(null);\n    const syncedPaperIds = ref(new Set());\n\n    // 测试相关\n    const testingConnection = ref(false);\n    const testingCluster = ref(false);\n    const showTestResult = ref(false);\n    const testResult = ref(null);\n\n    // 当前聚类结果ID\n    const currentResultId = ref(null);\n\n    // 聚类历史记录\n    const clusterHistory = ref([]);\n\n    // 从localStorage加载历史记录\n    const loadHistory = () => {\n      try {\n        const saved = localStorage.getItem('cluster_history');\n        if (saved) {\n          clusterHistory.value = JSON.parse(saved);\n        }\n      } catch (e) {\n        console.error('加载历史记录失败:', e);\n      }\n    };\n\n    // 保存历史记录到localStorage\n    const saveHistory = () => {\n      try {\n        localStorage.setItem('cluster_history', JSON.stringify(clusterHistory.value));\n      } catch (e) {\n        console.error('保存历史记录失败:', e);\n      }\n    };\n\n    // 格式化日期\n    const formatDate = dateStr => {\n      if (!dateStr) return '';\n      const date = new Date(dateStr);\n      return date.toLocaleString('zh-CN');\n    };\n\n    // 加载历史结果\n    const loadHistoryResult = historyItem => {\n      result.value = historyItem.data;\n      currentResultId.value = null; // 历史结果不需要再保存\n      activeClusters.value = Object.keys(historyItem.data.clusterAnalysis).slice(0, 3);\n      ElMessage.success('已加载历史聚类结果');\n    };\n\n    // 删除历史结果\n    const deleteHistoryResult = index => {\n      clusterHistory.value.splice(index, 1);\n      saveHistory();\n      ElMessage.success('已删除');\n    };\n\n    // 清空历史\n    const clearHistory = () => {\n      clusterHistory.value = [];\n      saveHistory();\n      ElMessage.success('历史记录已清空');\n    };\n\n    // 保存当前结果\n    const saveCurrentResult = () => {\n      if (!result.value) return;\n      const historyItem = {\n        id: Date.now().toString(),\n        createdAt: new Date().toISOString(),\n        clusterCount: result.value.clusterCount,\n        method: result.value.method,\n        paperCount: result.value.papers?.length || 0,\n        data: result.value\n      };\n      clusterHistory.value.unshift(historyItem);\n      saveHistory();\n      currentResultId.value = null; // 已保存，不需要再显示保存按钮\n      ElMessage.success('聚类结果已保存到历史记录');\n    };\n\n    // 检查论文是否在向量库中\n    const isPaperInVectorStore = paperId => {\n      return syncedPaperIds.value.has(paperId);\n    };\n\n    // 向量聚类方法\n    const loadVectorStats = async () => {\n      try {\n        const response = await api.getVectorStoreStats();\n        if (response.success) {\n          vectorStats.value = response.data;\n        }\n      } catch (error) {\n        console.error('加载向量统计失败:', error);\n      }\n    };\n\n    // 测试向量连接\n    const testVectorConnection = async () => {\n      testingConnection.value = true;\n      try {\n        const response = await api.getVectorStoreStats();\n        if (response.success) {\n          vectorStats.value = response.data;\n          ElMessage.success(`向量库连接正常，包含 ${response.data.total_papers} 篇论文`);\n        } else {\n          ElMessage.error('向量库连接失败: ' + (response.error || '未知错误'));\n        }\n      } catch (error) {\n        console.error('测试连接失败:', error);\n        ElMessage.error('向量库连接测试失败: ' + (error.message || '请检查Milvus服务'));\n      } finally {\n        testingConnection.value = false;\n      }\n    };\n\n    // 测试向量聚类\n    const testVectorCluster = async () => {\n      testingCluster.value = true;\n      testResult.value = null;\n      try {\n        // 1. 首先检查向量库状态\n        const statsResponse = await api.getVectorStoreStats();\n        if (!statsResponse.success) {\n          testResult.value = {\n            success: false,\n            connected: false,\n            error: '无法连接到向量库: ' + (statsResponse.error || '未知错误')\n          };\n          showTestResult.value = true;\n          return;\n        }\n        const stats = statsResponse.data;\n        if (stats.total_papers < 2) {\n          testResult.value = {\n            success: false,\n            connected: true,\n            collection_name: stats.collection_name,\n            dimension: stats.dimension,\n            total_papers: stats.total_papers,\n            error: '向量库中论文数量不足，无法进行聚类测试。请先同步论文到向量库。'\n          };\n          showTestResult.value = true;\n          return;\n        }\n\n        // 2. 尝试进行聚类测试\n        const testClusterCount = Math.min(3, stats.total_papers);\n        ElMessage.info(`正在进行聚类测试，使用 ${stats.total_papers} 篇论文...`);\n        const clusterResponse = await api.clusterPapersVector(testClusterCount);\n        if (clusterResponse.success) {\n          testResult.value = {\n            success: true,\n            connected: true,\n            collection_name: stats.collection_name,\n            dimension: stats.dimension,\n            total_papers: stats.total_papers,\n            available_papers: clusterResponse.data.total_papers || stats.total_papers,\n            test_cluster: clusterResponse.data,\n            message: '向量聚类测试成功！向量库工作正常。'\n          };\n          ElMessage.success('向量聚类测试成功');\n        } else {\n          testResult.value = {\n            success: false,\n            connected: true,\n            collection_name: stats.collection_name,\n            dimension: stats.dimension,\n            total_papers: stats.total_papers,\n            error: '聚类测试失败: ' + (clusterResponse.error || '未知错误')\n          };\n        }\n      } catch (error) {\n        console.error('聚类测试失败:', error);\n        testResult.value = {\n          success: false,\n          connected: false,\n          error: '聚类测试异常: ' + (error.message || '请检查Milvus服务是否正常运行')\n        };\n      } finally {\n        testingCluster.value = false;\n        showTestResult.value = true;\n      }\n    };\n    const syncToVectorStore = async () => {\n      if (selectedFiles.value.length === 0) {\n        ElMessage.warning('请先选择要同步的论文');\n        return;\n      }\n      syncing.value = true;\n      try {\n        const paperIds = selectedFiles.value.map(f => f.id);\n        const response = await api.syncPapersToVectorStore(paperIds);\n        if (response.success) {\n          ElMessage.success(`同步完成: ${response.data.synced} 成功, ${response.data.failed} 失败`);\n          // 更新已同步论文集合\n          paperIds.forEach(id => syncedPaperIds.value.add(id));\n          await loadVectorStats();\n        } else {\n          ElMessage.error(response.error || '同步失败');\n        }\n      } catch (error) {\n        console.error('同步失败:', error);\n        ElMessage.error('同步到向量库失败');\n      } finally {\n        syncing.value = false;\n      }\n    };\n    const startVectorCluster = async () => {\n      if (selectedFiles.value.length < 2) {\n        ElMessage.warning('请至少选择2篇论文');\n        return;\n      }\n      vectorClustering.value = true;\n      try {\n        const paperIds = selectedFiles.value.map(f => f.id);\n        const response = await api.clusterPapersVector(vectorOptions.value.nClusters, paperIds);\n        if (response.success) {\n          result.value = {\n            clusterCount: response.data.n_clusters,\n            clusterAnalysis: response.data.cluster_analysis,\n            papers: [],\n            method: 'kmeans_vector',\n            createdAt: new Date().toISOString(),\n            inertia: response.data.inertia\n          };\n          currentResultId.value = Date.now().toString();\n          ElMessage.success(`向量聚类完成! 共发现 ${response.data.n_clusters} 个主题类别`);\n          const clusterIds = Object.keys(response.data.cluster_analysis);\n          activeClusters.value = clusterIds.slice(0, 3);\n          saveCurrentResult();\n        } else {\n          ElMessage.error(response.error || '向量聚类失败');\n        }\n      } catch (error) {\n        console.error('[ERROR] 向量聚类错误:', error);\n        ElMessage.error('向量聚类失败: ' + (error.response?.data?.error || error.message));\n      } finally {\n        vectorClustering.value = false;\n      }\n    };\n    const handleSelectionChange = selection => {\n      selectedFiles.value = selection;\n    };\n    const refreshFiles = async () => {\n      loading.value = true;\n      try {\n        await store.dispatch('fetchFiles');\n        ElMessage.success('论文列表已刷新');\n      } catch (error) {\n        console.error('刷新失败:', error);\n        ElMessage.error('刷新失败');\n      } finally {\n        loading.value = false;\n      }\n    };\n    const startCluster = async () => {\n      if (selectedFiles.value.length < 2) {\n        ElMessage.warning('请至少选择2篇论文');\n        return;\n      }\n\n      // 验证聚类数量\n      const maxClusters = Math.min(20, selectedFiles.value.length);\n      if (options.value.method !== 'dbscan' && (options.value.nClusters < 2 || options.value.nClusters > maxClusters)) {\n        ElMessage.warning(`聚类数量必须在 2 到 ${maxClusters} 之间`);\n        return;\n      }\n\n      // 连接WebSocket\n      connectSocket();\n      store.commit('SHOW_PROGRESS_DIALOG', true);\n      store.commit('SET_PROGRESS', {\n        progress: 0,\n        message: '开始聚类分析...',\n        step: ''\n      });\n      clustering.value = true;\n      try {\n        // 使用论文ID而不是文件路径\n        const paperIds = selectedFiles.value.map(f => f.id);\n        console.log('[DEBUG] 开始聚类, paper_ids:', paperIds);\n        console.log('[DEBUG] 聚类选项:', options.value);\n        const response = await api.clusterPapers(paperIds, options.value.nClusters, options.value.method, options.value.language);\n        console.log('[DEBUG] 聚类响应:', response);\n        if (response.success) {\n          // 格式化结果\n          result.value = {\n            clusterCount: response.data.n_clusters,\n            clusterAnalysis: response.data.cluster_analysis,\n            papers: response.data.papers || [],\n            method: options.value.method,\n            createdAt: new Date().toISOString()\n          };\n\n          // 生成新的结果ID\n          currentResultId.value = Date.now().toString();\n          store.commit('SET_PROGRESS', {\n            progress: 100,\n            message: '聚类完成!'\n          });\n          ElMessage.success(`聚类分析完成! 共发现 ${response.data.n_clusters} 个主题类别`);\n\n          // 自动展开前3个聚类\n          const clusterIds = Object.keys(response.data.cluster_analysis);\n          activeClusters.value = clusterIds.slice(0, 3);\n\n          // 自动保存到历史记录\n          saveCurrentResult();\n        } else {\n          ElMessage.error({\n            message: response.error || '聚类失败',\n            duration: 5000,\n            showClose: true\n          });\n        }\n      } catch (error) {\n        console.error('[ERROR] 聚类错误:', error);\n\n        // 提供更详细的错误提示\n        let errorMsg = '聚类失败';\n        const errorDetail = error.response?.data?.error || error.message;\n        if (errorDetail) {\n          if (errorDetail.includes('论文') || errorDetail.includes('PDF')) {\n            errorMsg = '论文加载或解析失败，请检查文件是否完整';\n          } else if (errorDetail.includes('聚类') || errorDetail.includes('算法')) {\n            errorMsg = '聚类算法执行失败，请尝试调整参数';\n          } else if (errorDetail.includes('数量') || errorDetail.includes('不足')) {\n            errorMsg = '可用论文数量不足，无法进行聚类';\n          } else if (errorDetail.includes('timeout') || errorDetail.includes('超时')) {\n            errorMsg = '聚类超时，请减少论文数量或降低聚类数量';\n          } else {\n            errorMsg = `聚类失败: ${errorDetail}`;\n          }\n        } else if (error.message) {\n          errorMsg = `聚类失败: ${error.message}`;\n        }\n        ElMessage.error({\n          message: errorMsg,\n          duration: 5000,\n          showClose: true\n        });\n      } finally {\n        clustering.value = false;\n        store.commit('SHOW_PROGRESS_DIALOG', false);\n      }\n    };\n    const downloadVisualization = () => {\n      showVisualization.value = true;\n      // 在对话框打开后绘制可视化\n      setTimeout(() => {\n        drawVisualization();\n      }, 100);\n    };\n    const drawVisualization = () => {\n      const canvas = vizCanvas.value;\n      if (!canvas) return;\n\n      // 设置高分辨率画布\n      const dpr = window.devicePixelRatio || 1;\n      const width = window.innerWidth * 0.85;\n      const height = window.innerHeight * 0.75;\n      canvas.width = width * dpr;\n      canvas.height = height * dpr;\n      canvas.style.width = width + 'px';\n      canvas.style.height = height + 'px';\n      const ctx = canvas.getContext('2d');\n      ctx.scale(dpr, dpr);\n\n      // 背景\n      ctx.fillStyle = '#f8f9fa';\n      ctx.fillRect(0, 0, width, height);\n\n      // 标题\n      ctx.fillStyle = '#333';\n      ctx.font = 'bold 28px Arial';\n      ctx.textAlign = 'center';\n      ctx.fillText('论文主题聚类可视化', width / 2, 50);\n      if (!result.value || !result.value.clusterAnalysis) {\n        return;\n      }\n\n      // 绘制聚类圆形图\n      const clusters = Object.entries(result.value.clusterAnalysis);\n      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#6C5CE7'];\n      const centerX = width / 2;\n      const centerY = height / 2 + 30;\n      const maxRadius = Math.min(width, height) * 0.35;\n\n      // 计算总论文数\n      const totalPapers = clusters.reduce((sum, [, info]) => sum + (info.paper_count || 0), 0);\n\n      // 绘制聚类圆圈\n      let currentAngle = 0;\n      clusters.forEach(([clusterId, info], index) => {\n        const color = colors[index % colors.length];\n        const ratio = (info.paper_count || 0) / Math.max(totalPapers, 1);\n        const angle = ratio * Math.PI * 2;\n\n        // 绘制扇形\n        ctx.beginPath();\n        ctx.moveTo(centerX, centerY);\n        ctx.arc(centerX, centerY, maxRadius, currentAngle, currentAngle + angle);\n        ctx.closePath();\n        ctx.fillStyle = color + '40'; // 添加透明度\n        ctx.fill();\n        ctx.strokeStyle = color;\n        ctx.lineWidth = 3;\n        ctx.stroke();\n\n        // 绘制标签\n        const labelAngle = currentAngle + angle / 2;\n        const labelRadius = maxRadius + 40;\n        const labelX = centerX + Math.cos(labelAngle) * labelRadius;\n        const labelY = centerY + Math.sin(labelAngle) * labelRadius;\n        ctx.fillStyle = color;\n        ctx.font = 'bold 16px Arial';\n        ctx.textAlign = 'center';\n        ctx.fillText(`聚类 ${parseInt(clusterId) + 1}`, labelX, labelY - 10);\n        ctx.font = '14px Arial';\n        ctx.fillStyle = '#666';\n        ctx.fillText(`${info.paper_count || 0}篇`, labelX, labelY + 10);\n        currentAngle += angle;\n      });\n\n      // 中心圆\n      ctx.beginPath();\n      ctx.arc(centerX, centerY, maxRadius * 0.3, 0, Math.PI * 2);\n      ctx.fillStyle = 'white';\n      ctx.fill();\n      ctx.strokeStyle = '#ddd';\n      ctx.lineWidth = 2;\n      ctx.stroke();\n\n      // 中心文字\n      ctx.fillStyle = '#333';\n      ctx.font = 'bold 20px Arial';\n      ctx.textAlign = 'center';\n      ctx.fillText(`${clusters.length}`, centerX, centerY - 5);\n      ctx.font = '14px Arial';\n      ctx.fillStyle = '#666';\n      ctx.fillText('个聚类', centerX, centerY + 15);\n\n      // 绘制图例\n      let legendY = height - 100;\n      const legendX = width / 2 - clusters.length * 150 / 2;\n      clusters.forEach(([clusterId, info], index) => {\n        const color = colors[index % colors.length];\n        const x = legendX + index % 5 * 150;\n        const y = legendY + Math.floor(index / 5) * 40;\n        ctx.fillStyle = color;\n        ctx.fillRect(x, y, 20, 20);\n        ctx.fillStyle = '#333';\n        ctx.font = '12px Arial';\n        ctx.textAlign = 'left';\n        const keywords = info.top_keywords?.slice(0, 2).join(', ') || '无关键词';\n        ctx.fillText(`聚类${parseInt(clusterId) + 1}: ${keywords}`, x + 30, y + 15);\n      });\n    };\n    const downloadHighResVisualization = () => {\n      const canvas = vizCanvas.value;\n      if (!canvas) return;\n\n      // 创建高分辨率下载\n      const link = document.createElement('a');\n      link.download = `cluster_visualization_${Date.now()}_highres.png`;\n      link.href = canvas.toDataURL('image/png', 1.0);\n      link.click();\n      ElMessage.success('高清可视化图下载成功');\n    };\n    const downloadReport = async () => {\n      if (!result.value) {\n        ElMessage.warning('没有可导出的聚类结果');\n        return;\n      }\n      try {\n        // 生成报告内容\n        let content = '论文主题聚类分析报告\\n';\n        content += '='.repeat(80) + '\\n\\n';\n        content += `生成时间: ${formatDate(result.value.createdAt)}\\n`;\n        content += `聚类方法: ${result.value.method || 'K-Means'}\\n`;\n        content += `聚类数量: ${result.value.clusterCount}\\n`;\n        content += `论文总数: ${result.value.papers?.length || 0}\\n\\n`;\n\n        // 每个聚类的详细信息\n        Object.entries(result.value.clusterAnalysis).forEach(([clusterId, info], index) => {\n          content += `\\n${'='.repeat(80)}\\n`;\n          content += `聚类 ${parseInt(clusterId) + 1}\\n`;\n          content += `${'-'.repeat(40)}\\n`;\n          content += `论文数: ${info.paper_count || 0}\\n`;\n          content += `关键词: ${info.top_keywords?.join(', ') || '无'}\\n\\n`;\n          if (info.papers && info.papers.length > 0) {\n            content += '包含论文:\\n';\n            info.papers.forEach((paper, i) => {\n              content += `  ${i + 1}. ${paper}\\n`;\n            });\n          }\n          if (info.representative_papers && info.representative_papers.length > 0) {\n            content += '\\n代表性论文:\\n';\n            info.representative_papers.forEach((paper, i) => {\n              content += `  ${i + 1}. ${paper.title || '无标题'}\\n`;\n              if (paper.abstract) {\n                content += `     摘要: ${paper.abstract}\\n`;\n              }\n            });\n          }\n        });\n        content += `\\n${'='.repeat(80)}\\n`;\n        content += '报告结束\\n';\n\n        // 下载文件\n        const blob = new Blob([content], {\n          type: 'text/markdown;charset=utf-8'\n        });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `cluster_report_${Date.now()}.md`;\n        a.click();\n        URL.revokeObjectURL(url);\n        ElMessage.success('聚类报告下载成功');\n      } catch (error) {\n        console.error('[ERROR] 导出报告失败:', error);\n        ElMessage.error('导出报告失败');\n      }\n    };\n    onMounted(() => {\n      store.dispatch('fetchFiles');\n      loadHistory();\n      loadVectorStats();\n    });\n    return {\n      files,\n      selectedFiles,\n      loading,\n      options,\n      clustering,\n      result,\n      activeClusters,\n      currentResultId,\n      clusterHistory,\n      showVisualization,\n      vizCanvas,\n      clusterMode,\n      vectorOptions,\n      vectorClustering,\n      syncing,\n      vectorStats,\n      testingConnection,\n      testingCluster,\n      showTestResult,\n      testResult,\n      paperTable,\n      handleSelectionChange,\n      refreshFiles,\n      formatDate,\n      startCluster,\n      downloadVisualization,\n      drawVisualization,\n      downloadHighResVisualization,\n      downloadReport,\n      saveCurrentResult,\n      loadHistoryResult,\n      deleteHistoryResult,\n      clearHistory,\n      syncToVectorStore,\n      startVectorCluster,\n      testVectorConnection,\n      testVectorCluster,\n      isPaperInVectorStore\n    };\n  }\n};","map":{"version":3,"names":["ref","computed","onMounted","useStore","api","connectSocket","ElMessage","DataAnalysis","Refresh","Star","Picture","PictureIcon","Document","Upload","Connection","Odometer","name","components","setup","store","files","state","selectedFiles","loading","options","nClusters","method","language","clustering","result","activeClusters","showVisualization","vizCanvas","clusterMode","vectorOptions","vectorClustering","syncing","vectorStats","total_papers","dimension","connected","collection_name","paperTable","syncedPaperIds","Set","testingConnection","testingCluster","showTestResult","testResult","currentResultId","clusterHistory","loadHistory","saved","localStorage","getItem","value","JSON","parse","e","console","error","saveHistory","setItem","stringify","formatDate","dateStr","date","Date","toLocaleString","loadHistoryResult","historyItem","data","Object","keys","clusterAnalysis","slice","success","deleteHistoryResult","index","splice","clearHistory","saveCurrentResult","id","now","toString","createdAt","toISOString","clusterCount","paperCount","papers","length","unshift","isPaperInVectorStore","paperId","has","loadVectorStats","response","getVectorStoreStats","testVectorConnection","message","testVectorCluster","statsResponse","stats","testClusterCount","Math","min","info","clusterResponse","clusterPapersVector","available_papers","test_cluster","syncToVectorStore","warning","paperIds","map","f","syncPapersToVectorStore","synced","failed","forEach","add","startVectorCluster","n_clusters","cluster_analysis","inertia","clusterIds","handleSelectionChange","selection","refreshFiles","dispatch","startCluster","maxClusters","commit","progress","step","log","clusterPapers","duration","showClose","errorMsg","errorDetail","includes","downloadVisualization","setTimeout","drawVisualization","canvas","dpr","window","devicePixelRatio","width","innerWidth","height","innerHeight","style","ctx","getContext","scale","fillStyle","fillRect","font","textAlign","fillText","clusters","entries","colors","centerX","centerY","maxRadius","totalPapers","reduce","sum","paper_count","currentAngle","clusterId","color","ratio","max","angle","PI","beginPath","moveTo","arc","closePath","fill","strokeStyle","lineWidth","stroke","labelAngle","labelRadius","labelX","cos","labelY","sin","parseInt","legendY","legendX","x","y","floor","keywords","top_keywords","join","downloadHighResVisualization","link","document","createElement","download","href","toDataURL","click","downloadReport","content","repeat","paper","i","representative_papers","title","abstract","blob","Blob","type","url","URL","createObjectURL","a","revokeObjectURL"],"sources":["/Users/liucunyu/Documents/all_code/NUC_graduation_project/frontend/src/views/Cluster.vue"],"sourcesContent":["<template>\n  <div class=\"cluster\">\n    <h2>多篇论文主题聚类分析</h2>\n\n    <el-card class=\"select-card\">\n      <div class=\"select-header\">\n        <h3>选择要分析的论文（至少2篇）</h3>\n        <div class=\"header-actions\">\n          <el-button @click=\"refreshFiles\" size=\"small\">\n            <el-icon><Refresh /></el-icon>\n            刷新列表\n          </el-button>\n          <el-button type=\"success\" @click=\"testVectorConnection\" size=\"small\" :loading=\"testingConnection\">\n            <el-icon><Connection /></el-icon>\n            测试向量连接\n          </el-button>\n        </div>\n      </div>\n      <el-table\n        :data=\"files\"\n        style=\"width: 100%; margin-top: 20px\"\n        @selection-change=\"handleSelectionChange\"\n        v-loading=\"loading\"\n        ref=\"paperTable\"\n        row-key=\"id\"\n      >\n        <el-table-column type=\"selection\" width=\"55\" :reserve-selection=\"true\" />\n        <el-table-column prop=\"title\" label=\"论文标题\" min-width=\"250\">\n          <template #default=\"scope\">\n            {{ scope.row.title || '未命名论文' }}\n          </template>\n        </el-table-column>\n        <el-table-column prop=\"year\" label=\"年份\" width=\"80\">\n          <template #default=\"scope\">\n            {{ scope.row.year || '未知' }}\n          </template>\n        </el-table-column>\n        <el-table-column prop=\"venue\" label=\"期刊/会议\" min-width=\"150\" />\n        <el-table-column label=\"向量状态\" width=\"120\" align=\"center\">\n          <template #default=\"scope\">\n            <el-tag v-if=\"isPaperInVectorStore(scope.row.id)\" type=\"success\" size=\"small\">已同步</el-tag>\n            <el-tag v-else type=\"info\" size=\"small\">未同步</el-tag>\n          </template>\n        </el-table-column>\n      </el-table>\n    </el-card>\n\n    <el-card class=\"options-card\">\n      <h3>聚类选项</h3>\n      \n      <el-tabs v-model=\"clusterMode\">\n        <el-tab-pane label=\"传统聚类\" name=\"traditional\">\n          <el-form :model=\"options\" label-width=\"120px\">\n            <el-form-item label=\"聚类数量\">\n              <el-input-number v-model=\"options.nClusters\" :min=\"2\" :max=\"10\" />\n            </el-form-item>\n            <el-form-item label=\"聚类方法\">\n              <el-select v-model=\"options.method\">\n                <el-option label=\"K-Means\" value=\"kmeans\" />\n                <el-option label=\"DBSCAN\" value=\"dbscan\" />\n                <el-option label=\"层次聚类\" value=\"hierarchical\" />\n              </el-select>\n            </el-form-item>\n            <el-form-item label=\"论文语言\">\n              <el-select v-model=\"options.language\">\n                <el-option label=\"中文\" value=\"chinese\" />\n                <el-option label=\"英文\" value=\"english\" />\n              </el-select>\n            </el-form-item>\n          </el-form>\n\n          <el-button\n            type=\"primary\"\n            size=\"large\"\n            @click=\"startCluster\"\n            :disabled=\"selectedFiles.length < 2\"\n            :loading=\"clustering\"\n          >\n            <el-icon><DataAnalysis /></el-icon> 开始传统聚类分析\n          </el-button>\n        </el-tab-pane>\n        \n        <el-tab-pane label=\"向量聚类 (Milvus)\" name=\"vector\">\n          <div class=\"vector-cluster-info\">\n            <el-alert\n              title=\"基于向量嵌入的语义聚类\"\n              description=\"使用 Milvus 向量数据库和深度学习模型进行语义层面的论文聚类，能够捕捉论文间的深层语义关联。\"\n              type=\"info\"\n              :closable=\"false\"\n              show-icon\n            />\n          </div>\n          \n          <el-form :model=\"vectorOptions\" label-width=\"120px\" style=\"margin-top: 16px;\">\n            <el-form-item label=\"聚类数量\">\n              <el-input-number v-model=\"vectorOptions.nClusters\" :min=\"2\" :max=\"20\" />\n            </el-form-item>\n          </el-form>\n\n          <div class=\"vector-actions\">\n            <el-button\n              type=\"primary\"\n              size=\"large\"\n              @click=\"startVectorCluster\"\n              :disabled=\"selectedFiles.length < 2\"\n              :loading=\"vectorClustering\"\n            >\n              <el-icon><DataAnalysis /></el-icon> 开始向量聚类分析\n            </el-button>\n            \n            <el-button\n              size=\"large\"\n              @click=\"syncToVectorStore\"\n              :loading=\"syncing\"\n              :disabled=\"selectedFiles.length === 0\"\n            >\n              <el-icon><Upload /></el-icon> 同步选中论文到向量库\n            </el-button>\n            \n            <el-button\n              type=\"warning\"\n              size=\"large\"\n              @click=\"testVectorCluster\"\n              :loading=\"testingCluster\"\n            >\n              <el-icon><Odometer /></el-icon> 测试向量聚类\n            </el-button>\n          </div>\n          \n          <div v-if=\"vectorStats.total_papers > 0\" class=\"vector-stats\" style=\"margin-top: 16px;\">\n            <el-descriptions :column=\"2\" border size=\"small\">\n              <el-descriptions-item label=\"向量库论文数\">{{ vectorStats.total_papers }}</el-descriptions-item>\n              <el-descriptions-item label=\"向量维度\">{{ vectorStats.dimension }}</el-descriptions-item>\n              <el-descriptions-item label=\"集合名称\">{{ vectorStats.collection_name }}</el-descriptions-item>\n              <el-descriptions-item label=\"连接状态\">\n                <el-tag :type=\"vectorStats.connected ? 'success' : 'danger'\">\n                  {{ vectorStats.connected ? '已连接' : '未连接' }}\n                </el-tag>\n              </el-descriptions-item>\n            </el-descriptions>\n          </div>\n        </el-tab-pane>\n      </el-tabs>\n    </el-card>\n\n    <!-- 历史聚类结果 -->\n    <el-card class=\"history-card\" v-if=\"clusterHistory.length > 0\">\n      <div class=\"history-header\">\n        <h3>历史聚类结果</h3>\n        <el-button @click=\"clearHistory\" type=\"danger\" size=\"small\" plain>清空历史</el-button>\n      </div>\n      <el-table :data=\"clusterHistory\" style=\"width: 100%; margin-top: 10px\">\n        <el-table-column prop=\"createdAt\" label=\"时间\" width=\"180\">\n          <template #default=\"scope\">\n            {{ formatDate(scope.row.createdAt) }}\n          </template>\n        </el-table-column>\n        <el-table-column prop=\"clusterCount\" label=\"聚类数\" width=\"80\" />\n        <el-table-column prop=\"method\" label=\"方法\" width=\"120\" />\n        <el-table-column prop=\"paperCount\" label=\"论文数\" width=\"80\" />\n        <el-table-column label=\"操作\" width=\"200\">\n          <template #default=\"scope\">\n            <el-button type=\"primary\" size=\"small\" @click=\"loadHistoryResult(scope.row)\">查看</el-button>\n            <el-button type=\"danger\" size=\"small\" @click=\"deleteHistoryResult(scope.$index)\">删除</el-button>\n          </template>\n        </el-table-column>\n      </el-table>\n    </el-card>\n\n    <el-card class=\"result-card\" v-if=\"result\">\n      <div class=\"result-header\">\n        <h3>聚类结果</h3>\n        <div class=\"result-actions-top\">\n          <el-tag type=\"success\" size=\"large\" effect=\"dark\">\n            {{ result.clusterCount }} 个主题类别\n          </el-tag>\n          <el-button\n            v-if=\"currentResultId\"\n            type=\"warning\"\n            size=\"small\"\n            @click=\"saveCurrentResult\"\n          >\n            <el-icon><Star /></el-icon>\n            保存结果\n          </el-button>\n        </div>\n      </div>\n\n      <el-collapse v-model=\"activeClusters\">\n        <el-collapse-item\n          v-for=\"(cluster, index) in Object.entries(result.clusterAnalysis)\"\n          :key=\"cluster[0]\"\n          :name=\"cluster[0]\"\n        >\n          <template #title>\n            <div class=\"cluster-title\">\n              <span class=\"cluster-name\">聚类 {{ parseInt(cluster[0]) + 1 }}</span>\n              <el-tag type=\"success\" size=\"small\">\n                {{ cluster[1]?.paper_count || 0 }} 篇论文\n              </el-tag>\n              <el-tag\n                v-if=\"cluster[1]?.top_keywords?.length > 0\"\n                type=\"info\"\n                size=\"small\"\n                style=\"margin-left: 8px;\"\n              >\n                {{ cluster[1].top_keywords.slice(0, 3).join(', ') }}\n              </el-tag>\n            </div>\n          </template>\n\n          <div class=\"cluster-content\">\n            <h4>核心关键词</h4>\n            <el-space wrap v-if=\"cluster[1].top_keywords && cluster[1].top_keywords.length > 0\">\n              <el-tag\n                v-for=\"(keyword, kIndex) in cluster[1].top_keywords.slice(0, 10)\"\n                :key=\"kIndex\"\n                type=\"success\"\n                effect=\"dark\"\n              >\n                {{ keyword }}\n              </el-tag>\n            </el-space>\n            <el-empty v-else description=\"暂无关键词\" :image-size=\"60\" />\n\n            <h4 style=\"margin-top: 20px\">包含论文</h4>\n            <ul v-if=\"cluster[1].papers && cluster[1].papers.length > 0\" class=\"paper-list\">\n              <li v-for=\"(paper, pIndex) in cluster[1].papers\" :key=\"pIndex\">\n                {{ paper }}\n              </li>\n            </ul>\n            <el-empty v-else description=\"暂无论文\" :image-size=\"60\" />\n\n            <h4 style=\"margin-top: 20px\">代表性论文</h4>\n            <div\n              v-if=\"cluster[1].representative_papers && cluster[1].representative_papers.length > 0\"\n            >\n              <div\n                v-for=\"(rep, rIndex) in cluster[1].representative_papers\"\n                :key=\"rIndex\"\n                class=\"rep-paper\"\n              >\n                <p><strong>{{ rep.title || '无标题' }}</strong></p>\n                <p class=\"rep-abstract\">{{ rep.abstract || '无摘要' }}</p>\n              </div>\n            </div>\n            <el-empty v-else description=\"暂无代表性论文\" :image-size=\"60\" />\n          </div>\n        </el-collapse-item>\n      </el-collapse>\n\n      <div class=\"result-actions\">\n        <el-button type=\"primary\" @click=\"downloadVisualization\">\n          <el-icon><PictureIcon /></el-icon>\n          下载高清可视化图\n        </el-button>\n        <el-button @click=\"downloadReport\">\n          <el-icon><Document /></el-icon>\n          下载聚类报告\n        </el-button>\n      </div>\n    </el-card>\n\n    <!-- 聚类可视化对话框 -->\n    <el-dialog\n      v-model=\"showVisualization\"\n      title=\"聚类可视化\"\n      width=\"90%\"\n      :fullscreen=\"true\"\n    >\n      <div class=\"visualization-container\">\n        <canvas ref=\"vizCanvas\" class=\"viz-canvas\"></canvas>\n      </div>\n      <template #footer>\n        <el-button @click=\"showVisualization = false\">关闭</el-button>\n        <el-button type=\"primary\" @click=\"downloadHighResVisualization\">下载高清图</el-button>\n      </template>\n    </el-dialog>\n\n    <!-- 测试结果对话框 -->\n    <el-dialog\n      v-model=\"showTestResult\"\n      title=\"向量聚类测试结果\"\n      width=\"700px\"\n    >\n      <div v-if=\"testResult\" class=\"test-result\">\n        <el-descriptions :column=\"2\" border>\n          <el-descriptions-item label=\"测试状态\">\n            <el-tag :type=\"testResult.success ? 'success' : 'danger'\">\n              {{ testResult.success ? '成功' : '失败' }}\n            </el-tag>\n          </el-descriptions-item>\n          <el-descriptions-item label=\"向量库连接\">\n            <el-tag :type=\"testResult.connected ? 'success' : 'danger'\">\n              {{ testResult.connected ? '正常' : '异常' }}\n            </el-tag>\n          </el-descriptions-item>\n          <el-descriptions-item label=\"集合名称\">{{ testResult.collection_name || '-' }}</el-descriptions-item>\n          <el-descriptions-item label=\"向量维度\">{{ testResult.dimension || '-' }}</el-descriptions-item>\n          <el-descriptions-item label=\"库中论文数\">{{ testResult.total_papers || 0 }}</el-descriptions-item>\n          <el-descriptions-item label=\"可聚类论文数\">{{ testResult.available_papers || 0 }}</el-descriptions-item>\n        </el-descriptions>\n        \n        <div v-if=\"testResult.test_cluster\" class=\"test-cluster-result\" style=\"margin-top: 20px;\">\n          <h4>测试聚类结果</h4>\n          <el-descriptions :column=\"1\" border>\n            <el-descriptions-item label=\"聚类数量\">{{ testResult.test_cluster.n_clusters }}</el-descriptions-item>\n            <el-descriptions-item label=\"论文总数\">{{ testResult.test_cluster.total_papers }}</el-descriptions-item>\n            <el-descriptions-item label=\"聚类方法\">{{ testResult.test_cluster.method }}</el-descriptions-item>\n          </el-descriptions>\n          \n          <div v-if=\"testResult.test_cluster.cluster_analysis\" class=\"cluster-preview\" style=\"margin-top: 16px;\">\n            <h4>聚类预览</h4>\n            <el-collapse>\n              <el-collapse-item\n                v-for=\"(cluster, key) in testResult.test_cluster.cluster_analysis\"\n                :key=\"key\"\n                :title=\"`聚类 ${parseInt(key) + 1} (${cluster.paper_count} 篇)`\"\n              >\n                <p><strong>论文列表:</strong></p>\n                <ul class=\"preview-paper-list\">\n                  <li v-for=\"(paper, idx) in cluster.papers.slice(0, 5)\" :key=\"idx\">{{ paper }}</li>\n                  <li v-if=\"cluster.papers.length > 5\">... 还有 {{ cluster.papers.length - 5 }} 篇</li>\n                </ul>\n              </el-collapse-item>\n            </el-collapse>\n          </div>\n        </div>\n        \n        <el-alert\n          v-if=\"testResult.error\"\n          :title=\"testResult.error\"\n          type=\"error\"\n          style=\"margin-top: 16px;\"\n          show-icon\n        />\n        \n        <el-alert\n          v-if=\"testResult.message\"\n          :title=\"testResult.message\"\n          type=\"info\"\n          style=\"margin-top: 16px;\"\n          show-icon\n        />\n      </div>\n      <template #footer>\n        <el-button @click=\"showTestResult = false\">关闭</el-button>\n      </template>\n    </el-dialog>\n  </div>\n</template>\n\n<script>\nimport { ref, computed, onMounted } from 'vue'\nimport { useStore } from 'vuex'\nimport api, { connectSocket } from '@/api'\nimport { ElMessage } from 'element-plus'\nimport { DataAnalysis, Refresh, Star, Picture as PictureIcon, Document, Upload, Connection, Odometer } from '@element-plus/icons-vue'\n\nexport default {\n  name: 'Cluster',\n  components: {\n    DataAnalysis,\n    Refresh,\n    Star,\n    PictureIcon,\n    Document,\n    Upload,\n    Connection,\n    Odometer\n  },\n  setup() {\n    const store = useStore()\n\n    const files = computed(() => store.state.files)\n    const selectedFiles = ref([])\n    const loading = ref(false)\n    const options = ref({\n      nClusters: 5,\n      method: 'kmeans',\n      language: 'chinese'\n    })\n    const clustering = ref(false)\n    const result = ref(null)\n    const activeClusters = ref(['0', '1', '2'])\n    const showVisualization = ref(false)\n    const vizCanvas = ref(null)\n\n    // 向量聚相关\n    const clusterMode = ref('traditional')\n    const vectorOptions = ref({\n      nClusters: 5\n    })\n    const vectorClustering = ref(false)\n    const syncing = ref(false)\n    const vectorStats = ref({\n      total_papers: 0,\n      dimension: 0,\n      connected: false,\n      collection_name: ''\n    })\n    const paperTable = ref(null)\n    const syncedPaperIds = ref(new Set())\n\n    // 测试相关\n    const testingConnection = ref(false)\n    const testingCluster = ref(false)\n    const showTestResult = ref(false)\n    const testResult = ref(null)\n\n    // 当前聚类结果ID\n    const currentResultId = ref(null)\n\n    // 聚类历史记录\n    const clusterHistory = ref([])\n\n    // 从localStorage加载历史记录\n    const loadHistory = () => {\n      try {\n        const saved = localStorage.getItem('cluster_history')\n        if (saved) {\n          clusterHistory.value = JSON.parse(saved)\n        }\n      } catch (e) {\n        console.error('加载历史记录失败:', e)\n      }\n    }\n\n    // 保存历史记录到localStorage\n    const saveHistory = () => {\n      try {\n        localStorage.setItem('cluster_history', JSON.stringify(clusterHistory.value))\n      } catch (e) {\n        console.error('保存历史记录失败:', e)\n      }\n    }\n\n    // 格式化日期\n    const formatDate = (dateStr) => {\n      if (!dateStr) return ''\n      const date = new Date(dateStr)\n      return date.toLocaleString('zh-CN')\n    }\n\n    // 加载历史结果\n    const loadHistoryResult = (historyItem) => {\n      result.value = historyItem.data\n      currentResultId.value = null // 历史结果不需要再保存\n      activeClusters.value = Object.keys(historyItem.data.clusterAnalysis).slice(0, 3)\n      ElMessage.success('已加载历史聚类结果')\n    }\n\n    // 删除历史结果\n    const deleteHistoryResult = (index) => {\n      clusterHistory.value.splice(index, 1)\n      saveHistory()\n      ElMessage.success('已删除')\n    }\n\n    // 清空历史\n    const clearHistory = () => {\n      clusterHistory.value = []\n      saveHistory()\n      ElMessage.success('历史记录已清空')\n    }\n\n    // 保存当前结果\n    const saveCurrentResult = () => {\n      if (!result.value) return\n\n      const historyItem = {\n        id: Date.now().toString(),\n        createdAt: new Date().toISOString(),\n        clusterCount: result.value.clusterCount,\n        method: result.value.method,\n        paperCount: result.value.papers?.length || 0,\n        data: result.value\n      }\n\n      clusterHistory.value.unshift(historyItem)\n      saveHistory()\n      currentResultId.value = null // 已保存，不需要再显示保存按钮\n      ElMessage.success('聚类结果已保存到历史记录')\n    }\n\n    // 检查论文是否在向量库中\n    const isPaperInVectorStore = (paperId) => {\n      return syncedPaperIds.value.has(paperId)\n    }\n\n    // 向量聚类方法\n    const loadVectorStats = async () => {\n      try {\n        const response = await api.getVectorStoreStats()\n        if (response.success) {\n          vectorStats.value = response.data\n        }\n      } catch (error) {\n        console.error('加载向量统计失败:', error)\n      }\n    }\n\n    // 测试向量连接\n    const testVectorConnection = async () => {\n      testingConnection.value = true\n      try {\n        const response = await api.getVectorStoreStats()\n        if (response.success) {\n          vectorStats.value = response.data\n          ElMessage.success(`向量库连接正常，包含 ${response.data.total_papers} 篇论文`)\n        } else {\n          ElMessage.error('向量库连接失败: ' + (response.error || '未知错误'))\n        }\n      } catch (error) {\n        console.error('测试连接失败:', error)\n        ElMessage.error('向量库连接测试失败: ' + (error.message || '请检查Milvus服务'))\n      } finally {\n        testingConnection.value = false\n      }\n    }\n\n    // 测试向量聚类\n    const testVectorCluster = async () => {\n      testingCluster.value = true\n      testResult.value = null\n      \n      try {\n        // 1. 首先检查向量库状态\n        const statsResponse = await api.getVectorStoreStats()\n        \n        if (!statsResponse.success) {\n          testResult.value = {\n            success: false,\n            connected: false,\n            error: '无法连接到向量库: ' + (statsResponse.error || '未知错误')\n          }\n          showTestResult.value = true\n          return\n        }\n        \n        const stats = statsResponse.data\n        \n        if (stats.total_papers < 2) {\n          testResult.value = {\n            success: false,\n            connected: true,\n            collection_name: stats.collection_name,\n            dimension: stats.dimension,\n            total_papers: stats.total_papers,\n            error: '向量库中论文数量不足，无法进行聚类测试。请先同步论文到向量库。'\n          }\n          showTestResult.value = true\n          return\n        }\n        \n        // 2. 尝试进行聚类测试\n        const testClusterCount = Math.min(3, stats.total_papers)\n        \n        ElMessage.info(`正在进行聚类测试，使用 ${stats.total_papers} 篇论文...`)\n        \n        const clusterResponse = await api.clusterPapersVector(testClusterCount)\n        \n        if (clusterResponse.success) {\n          testResult.value = {\n            success: true,\n            connected: true,\n            collection_name: stats.collection_name,\n            dimension: stats.dimension,\n            total_papers: stats.total_papers,\n            available_papers: clusterResponse.data.total_papers || stats.total_papers,\n            test_cluster: clusterResponse.data,\n            message: '向量聚类测试成功！向量库工作正常。'\n          }\n          ElMessage.success('向量聚类测试成功')\n        } else {\n          testResult.value = {\n            success: false,\n            connected: true,\n            collection_name: stats.collection_name,\n            dimension: stats.dimension,\n            total_papers: stats.total_papers,\n            error: '聚类测试失败: ' + (clusterResponse.error || '未知错误')\n          }\n        }\n      } catch (error) {\n        console.error('聚类测试失败:', error)\n        testResult.value = {\n          success: false,\n          connected: false,\n          error: '聚类测试异常: ' + (error.message || '请检查Milvus服务是否正常运行')\n        }\n      } finally {\n        testingCluster.value = false\n        showTestResult.value = true\n      }\n    }\n\n    const syncToVectorStore = async () => {\n      if (selectedFiles.value.length === 0) {\n        ElMessage.warning('请先选择要同步的论文')\n        return\n      }\n\n      syncing.value = true\n      try {\n        const paperIds = selectedFiles.value.map(f => f.id)\n        const response = await api.syncPapersToVectorStore(paperIds)\n        \n        if (response.success) {\n          ElMessage.success(`同步完成: ${response.data.synced} 成功, ${response.data.failed} 失败`)\n          // 更新已同步论文集合\n          paperIds.forEach(id => syncedPaperIds.value.add(id))\n          await loadVectorStats()\n        } else {\n          ElMessage.error(response.error || '同步失败')\n        }\n      } catch (error) {\n        console.error('同步失败:', error)\n        ElMessage.error('同步到向量库失败')\n      } finally {\n        syncing.value = false\n      }\n    }\n\n    const startVectorCluster = async () => {\n      if (selectedFiles.value.length < 2) {\n        ElMessage.warning('请至少选择2篇论文')\n        return\n      }\n\n      vectorClustering.value = true\n      \n      try {\n        const paperIds = selectedFiles.value.map(f => f.id)\n        \n        const response = await api.clusterPapersVector(\n          vectorOptions.value.nClusters,\n          paperIds\n        )\n        \n        if (response.success) {\n          result.value = {\n            clusterCount: response.data.n_clusters,\n            clusterAnalysis: response.data.cluster_analysis,\n            papers: [],\n            method: 'kmeans_vector',\n            createdAt: new Date().toISOString(),\n            inertia: response.data.inertia\n          }\n\n          currentResultId.value = Date.now().toString()\n          \n          ElMessage.success(`向量聚类完成! 共发现 ${response.data.n_clusters} 个主题类别`)\n          \n          const clusterIds = Object.keys(response.data.cluster_analysis)\n          activeClusters.value = clusterIds.slice(0, 3)\n          \n          saveCurrentResult()\n        } else {\n          ElMessage.error(response.error || '向量聚类失败')\n        }\n      } catch (error) {\n        console.error('[ERROR] 向量聚类错误:', error)\n        ElMessage.error('向量聚类失败: ' + (error.response?.data?.error || error.message))\n      } finally {\n        vectorClustering.value = false\n      }\n    }\n\n    const handleSelectionChange = (selection) => {\n      selectedFiles.value = selection\n    }\n\n    const refreshFiles = async () => {\n      loading.value = true\n      try {\n        await store.dispatch('fetchFiles')\n        ElMessage.success('论文列表已刷新')\n      } catch (error) {\n        console.error('刷新失败:', error)\n        ElMessage.error('刷新失败')\n      } finally {\n        loading.value = false\n      }\n    }\n\n    const startCluster = async () => {\n      if (selectedFiles.value.length < 2) {\n        ElMessage.warning('请至少选择2篇论文')\n        return\n      }\n\n      // 验证聚类数量\n      const maxClusters = Math.min(20, selectedFiles.value.length)\n      if (options.value.method !== 'dbscan' && (options.value.nClusters < 2 || options.value.nClusters > maxClusters)) {\n        ElMessage.warning(`聚类数量必须在 2 到 ${maxClusters} 之间`)\n        return\n      }\n\n      // 连接WebSocket\n      connectSocket()\n      store.commit('SHOW_PROGRESS_DIALOG', true)\n      store.commit('SET_PROGRESS', { progress: 0, message: '开始聚类分析...', step: '' })\n\n      clustering.value = true\n\n      try {\n        // 使用论文ID而不是文件路径\n        const paperIds = selectedFiles.value.map(f => f.id)\n\n        console.log('[DEBUG] 开始聚类, paper_ids:', paperIds)\n        console.log('[DEBUG] 聚类选项:', options.value)\n\n        const response = await api.clusterPapers(\n          paperIds,\n          options.value.nClusters,\n          options.value.method,\n          options.value.language\n        )\n\n        console.log('[DEBUG] 聚类响应:', response)\n\n        if (response.success) {\n          // 格式化结果\n          result.value = {\n            clusterCount: response.data.n_clusters,\n            clusterAnalysis: response.data.cluster_analysis,\n            papers: response.data.papers || [],\n            method: options.value.method,\n            createdAt: new Date().toISOString()\n          }\n\n          // 生成新的结果ID\n          currentResultId.value = Date.now().toString()\n\n          store.commit('SET_PROGRESS', { progress: 100, message: '聚类完成!' })\n          ElMessage.success(`聚类分析完成! 共发现 ${response.data.n_clusters} 个主题类别`)\n\n          // 自动展开前3个聚类\n          const clusterIds = Object.keys(response.data.cluster_analysis)\n          activeClusters.value = clusterIds.slice(0, 3)\n\n          // 自动保存到历史记录\n          saveCurrentResult()\n        } else {\n          ElMessage.error({\n            message: response.error || '聚类失败',\n            duration: 5000,\n            showClose: true\n          })\n        }\n      } catch (error) {\n        console.error('[ERROR] 聚类错误:', error)\n\n        // 提供更详细的错误提示\n        let errorMsg = '聚类失败'\n        const errorDetail = error.response?.data?.error || error.message\n\n        if (errorDetail) {\n          if (errorDetail.includes('论文') || errorDetail.includes('PDF')) {\n            errorMsg = '论文加载或解析失败，请检查文件是否完整'\n          } else if (errorDetail.includes('聚类') || errorDetail.includes('算法')) {\n            errorMsg = '聚类算法执行失败，请尝试调整参数'\n          } else if (errorDetail.includes('数量') || errorDetail.includes('不足')) {\n            errorMsg = '可用论文数量不足，无法进行聚类'\n          } else if (errorDetail.includes('timeout') || errorDetail.includes('超时')) {\n            errorMsg = '聚类超时，请减少论文数量或降低聚类数量'\n          } else {\n            errorMsg = `聚类失败: ${errorDetail}`\n          }\n        } else if (error.message) {\n          errorMsg = `聚类失败: ${error.message}`\n        }\n\n        ElMessage.error({\n          message: errorMsg,\n          duration: 5000,\n          showClose: true\n        })\n      } finally {\n        clustering.value = false\n        store.commit('SHOW_PROGRESS_DIALOG', false)\n      }\n    }\n\n    const downloadVisualization = () => {\n      showVisualization.value = true\n      // 在对话框打开后绘制可视化\n      setTimeout(() => {\n        drawVisualization()\n      }, 100)\n    }\n\n    const drawVisualization = () => {\n      const canvas = vizCanvas.value\n      if (!canvas) return\n\n      // 设置高分辨率画布\n      const dpr = window.devicePixelRatio || 1\n      const width = window.innerWidth * 0.85\n      const height = window.innerHeight * 0.75\n\n      canvas.width = width * dpr\n      canvas.height = height * dpr\n      canvas.style.width = width + 'px'\n      canvas.style.height = height + 'px'\n\n      const ctx = canvas.getContext('2d')\n      ctx.scale(dpr, dpr)\n\n      // 背景\n      ctx.fillStyle = '#f8f9fa'\n      ctx.fillRect(0, 0, width, height)\n\n      // 标题\n      ctx.fillStyle = '#333'\n      ctx.font = 'bold 28px Arial'\n      ctx.textAlign = 'center'\n      ctx.fillText('论文主题聚类可视化', width / 2, 50)\n\n      if (!result.value || !result.value.clusterAnalysis) {\n        return\n      }\n\n      // 绘制聚类圆形图\n      const clusters = Object.entries(result.value.clusterAnalysis)\n      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#6C5CE7']\n\n      const centerX = width / 2\n      const centerY = height / 2 + 30\n      const maxRadius = Math.min(width, height) * 0.35\n\n      // 计算总论文数\n      const totalPapers = clusters.reduce((sum, [, info]) => sum + (info.paper_count || 0), 0)\n\n      // 绘制聚类圆圈\n      let currentAngle = 0\n      clusters.forEach(([clusterId, info], index) => {\n        const color = colors[index % colors.length]\n        const ratio = (info.paper_count || 0) / Math.max(totalPapers, 1)\n        const angle = ratio * Math.PI * 2\n\n        // 绘制扇形\n        ctx.beginPath()\n        ctx.moveTo(centerX, centerY)\n        ctx.arc(centerX, centerY, maxRadius, currentAngle, currentAngle + angle)\n        ctx.closePath()\n        ctx.fillStyle = color + '40' // 添加透明度\n        ctx.fill()\n        ctx.strokeStyle = color\n        ctx.lineWidth = 3\n        ctx.stroke()\n\n        // 绘制标签\n        const labelAngle = currentAngle + angle / 2\n        const labelRadius = maxRadius + 40\n        const labelX = centerX + Math.cos(labelAngle) * labelRadius\n        const labelY = centerY + Math.sin(labelAngle) * labelRadius\n\n        ctx.fillStyle = color\n        ctx.font = 'bold 16px Arial'\n        ctx.textAlign = 'center'\n        ctx.fillText(`聚类 ${parseInt(clusterId) + 1}`, labelX, labelY - 10)\n        ctx.font = '14px Arial'\n        ctx.fillStyle = '#666'\n        ctx.fillText(`${info.paper_count || 0}篇`, labelX, labelY + 10)\n\n        currentAngle += angle\n      })\n\n      // 中心圆\n      ctx.beginPath()\n      ctx.arc(centerX, centerY, maxRadius * 0.3, 0, Math.PI * 2)\n      ctx.fillStyle = 'white'\n      ctx.fill()\n      ctx.strokeStyle = '#ddd'\n      ctx.lineWidth = 2\n      ctx.stroke()\n\n      // 中心文字\n      ctx.fillStyle = '#333'\n      ctx.font = 'bold 20px Arial'\n      ctx.textAlign = 'center'\n      ctx.fillText(`${clusters.length}`, centerX, centerY - 5)\n      ctx.font = '14px Arial'\n      ctx.fillStyle = '#666'\n      ctx.fillText('个聚类', centerX, centerY + 15)\n\n      // 绘制图例\n      let legendY = height - 100\n      const legendX = width / 2 - (clusters.length * 150) / 2\n\n      clusters.forEach(([clusterId, info], index) => {\n        const color = colors[index % colors.length]\n        const x = legendX + (index % 5) * 150\n        const y = legendY + Math.floor(index / 5) * 40\n\n        ctx.fillStyle = color\n        ctx.fillRect(x, y, 20, 20)\n        ctx.fillStyle = '#333'\n        ctx.font = '12px Arial'\n        ctx.textAlign = 'left'\n        const keywords = info.top_keywords?.slice(0, 2).join(', ') || '无关键词'\n        ctx.fillText(`聚类${parseInt(clusterId) + 1}: ${keywords}`, x + 30, y + 15)\n      })\n    }\n\n    const downloadHighResVisualization = () => {\n      const canvas = vizCanvas.value\n      if (!canvas) return\n\n      // 创建高分辨率下载\n      const link = document.createElement('a')\n      link.download = `cluster_visualization_${Date.now()}_highres.png`\n      link.href = canvas.toDataURL('image/png', 1.0)\n      link.click()\n      ElMessage.success('高清可视化图下载成功')\n    }\n\n    const downloadReport = async () => {\n      if (!result.value) {\n        ElMessage.warning('没有可导出的聚类结果')\n        return\n      }\n\n      try {\n        // 生成报告内容\n        let content = '论文主题聚类分析报告\\n'\n        content += '=' .repeat(80) + '\\n\\n'\n        content += `生成时间: ${formatDate(result.value.createdAt)}\\n`\n        content += `聚类方法: ${result.value.method || 'K-Means'}\\n`\n        content += `聚类数量: ${result.value.clusterCount}\\n`\n        content += `论文总数: ${result.value.papers?.length || 0}\\n\\n`\n\n        // 每个聚类的详细信息\n        Object.entries(result.value.clusterAnalysis).forEach(([clusterId, info], index) => {\n          content += `\\n${'=' .repeat(80)}\\n`\n          content += `聚类 ${parseInt(clusterId) + 1}\\n`\n          content += `${'-' .repeat(40)}\\n`\n          content += `论文数: ${info.paper_count || 0}\\n`\n          content += `关键词: ${info.top_keywords?.join(', ') || '无'}\\n\\n`\n\n          if (info.papers && info.papers.length > 0) {\n            content += '包含论文:\\n'\n            info.papers.forEach((paper, i) => {\n              content += `  ${i + 1}. ${paper}\\n`\n            })\n          }\n\n          if (info.representative_papers && info.representative_papers.length > 0) {\n            content += '\\n代表性论文:\\n'\n            info.representative_papers.forEach((paper, i) => {\n              content += `  ${i + 1}. ${paper.title || '无标题'}\\n`\n              if (paper.abstract) {\n                content += `     摘要: ${paper.abstract}\\n`\n              }\n            })\n          }\n        })\n\n        content += `\\n${'=' .repeat(80)}\\n`\n        content += '报告结束\\n'\n\n        // 下载文件\n        const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' })\n        const url = URL.createObjectURL(blob)\n        const a = document.createElement('a')\n        a.href = url\n        a.download = `cluster_report_${Date.now()}.md`\n        a.click()\n        URL.revokeObjectURL(url)\n\n        ElMessage.success('聚类报告下载成功')\n      } catch (error) {\n        console.error('[ERROR] 导出报告失败:', error)\n        ElMessage.error('导出报告失败')\n      }\n    }\n\n    onMounted(() => {\n      store.dispatch('fetchFiles')\n      loadHistory()\n      loadVectorStats()\n    })\n\n    return {\n      files,\n      selectedFiles,\n      loading,\n      options,\n      clustering,\n      result,\n      activeClusters,\n      currentResultId,\n      clusterHistory,\n      showVisualization,\n      vizCanvas,\n      clusterMode,\n      vectorOptions,\n      vectorClustering,\n      syncing,\n      vectorStats,\n      testingConnection,\n      testingCluster,\n      showTestResult,\n      testResult,\n      paperTable,\n      handleSelectionChange,\n      refreshFiles,\n      formatDate,\n      startCluster,\n      downloadVisualization,\n      drawVisualization,\n      downloadHighResVisualization,\n      downloadReport,\n      saveCurrentResult,\n      loadHistoryResult,\n      deleteHistoryResult,\n      clearHistory,\n      syncToVectorStore,\n      startVectorCluster,\n      testVectorConnection,\n      testVectorCluster,\n      isPaperInVectorStore\n    }\n  }\n}\n</script>\n\n<style scoped>\n.cluster {\n  max-width: 1200px;\n  margin: 0 auto;\n}\n\nh2 {\n  margin-bottom: 20px;\n  color: #303133;\n}\n\n.select-card,\n.options-card,\n.result-card,\n.history-card {\n  margin-bottom: 20px;\n}\n\n.select-header,\n.history-header,\n.result-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 10px;\n}\n\n.select-header h3,\n.history-header h3,\n.result-header h3 {\n  margin: 0;\n}\n\n.header-actions {\n  display: flex;\n  gap: 10px;\n}\n\n.result-actions-top {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n}\n\n.cluster-title {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n}\n\n.cluster-name {\n  font-weight: 600;\n}\n\n.cluster-content h4 {\n  color: #409eff;\n  margin: 20px 0 10px 0;\n}\n\n.paper-list {\n  list-style: none;\n  padding: 0;\n  margin: 0;\n}\n\n.paper-list li {\n  padding: 8px 0;\n  padding-left: 20px;\n  position: relative;\n  border-bottom: 1px solid #eee;\n}\n\n.paper-list li:before {\n  content: '•';\n  position: absolute;\n  left: 0;\n  color: #409eff;\n  font-weight: bold;\n}\n\n.preview-paper-list {\n  list-style: none;\n  padding: 0;\n  margin: 0;\n}\n\n.preview-paper-list li {\n  padding: 4px 0;\n  padding-left: 16px;\n  position: relative;\n  font-size: 13px;\n}\n\n.preview-paper-list li:before {\n  content: '•';\n  position: absolute;\n  left: 0;\n  color: #409eff;\n}\n\n.rep-paper {\n  padding: 15px;\n  background: #f5f7fa;\n  border-radius: 4px;\n  margin-bottom: 10px;\n}\n\n.rep-paper p {\n  margin: 5px 0;\n}\n\n.rep-abstract {\n  color: #606266;\n  font-size: 14px;\n  line-height: 1.6;\n}\n\n.result-actions {\n  margin-top: 20px;\n  display: flex;\n  gap: 10px;\n  justify-content: flex-end;\n}\n\n.visualization-container {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 500px;\n  background: #f8f9fa;\n  border-radius: 8px;\n}\n\n.viz-canvas {\n  max-width: 100%;\n  max-height: 80vh;\n}\n\n/* 向量聚类样式 */\n.vector-cluster-info {\n  margin-bottom: 16px;\n}\n\n.vector-actions {\n  display: flex;\n  gap: 12px;\n  margin-top: 16px;\n  flex-wrap: wrap;\n}\n\n.vector-stats {\n  margin-top: 16px;\n}\n\n/* 测试结果样式 */\n.test-result h4 {\n  color: #409eff;\n  margin: 16px 0 8px 0;\n}\n\n.test-cluster-result {\n  background: #f5f7fa;\n  padding: 16px;\n  border-radius: 8px;\n}\n\n/* 表格样式优化 */\n:deep(.el-table) {\n  font-size: 14px;\n}\n\n:deep(.el-tag) {\n  font-size: 12px;\n}\n</style>\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}